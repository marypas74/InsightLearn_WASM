# HTTP Server - Redirect to HTTPS
server {
    listen 80;
    server_name localhost wasm.insightlearn.cloud;

    # Allow direct HTTP access (for compatibility)
    root /usr/share/nginx/html;
    index index.html;

    # Enable gzip compression for WASM files
    gzip on;
    gzip_types application/wasm application/javascript text/css text/html;
    gzip_min_length 1024;

    # MIME types for Blazor WASM
    types {
        application/wasm wasm;
        application/octet-stream dll;
        application/json json;
        application/javascript js;
        text/css css;
        text/html html;
    }

    # JavaScript files (MUST be before location / to prevent SPA fallback)
    location ~* \.js$ {
        try_files $uri =404;
        add_header Content-Type application/javascript;
        add_header Cache-Control "public, max-age=3600";
    }

    # DNS resolver for Kubernetes service discovery (using kube-dns IP)
    resolver 10.96.0.10 valid=10s;

    # API Proxy - Forward /api requests to backend API (SOLVES CORS!)
    location /api/ {
        set $api_backend "http://api-service.insightlearn.svc.cluster.local:80";
        proxy_pass $api_backend$request_uri;

        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Serve index.html for all routes (SPA routing)
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Cache static assets (EXCEPT WASM/DLL for development)
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # NO CACHE for WASM/DLL/JS during development
    location ~* \.(wasm|dll|dat|json|js|css)$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Framework files - NO CACHE during development
    location /_framework/ {
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
}

# HTTPS Server
server {
    listen 443 ssl http2;
    server_name localhost wasm.insightlearn.cloud;
    root /usr/share/nginx/html;
    index index.html;

    # SSL Configuration
    ssl_certificate /etc/nginx/certs/tls.crt;
    ssl_certificate_key /etc/nginx/certs/tls.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Enable gzip compression for WASM files
    gzip on;
    gzip_types application/wasm application/javascript text/css text/html;
    gzip_min_length 1024;

    # MIME types for Blazor WASM
    types {
        application/wasm wasm;
        application/octet-stream dll;
        application/json json;
        application/javascript js;
        text/css css;
        text/html html;
    }

    # JavaScript files (MUST be before location / to prevent SPA fallback)
    location ~* \.js$ {
        try_files $uri =404;
        add_header Content-Type application/javascript;
        add_header Cache-Control "public, max-age=3600";
    }

    # DNS resolver for Kubernetes service discovery (using kube-dns IP)
    resolver 10.96.0.10 valid=10s;

    # API Proxy - Forward /api requests to backend API (SOLVES CORS!)
    # Browser sees same origin, nginx forwards to actual API
    location /api/ {
        # Use variable to force DNS resolution at request time (not at startup)
        set $api_backend "http://api-service.insightlearn.svc.cluster.local:80";

        # Pass the full request URI (includes /api/...)
        proxy_pass $api_backend$request_uri;

        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $server_name;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;

        # No caching for API calls
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Serve index.html for all routes (SPA routing)
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Cache static assets (EXCEPT WASM/DLL for development)
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # NO CACHE for WASM/DLL/JS during development
    location ~* \.(wasm|dll|dat|json|js|css)$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Framework files - NO CACHE during development
    location /_framework/ {
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
}
