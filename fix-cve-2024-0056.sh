#!/bin/bash
################################################################################
# CVE-2024-0056 Remediation Script
#
# Purpose: Automatically update vulnerable SqlClient packages in test project
# CVE: CVE-2024-0056 (SQL Data Provider Security Feature Bypass)
# Severity: HIGH
# Affected: tests/InsightLearn.Tests.csproj
#
# Author: InsightLearn Test Engineer
# Date: 2025-11-09
################################################################################

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
TEST_PROJECT="tests/InsightLearn.Tests.csproj"
SYSTEM_DATA_SQLCLIENT_VERSION="4.8.6"  # Fixed version
MICROSOFT_DATA_SQLCLIENT_VERSION="5.1.5"  # Fixed version (aligned with production)

echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}CVE-2024-0056 Remediation Script${NC}"
echo -e "${BLUE}=========================================${NC}"
echo ""

# Check if running in correct directory
if [[ ! -f "$TEST_PROJECT" ]]; then
    echo -e "${RED}ERROR: $TEST_PROJECT not found${NC}"
    echo "Please run this script from the repository root directory"
    exit 1
fi

# Step 1: Show current vulnerable versions
echo -e "${YELLOW}[1/5] Current package versions:${NC}"
echo ""
grep -A 0 "SqlClient" "$TEST_PROJECT" || true
echo ""

# Step 2: Backup test project file
echo -e "${YELLOW}[2/5] Creating backup of $TEST_PROJECT...${NC}"
cp "$TEST_PROJECT" "${TEST_PROJECT}.backup.$(date +%Y%m%d-%H%M%S)"
echo -e "${GREEN}✓ Backup created${NC}"
echo ""

# Step 3: Update System.Data.SqlClient
echo -e "${YELLOW}[3/5] Updating System.Data.SqlClient to ${SYSTEM_DATA_SQLCLIENT_VERSION}...${NC}"
cd tests
if dotnet add package System.Data.SqlClient --version "$SYSTEM_DATA_SQLCLIENT_VERSION" 2>&1; then
    echo -e "${GREEN}✓ System.Data.SqlClient updated successfully${NC}"
else
    echo -e "${RED}✗ Failed to update System.Data.SqlClient${NC}"
    exit 1
fi
cd ..
echo ""

# Step 4: Update Microsoft.Data.SqlClient
echo -e "${YELLOW}[4/5] Updating Microsoft.Data.SqlClient to ${MICROSOFT_DATA_SQLCLIENT_VERSION}...${NC}"
cd tests
if dotnet add package Microsoft.Data.SqlClient --version "$MICROSOFT_DATA_SQLCLIENT_VERSION" 2>&1; then
    echo -e "${GREEN}✓ Microsoft.Data.SqlClient updated successfully${NC}"
else
    echo -e "${RED}✗ Failed to update Microsoft.Data.SqlClient${NC}"
    exit 1
fi
cd ..
echo ""

# Step 5: Restore and verify
echo -e "${YELLOW}[5/5] Restoring dependencies and verifying fix...${NC}"
if dotnet restore tests/InsightLearn.Tests.csproj 2>&1; then
    echo -e "${GREEN}✓ Dependencies restored successfully${NC}"
else
    echo -e "${RED}✗ Failed to restore dependencies${NC}"
    exit 1
fi
echo ""

# Check for vulnerabilities
echo -e "${BLUE}Vulnerability scan results:${NC}"
echo ""
dotnet list package --vulnerable --include-transitive 2>&1 || true
echo ""

# Show updated versions
echo -e "${BLUE}Updated package versions:${NC}"
echo ""
grep -A 0 "SqlClient" "$TEST_PROJECT"
echo ""

# Summary
echo -e "${BLUE}=========================================${NC}"
echo -e "${GREEN}✓ CVE-2024-0056 Remediation Complete${NC}"
echo -e "${BLUE}=========================================${NC}"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "1. Run tests to verify compatibility:"
echo "   ${BLUE}dotnet test tests/InsightLearn.Tests.csproj${NC}"
echo ""
echo "2. Commit changes:"
echo "   ${BLUE}git add tests/InsightLearn.Tests.csproj${NC}"
echo "   ${BLUE}git commit -m \"security: Fix CVE-2024-0056 - Update SqlClient to patched versions\"${NC}"
echo "   ${BLUE}git push origin main${NC}"
echo ""
echo "3. GitHub Dependabot alerts will auto-close after push"
echo ""
echo -e "${GREEN}Report: SECURITY-ADVISORY-CVE-2024-0056.md${NC}"
echo ""

exit 0
