@inject IJSRuntime JSRuntime
@inject IToastService Toast

<div class="video-upload-component">
    <div class="upload-area @(isDragging ? "dragging" : "")"
         @ondrop="HandleDrop"
         @ondragover="HandleDragOver"
         @ondragleave="HandleDragLeave">

        <InputFile OnChange="HandleFileSelected" accept="video/*" class="file-input" id="@inputId" />

        @if (isUploading)
        {
            <div class="upload-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: @uploadProgress%"></div>
                </div>
                <span class="progress-text">@uploadProgress% uploaded</span>
            </div>
        }
        else if (!string.IsNullOrEmpty(uploadedVideoUrl))
        {
            <div class="upload-success">
                <i class="fas fa-check-circle"></i>
                <span>Video uploaded successfully!</span>
            </div>
        }
        else
        {
            <label for="@inputId" class="upload-label">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Drop video file here or click to browse</span>
                <small>Supported formats: MP4, AVI, MOV (Max 500MB)</small>
            </label>
        }
    </div>
</div>

@code {
    private string inputId = Guid.NewGuid().ToString();
    private bool isDragging = false;
    private bool isUploading = false;
    private int uploadProgress = 0;
    private string uploadedVideoUrl = "";

    [Parameter] public EventCallback<string> OnUploadComplete { get; set; }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        if (file.Size > 500 * 1024 * 1024) // 500MB
        {
            Toast.ShowError("File size exceeds 500MB limit");
            return;
        }

        await UploadFile(file);
    }

    private async Task UploadFile(IBrowserFile file)
    {
        try
        {
            isUploading = true;
            uploadProgress = 0;

            // Simulate upload progress
            for (int i = 0; i <= 100; i += 10)
            {
                uploadProgress = i;
                await Task.Delay(200);
                StateHasChanged();
            }

            // TODO: Implement actual upload to API
            uploadedVideoUrl = $"/videos/{Guid.NewGuid()}.mp4";

            Toast.ShowSuccess("Video uploaded successfully!");
            await OnUploadComplete.InvokeAsync(uploadedVideoUrl);
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Upload failed: {ex.Message}");
        }
        finally
        {
            isUploading = false;
        }
    }

    private void HandleDragOver() => isDragging = true;
    private void HandleDragLeave() => isDragging = false;
    private void HandleDrop() => isDragging = false;
}
