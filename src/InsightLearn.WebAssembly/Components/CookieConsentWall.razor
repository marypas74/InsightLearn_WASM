@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<!-- Full-screen blocking overlay - hidden via CSS if consent exists -->
<div class="cookie-wall-overlay @(showWall ? "" : "hidden")" @onclick:preventDefault="true">
        <div class="cookie-wall-container">
            <!-- Vibrant modal card -->
            <div class="cookie-wall-modal" @onclick:stopPropagation="true">
                <div class="cookie-modal-content">
                    <!-- LEFT: InsightLearn Logo Section -->
                    <div class="ai-avatar-section" aria-label="InsightLearn branding">
                        <div class="ai-avatar-container">
                            <!-- InsightLearn Logo -->
                            <div class="ai-hologram">
                                <div class="logo-container">
                                    <img src="images/insightlearn-logo.png" alt="InsightLearn.cloud Logo" class="insightlearn-logo" style="max-width: 180px; height: auto;" />
                                </div>
                                <div class="ai-particles">
                                    @for (int i = 0; i < 10; i++)
                                    {
                                        <div class="particle" style="left: @(10 + i * 8)%; animation-delay: @(i * 0.8)s;"></div>
                                    }
                                </div>
                                <div class="ai-glow"></div>
                                <div class="ai-scan-line"></div>
                            </div>
                        </div>
                        <h3 class="ai-name">InsightLearn.cloud</h3>
                        <p class="ai-subtitle">Online Learning Platform</p>
                        <div class="ai-message">
                            <p>"Welcome to InsightLearn! We use cookies to personalize your learning experience and improve our platform."</p>
                            <p class="ai-message-secondary">"Your privacy matters! Let us explain how cookies help us serve you better."</p>
                        </div>
                    </div>

                    <!-- RIGHT: Cookie Content Section -->
                    <div class="cookie-content-section">
                        <div class="cookie-wall-header">
                            <div class="cookie-icon-wrapper">
                                <span class="cookie-icon">üç™</span>
                            </div>
                            <h1 class="cookie-wall-title">We value your privacy</h1>
                            <p class="cookie-wall-subtitle">
                                Your privacy matters to us. We use cookies to enhance your experience, analyze site traffic, and personalize content.
                            </p>
                        </div>

                        <div class="cookie-wall-body">
                    @if (!showDetailedSettings)
                    {
                        <!-- Simple consent view -->
                        <div class="cookie-simple-info">
                            <p class="cookie-description">
                                By clicking "Accept All Cookies", you agree to the storing of cookies on your device to enhance site navigation,
                                analyze site usage, and assist in our marketing efforts. We respect your privacy and are committed to protecting your data.
                            </p>

                            <div class="cookie-features-grid">
                                <div class="cookie-feature">
                                    <span class="feature-icon">üîí</span>
                                    <span class="feature-text">Secure & Encrypted</span>
                                </div>
                                <div class="cookie-feature">
                                    <span class="feature-icon">‚ö°</span>
                                    <span class="feature-text">Enhanced Performance</span>
                                </div>
                                <div class="cookie-feature">
                                    <span class="feature-icon">üéØ</span>
                                    <span class="feature-text">Personalized Experience</span>
                                </div>
                                <div class="cookie-feature">
                                    <span class="feature-icon">üìä</span>
                                    <span class="feature-text">Analytics & Insights</span>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Detailed settings view -->
                        <div class="cookie-settings-content">
                            <p class="settings-intro">
                                Customize your cookie preferences below. Essential cookies are required for the site to function and cannot be disabled.
                            </p>

                            <div class="cookie-categories">
                                <!-- Strictly Necessary Cookies -->
                                <div class="cookie-category necessary">
                                    <div class="category-header">
                                        <div class="category-info">
                                            <div class="category-icon">üîí</div>
                                            <div>
                                                <h3 class="category-title">Strictly Necessary Cookies</h3>
                                                <p class="category-description">Essential for the website to function properly</p>
                                            </div>
                                        </div>
                                        <label class="cookie-switch disabled">
                                            <input type="checkbox" checked disabled />
                                            <span class="switch-slider"></span>
                                        </label>
                                    </div>
                                    <div class="category-details">
                                        <p><strong>Purpose:</strong> Authentication, security, session management</p>
                                        <p><strong>Examples:</strong> Login sessions, CSRF protection, load balancing</p>
                                        <p><strong>Duration:</strong> Session or up to 7 days</p>
                                    </div>
                                </div>

                                <!-- Analytics Cookies -->
                                <div class="cookie-category analytics">
                                    <div class="category-header">
                                        <div class="category-info">
                                            <div class="category-icon">üìä</div>
                                            <div>
                                                <h3 class="category-title">Analytics Cookies</h3>
                                                <p class="category-description">Help us understand visitor interactions</p>
                                            </div>
                                        </div>
                                        <label class="cookie-switch">
                                            <input type="checkbox" @bind="analyticsEnabled" />
                                            <span class="switch-slider"></span>
                                        </label>
                                    </div>
                                    <div class="category-details">
                                        <p><strong>Purpose:</strong> Website usage analytics, performance monitoring</p>
                                        <p><strong>Examples:</strong> Google Analytics, page views, user behavior</p>
                                        <p><strong>Duration:</strong> Up to 2 years</p>
                                    </div>
                                </div>

                                <!-- Marketing Cookies -->
                                <div class="cookie-category marketing">
                                    <div class="category-header">
                                        <div class="category-info">
                                            <div class="category-icon">üéØ</div>
                                            <div>
                                                <h3 class="category-title">Marketing Cookies</h3>
                                                <p class="category-description">Track visitors and display relevant ads</p>
                                            </div>
                                        </div>
                                        <label class="cookie-switch">
                                            <input type="checkbox" @bind="marketingEnabled" />
                                            <span class="switch-slider"></span>
                                        </label>
                                    </div>
                                    <div class="category-details">
                                        <p><strong>Purpose:</strong> Personalized advertising, retargeting</p>
                                        <p><strong>Examples:</strong> Facebook Pixel, Google Ads, remarketing</p>
                                        <p><strong>Duration:</strong> Up to 2 years</p>
                                    </div>
                                </div>

                                <!-- Functional Cookies -->
                                <div class="cookie-category functional">
                                    <div class="category-header">
                                        <div class="category-info">
                                            <div class="category-icon">‚öôÔ∏è</div>
                                            <div>
                                                <h3 class="category-title">Functional Cookies</h3>
                                                <p class="category-description">Enable enhanced functionality</p>
                                            </div>
                                        </div>
                                        <label class="cookie-switch">
                                            <input type="checkbox" @bind="functionalEnabled" />
                                            <span class="switch-slider"></span>
                                        </label>
                                    </div>
                                    <div class="category-details">
                                        <p><strong>Purpose:</strong> Remember preferences, chatbot sessions, language settings</p>
                                        <p><strong>Examples:</strong> Chatbot email and session, language preference, theme, region</p>
                                        <p><strong>Duration:</strong> Up to 1 year</p>
                                        <p><strong>GDPR Note:</strong> Chatbot data (email, sessionId) is saved only if you accept functional cookies</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                        </div>

                        <div class="cookie-wall-footer">
                            <div class="cookie-links">
                                <a href="#" @onclick="OpenPrivacyModal" @onclick:preventDefault class="cookie-link">Privacy Policy</a>
                                <span class="link-separator">‚Ä¢</span>
                                <a href="#" @onclick="OpenCookieModal" @onclick:preventDefault class="cookie-link">Cookie Policy</a>
                            </div>

                            <div class="cookie-actions">
                                @if (!showDetailedSettings)
                                {
                                    <button class="btn-cookie-reject" @onclick="RejectAll">
                                        <span class="btn-icon">‚úï</span>
                                        Reject All
                                    </button>
                                    <button class="btn-cookie-settings" @onclick="OpenDetailedSettings">
                                        <span class="btn-icon">‚öôÔ∏è</span>
                                        Cookie Settings
                                    </button>
                                    <button class="btn-cookie-accept" @onclick="AcceptAll">
                                        <span class="btn-icon">‚úì</span>
                                        Accept All Cookies
                                    </button>
                                }
                                else
                                {
                                    <button class="btn-cookie-back" @onclick="BackToSimple">
                                        <span class="btn-icon">‚Üê</span>
                                        Back
                                    </button>
                                    <button class="btn-cookie-save" @onclick="SaveCustomPreferences">
                                        <span class="btn-icon">‚úì</span>
                                        Save My Preferences
                                    </button>
                                    <button class="btn-cookie-accept-all-settings" @onclick="AcceptAllFromSettings">
                                        <span class="btn-icon">‚úì</span>
                                        Accept All
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Privacy Policy Modal -->
<div class="policy-modal-overlay @(showPrivacyModal ? "show" : "")" @onclick="ClosePrivacyModal">
    <div class="policy-modal" @onclick:stopPropagation>
        <div class="policy-modal-header">
            <h2 class="policy-modal-title">Privacy Policy</h2>
            <button class="policy-modal-close" @onclick="ClosePrivacyModal" aria-label="Close">&times;</button>
        </div>
        <div class="policy-modal-body" @ref="privacyModalBody" @onscroll="OnPrivacyScroll">
            <p><strong>Last Updated:</strong> January 2025</p>

            <h2>1. Introduction</h2>
            <p>Welcome to InsightLearn ("we," "our," or "us"). We are committed to protecting your personal information and your right to privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you visit our website and use our services.</p>

            <h2>2. Information We Collect</h2>
            <h3>2.1 Personal Information</h3>
            <p>We collect personal information that you voluntarily provide to us when you:</p>
            <ul>
                <li>Register for an account</li>
                <li>Enroll in courses</li>
                <li>Make purchases</li>
                <li>Contact us for support</li>
                <li>Subscribe to newsletters</li>
            </ul>

            <h3>2.2 Automatically Collected Information</h3>
            <p>When you visit our website, we automatically collect certain information about your device, including:</p>
            <ul>
                <li>IP address</li>
                <li>Browser type and version</li>
                <li>Operating system</li>
                <li>Referral URLs</li>
                <li>Pages viewed and time spent</li>
            </ul>

            <h2>3. How We Use Your Information</h2>
            <p>We use the information we collect to:</p>
            <ul>
                <li>Provide and maintain our services</li>
                <li>Process your transactions</li>
                <li>Send you course materials and updates</li>
                <li>Respond to your inquiries</li>
                <li>Improve our platform</li>
                <li>Detect and prevent fraud</li>
                <li>Comply with legal obligations</li>
            </ul>

            <h2>4. Data Sharing and Disclosure</h2>
            <p>We do not sell your personal information. We may share your information with:</p>
            <ul>
                <li>Course instructors (limited to necessary information)</li>
                <li>Service providers (payment processors, hosting providers)</li>
                <li>Legal authorities when required by law</li>
            </ul>

            <h2>5. Your Rights</h2>
            <p>You have the right to:</p>
            <ul>
                <li>Access your personal data</li>
                <li>Correct inaccurate data</li>
                <li>Request deletion of your data</li>
                <li>Object to data processing</li>
                <li>Data portability</li>
                <li>Withdraw consent</li>
            </ul>

            <h2>6. Data Security</h2>
            <p>We implement appropriate technical and organizational measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.</p>

            <h2>7. Contact Us</h2>
            <p>If you have questions about this Privacy Policy, please contact us at:</p>
            <p>Email: privacy@insightlearn.cloud</p>
        </div>
        <div class="policy-scroll-indicator @(privacyScrolledToBottom ? "hidden" : "")">
            <span class="policy-scroll-icon">‚Üì</span>
            <span>Scroll down to read the full policy</span>
        </div>
        <div class="policy-modal-footer">
            <button class="policy-close-btn" @onclick="ClosePrivacyModal">I Understand</button>
        </div>
    </div>
</div>

<!-- Cookie Policy Modal -->
<div class="policy-modal-overlay @(showCookieModal ? "show" : "")" @onclick="CloseCookieModal">
    <div class="policy-modal" @onclick:stopPropagation>
        <div class="policy-modal-header">
            <h2 class="policy-modal-title">Cookie Policy</h2>
            <button class="policy-modal-close" @onclick="CloseCookieModal" aria-label="Close">&times;</button>
        </div>
        <div class="policy-modal-body" @ref="cookieModalBody" @onscroll="OnCookieScroll">
            <p><strong>Last Updated:</strong> January 2025</p>

            <h2>1. What Are Cookies?</h2>
            <p>Cookies are small text files that are placed on your device when you visit our website. They help us provide you with a better experience by remembering your preferences and understanding how you use our site.</p>

            <h2>2. Types of Cookies We Use</h2>

            <h3>2.1 Strictly Necessary Cookies</h3>
            <p>These cookies are essential for the website to function properly. They enable core functionality such as:</p>
            <ul>
                <li>User authentication</li>
                <li>Security features</li>
                <li>Session management</li>
                <li>Load balancing</li>
            </ul>
            <p><strong>Duration:</strong> Session or up to 7 days</p>

            <h3>2.2 Analytics Cookies</h3>
            <p>We use analytics cookies to understand how visitors interact with our website. This helps us:</p>
            <ul>
                <li>Analyze website traffic</li>
                <li>Understand user behavior</li>
                <li>Improve our services</li>
                <li>Measure campaign effectiveness</li>
            </ul>
            <p><strong>Duration:</strong> Up to 2 years</p>

            <h3>2.3 Marketing Cookies</h3>
            <p>Marketing cookies track your online activity to help us:</p>
            <ul>
                <li>Show you relevant advertisements</li>
                <li>Measure ad campaign performance</li>
                <li>Limit ad frequency</li>
                <li>Personalize content</li>
            </ul>
            <p><strong>Duration:</strong> Up to 2 years</p>

            <h3>2.4 Functional Cookies</h3>
            <p>These cookies enable enhanced functionality and personalization:</p>
            <ul>
                <li>Remember your preferences</li>
                <li>Save language settings</li>
                <li>Customize your experience</li>
            </ul>
            <p><strong>Duration:</strong> Up to 1 year</p>

            <h2>3. Third-Party Cookies</h2>
            <p>We use services from trusted third parties that may set their own cookies:</p>
            <ul>
                <li>Google Analytics</li>
                <li>Facebook Pixel</li>
                <li>Payment processors</li>
            </ul>

            <h2>4. Managing Cookies</h2>
            <p>You can control and manage cookies through:</p>
            <ul>
                <li>Our Cookie Settings tool</li>
                <li>Your browser settings</li>
                <li>Third-party opt-out tools</li>
            </ul>

            <h2>5. Contact Us</h2>
            <p>For questions about our use of cookies, contact us at:</p>
            <p>Email: privacy@insightlearn.cloud</p>
        </div>
        <div class="policy-scroll-indicator @(cookieScrolledToBottom ? "hidden" : "")">
            <span class="policy-scroll-icon">‚Üì</span>
            <span>Scroll down to read the full policy</span>
        </div>
        <div class="policy-modal-footer">
            <button class="policy-close-btn" @onclick="CloseCookieModal">I Understand</button>
        </div>
    </div>
</div>

@code {
    private bool showWall = true; // Show by default, hide if consent exists
    private bool showDetailedSettings = false;
    private bool analyticsEnabled = false;
    private bool marketingEnabled = false;
    private bool functionalEnabled = false;

    // Policy modal state
    private bool showPrivacyModal = false;
    private bool showCookieModal = false;
    private bool privacyScrolledToBottom = false;
    private bool cookieScrolledToBottom = false;

    // Element references for scroll detection
    private ElementReference privacyModalBody;
    private ElementReference cookieModalBody;

    protected override void OnInitialized()
    {
        Console.WriteLine($"[COOKIE-WALL] OnInitialized - Component created, showWall={showWall}");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        Console.WriteLine($"[COOKIE-WALL] OnAfterRenderAsync - firstRender={firstRender}, showWall={showWall}");

        if (firstRender)
        {
            Console.WriteLine("[COOKIE-WALL] First render - calling CheckConsent()");
            await CheckConsent();
            Console.WriteLine($"[COOKIE-WALL] After CheckConsent - showWall={showWall}");
            StateHasChanged();
            Console.WriteLine("[COOKIE-WALL] StateHasChanged called");
        }
    }

    private async Task CheckConsent()
    {
        try
        {
            Console.WriteLine("[COOKIE-WALL] CheckConsent - Calling JS hasValidConsent()");
            var hasConsent = await JSRuntime.InvokeAsync<bool>("cookieConsentWall.hasValidConsent");
            Console.WriteLine($"[COOKIE-WALL] JS returned hasConsent={hasConsent}");

            if (!hasConsent)
            {
                // No valid consent - show blocking wall
                Console.WriteLine("[COOKIE-WALL] No consent - showing wall");
                showWall = true;
                await JSRuntime.InvokeVoidAsync("cookieConsentWall.blockInteraction");
                Console.WriteLine("[COOKIE-WALL] blockInteraction() called");
            }
            else
            {
                // Has valid consent - hide wall
                Console.WriteLine("[COOKIE-WALL] Has consent - hiding wall");
                showWall = false;
                // Load existing preferences
                var preferences = await JSRuntime.InvokeAsync<CookiePreferences>("cookieConsentWall.getPreferences");
                Console.WriteLine($"[COOKIE-WALL] Preferences loaded: Analytics={preferences?.Analytics}, Marketing={preferences?.Marketing}");
                if (preferences != null)
                {
                    analyticsEnabled = preferences.Analytics;
                    marketingEnabled = preferences.Marketing;
                    functionalEnabled = preferences.Functional;
                }
            }
        }
        catch (Exception ex)
        {
            // If error checking consent, show wall to be safe
            Console.WriteLine($"[COOKIE-WALL] ERROR checking consent: {ex.Message}");
            Console.WriteLine($"[COOKIE-WALL] Stack trace: {ex.StackTrace}");
            showWall = true;
        }
    }

    private async Task AcceptAll()
    {
        analyticsEnabled = true;
        marketingEnabled = true;
        functionalEnabled = true;
        await SaveConsent();
    }

    private async Task RejectAll()
    {
        analyticsEnabled = false;
        marketingEnabled = false;
        functionalEnabled = false;
        await SaveConsent();
    }

    private void OpenDetailedSettings()
    {
        showDetailedSettings = true;
    }

    private void BackToSimple()
    {
        showDetailedSettings = false;
    }

    private async Task AcceptAllFromSettings()
    {
        analyticsEnabled = true;
        marketingEnabled = true;
        functionalEnabled = true;
        await SaveConsent();
    }

    private async Task SaveCustomPreferences()
    {
        await SaveConsent();
    }

    private async Task SaveConsent()
    {
        try
        {
            var preferences = new CookiePreferences
            {
                Necessary = true,
                Analytics = analyticsEnabled,
                Marketing = marketingEnabled,
                Functional = functionalEnabled
            };

            await JSRuntime.InvokeVoidAsync("cookieConsentWall.saveConsent", preferences);

            // Hide the wall
            showWall = false;
            showDetailedSettings = false;

            // Apply consent to third-party scripts
            await ApplyConsent();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving cookie consent: {ex.Message}");
        }
    }

    private async Task ApplyConsent()
    {
        try
        {
            // Load Google Analytics if analytics accepted
            if (analyticsEnabled)
            {
                await JSRuntime.InvokeVoidAsync("cookieConsentWall.loadAnalytics");
            }

            // Load marketing scripts if marketing accepted
            if (marketingEnabled)
            {
                await JSRuntime.InvokeVoidAsync("cookieConsentWall.loadMarketing");
            }

            // Apply functional cookies if accepted
            if (functionalEnabled)
            {
                await JSRuntime.InvokeVoidAsync("cookieConsentWall.enableFunctional");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error applying cookie consent: {ex.Message}");
        }
    }

    // Policy modal functions
    private void OpenPrivacyModal()
    {
        showPrivacyModal = true;
        privacyScrolledToBottom = false;
    }

    private void ClosePrivacyModal()
    {
        showPrivacyModal = false;
    }

    private void OpenCookieModal()
    {
        showCookieModal = true;
        cookieScrolledToBottom = false;
    }

    private void CloseCookieModal()
    {
        showCookieModal = false;
    }

    private async Task OnPrivacyScroll()
    {
        try
        {
            var scrollInfo = await JSRuntime.InvokeAsync<ScrollInfo>("eval",
                $@"(function() {{
                    const el = document.querySelector('.policy-modal-body');
                    if (!el) return {{ scrollTop: 0, scrollHeight: 0, clientHeight: 0 }};
                    return {{
                        scrollTop: el.scrollTop,
                        scrollHeight: el.scrollHeight,
                        clientHeight: el.clientHeight
                    }};
                }})()");

            // Check if scrolled to bottom (with 10px tolerance)
            if (scrollInfo.scrollTop + scrollInfo.clientHeight >= scrollInfo.scrollHeight - 10)
            {
                privacyScrolledToBottom = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking scroll: {ex.Message}");
        }
    }

    private async Task OnCookieScroll()
    {
        try
        {
            var scrollInfo = await JSRuntime.InvokeAsync<ScrollInfo>("eval",
                $@"(function() {{
                    const el = document.querySelectorAll('.policy-modal-body')[1];
                    if (!el) return {{ scrollTop: 0, scrollHeight: 0, clientHeight: 0 }};
                    return {{
                        scrollTop: el.scrollTop,
                        scrollHeight: el.scrollHeight,
                        clientHeight: el.clientHeight
                    }};
                }})()");

            // Check if scrolled to bottom (with 10px tolerance)
            if (scrollInfo.scrollTop + scrollInfo.clientHeight >= scrollInfo.scrollHeight - 10)
            {
                cookieScrolledToBottom = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking scroll: {ex.Message}");
        }
    }

    public class ScrollInfo
    {
        public double scrollTop { get; set; }
        public double scrollHeight { get; set; }
        public double clientHeight { get; set; }
    }

    public class CookiePreferences
    {
        public bool Necessary { get; set; }
        public bool Analytics { get; set; }
        public bool Marketing { get; set; }
        public bool Functional { get; set; }
    }
}
