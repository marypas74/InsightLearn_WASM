@page "/login"
@inject IAuthService AuthService
@inject IToastService ToastService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Login - InsightLearn</PageTitle>

<!-- Modern two-column auth layout matching homepage design -->
<div class="auth-container">
    <!-- Left Column: Auth Form -->
    <div class="auth-content">
        <!-- Logo removed per user request - cleaner login experience -->

        <div class="auth-main">
            <div class="auth-card">
                <div class="auth-card-header">
                    <h1>Welcome Back</h1>
                    <p class="text-muted">Sign in to your InsightLearn account</p>
                </div>

                <div class="auth-card-body">
                    <!-- Enterprise SSO Button (Microsoft Entra ID / Azure AD) -->
                    <button @onclick="LoginWithSSO" class="sso-signin-btn" disabled="@isSsoLoading" type="button" aria-label="Sign in with your organization">
                        @if (isSsoLoading)
                        {
                            <div class="sso-spinner"></div>
                            <span>Connecting to your organization...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 23 23" class="microsoft-icon" role="img" aria-hidden="true" width="20" height="20">
                                <rect x="1" y="1" width="10" height="10" fill="#f25022"/>
                                <rect x="12" y="1" width="10" height="10" fill="#00a4ef"/>
                                <rect x="1" y="12" width="10" height="10" fill="#7fba00"/>
                                <rect x="12" y="12" width="10" height="10" fill="#ffb900"/>
                            </svg>
                            <span>Sign in with Organization (SSO)</span>
                        }
                    </button>

                    <!-- Divider -->
                    <div class="auth-divider">
                        <span>Or sign in with your credentials</span>
                    </div>

                    <!-- Login Form -->
                    <EditForm Model="@loginRequest" OnValidSubmit="HandleLogin" class="auth-form">
                        <DataAnnotationsValidator />

                        <div class="form-group">
                            <label for="email" class="form-label">Email Address</label>
                            <InputText id="email" class="form-input" @bind-Value="loginRequest.Email"
                                       placeholder="your@email.com" aria-required="true" />
                            <ValidationMessage For="@(() => loginRequest.Email)" class="field-validation-error" />
                        </div>

                        <div class="form-group">
                            <label for="password" class="form-label">Password</label>
                            <div class="password-input-container">
                                <InputText id="password" type="@(showPassword ? "text" : "password")" class="form-input"
                                           @bind-Value="loginRequest.Password"
                                           placeholder="Enter your password" aria-required="true" />
                                <button type="button" class="password-toggle-btn" @onclick="TogglePasswordVisibility"
                                        aria-label="@(showPassword ? "Hide password" : "Show password")">
                                    <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="@(() => loginRequest.Password)" class="field-validation-error" />
                        </div>

                        <div class="form-check-container">
                            <label class="form-check-label">
                                <InputCheckbox id="rememberMe" class="form-check-input" @bind-Value="loginRequest.RememberMe" />
                                <span class="checkmark"></span>
                                <span>Keep me signed in for 30 days</span>
                            </label>
                            <p class="remember-me-hint">For your security, don't check this on shared devices</p>
                        </div>

                        @if (!string.IsNullOrEmpty(displayError))
                        {
                            <div class="error-message" role="alert">
                                <i class="fas fa-exclamation-circle"></i>
                                <span class="error-text">@displayError</span>
                            </div>
                        }

                        <button type="submit" class="auth-submit-btn @(isLoading ? "loading" : "")" disabled="@isLoading"
                                style="width: 100% !important; display: flex !important; align-items: center !important; justify-content: center !important; gap: 8px; padding: 12px 16px !important; background: #A435F0 !important; color: white !important; border: 1px solid #A435F0 !important; border-radius: 8px; font-size: 16px !important; font-weight: 600; cursor: pointer; margin-top: 16px; min-height: 48px !important; position: relative !important; visibility: visible !important; opacity: 1 !important; z-index: 10 !important;">
                            @if (isLoading)
                            {
                                <div class="spinner"></div>
                                <span>Signing in...</span>
                            }
                            else
                            {
                                <span>Sign In</span>
                            }
                        </button>
                    </EditForm>

                    <!-- Sign Up Link -->
                    <div class="auth-signup">
                        <p>Don't have an account? <a href="/register" class="auth-link-primary">Create Account</a></p>
                    </div>

                    <!-- Forgot Password -->
                    <div class="auth-footer">
                        <a href="/forgot-password" class="auth-link">Forgot your password?</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Visual Content -->
    <div class="auth-visual">
        <div class="visual-content">
            <div class="visual-illustration">
                <div class="floating-elements">
                    <div class="floating-element element-1">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="floating-element element-2">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="floating-element element-3">
                        <i class="fas fa-certificate"></i>
                    </div>
                </div>
            </div>

            <div class="visual-text">
                <h2>Join thousands of learners worldwide</h2>
                <p>Transform your career with expert-led courses and industry-recognized certifications</p>
            </div>

            <div class="visual-stats">
                <div class="stat">
                    <span class="stat-number">10,000+</span>
                    <span class="stat-label">Courses</span>
                </div>
                <div class="stat">
                    <span class="stat-number">50K+</span>
                    <span class="stat-label">Students</span>
                </div>
                <div class="stat">
                    <span class="stat-number">150+</span>
                    <span class="stat-label">Countries</span>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new();
    private string? displayError;
    private bool isLoading = false;
    private bool isSsoLoading = false;
    private bool showPassword = false;

    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    /// <summary>
    /// Extracts a clean, user-friendly error message from various error formats
    /// </summary>
    private string ExtractCleanError(string? rawError)
    {
        if (string.IsNullOrWhiteSpace(rawError))
            return "Login failed. Please try again.";

        // Try to extract error from JSON response like {"IsSuccess":false,"Errors":["Invalid email or password."]}
        if (rawError.Contains("\"Errors\":["))
        {
            try
            {
                var startIdx = rawError.IndexOf("\"Errors\":[\"") + 11;
                var endIdx = rawError.IndexOf("\"]", startIdx);
                if (startIdx > 10 && endIdx > startIdx)
                {
                    return rawError.Substring(startIdx, endIdx - startIdx);
                }
            }
            catch { }
        }

        // Remove technical HTTP prefixes
        if (rawError.Contains("HTTP") && rawError.Contains("calling"))
        {
            // Try to find the actual error message after the JSON
            if (rawError.Contains("\"Errors\""))
            {
                return ExtractCleanError(rawError.Substring(rawError.IndexOf("{")));
            }
            // Generic fallback for HTTP errors
            if (rawError.Contains("BadRequest") || rawError.Contains("400"))
                return "Invalid email or password.";
            if (rawError.Contains("Unauthorized") || rawError.Contains("401"))
                return "Invalid email or password.";
            if (rawError.Contains("500") || rawError.Contains("InternalServerError"))
                return "Server error. Please try again later.";
            return "Connection error. Please check your internet and try again.";
        }

        // Return as-is if it's already a clean message
        return rawError;
    }

    /// <summary>
    /// Sanitizes the return URL to ensure it's a relative path for Blazor navigation
    /// </summary>
    private string SanitizeReturnUrl(string? url)
    {
        // Default to dashboard if no URL provided
        if (string.IsNullOrEmpty(url))
        {
            Console.WriteLine("[LOGIN] No return URL provided, defaulting to /dashboard");
            return "/dashboard";
        }

        Console.WriteLine($"[LOGIN] Original return URL: {url}");

        // Handle absolute URLs (extract path and query)
        if (url.StartsWith("http://") || url.StartsWith("https://"))
        {
            try
            {
                var uri = new Uri(url);
                var sanitized = uri.PathAndQuery;
                Console.WriteLine($"[LOGIN] Extracted relative path from absolute URL: {sanitized}");
                return sanitized;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[LOGIN] Failed to parse absolute URL: {ex.Message}");
                return "/dashboard";
            }
        }

        // Ensure path starts with /
        if (!url.StartsWith("/"))
        {
            var sanitized = "/" + url;
            Console.WriteLine($"[LOGIN] Added leading slash to path: {sanitized}");
            return sanitized;
        }

        Console.WriteLine($"[LOGIN] Using return URL as-is: {url}");
        return url;
    }

    private async Task HandleLogin()
    {
        isLoading = true;
        displayError = null;

        try
        {
            var response = await AuthService.LoginAsync(loginRequest);

            if (response.Success)
            {
                ToastService.ShowSuccess("Login successful!");
                Console.WriteLine($"[LOGIN] Login successful for user");

                // CRITICAL FIX: Wait and VERIFY auth state is actually propagated
                // Poll the AuthenticationStateProvider until user is authenticated
                var maxAttempts = 10;
                var authenticated = false;

                for (int i = 0; i < maxAttempts; i++)
                {
                    await Task.Delay(100);
                    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                    if (authState.User.Identity?.IsAuthenticated == true)
                    {
                        authenticated = true;
                        Console.WriteLine($"[LOGIN] Auth state verified after {i + 1} attempts");
                        break;
                    }
                    Console.WriteLine($"[LOGIN] Auth state not ready, attempt {i + 1}/{maxAttempts}");
                }

                if (!authenticated)
                {
                    Console.WriteLine("[LOGIN] WARNING: Auth state not verified, navigating anyway");
                }

                // Sanitize the return URL to ensure it's a relative path
                var redirectUrl = SanitizeReturnUrl(ReturnUrl);
                Console.WriteLine($"[LOGIN] Navigating to: {redirectUrl}");

                // Navigate without forceLoad - Blazor should now have correct auth state
                Navigation.NavigateTo(redirectUrl, forceLoad: false);
            }
            else
            {
                // Extract single clean error message
                string cleanError;

                if (response.Errors != null && response.Errors.Any())
                {
                    cleanError = ExtractCleanError(response.Errors.First());
                }
                else if (!string.IsNullOrEmpty(response.Message))
                {
                    cleanError = ExtractCleanError(response.Message);
                }
                else if (!string.IsNullOrEmpty(response.ErrorMessage))
                {
                    cleanError = ExtractCleanError(response.ErrorMessage);
                }
                else
                {
                    cleanError = "Login failed. Please try again.";
                }

                displayError = cleanError;
                ToastService.ShowError(cleanError);
            }
        }
        catch (Exception ex)
        {
            displayError = "An unexpected error occurred. Please try again later.";
            Console.WriteLine($"[LOGIN ERROR] {ex.GetType().Name}: {ex.Message}");
            ToastService.ShowError(displayError);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void LoginWithSSO()
    {
        isSsoLoading = true;
        // Sanitize the return URL before passing it to Microsoft Entra ID SSO
        var returnUrl = SanitizeReturnUrl(ReturnUrl);
        Console.WriteLine($"[LOGIN] SSO redirect with return URL: {returnUrl}");
        // Redirect to backend SSO endpoint (Microsoft Entra ID / Azure AD)
        Navigation.NavigateTo($"/api/auth/sso-login?returnUrl={Uri.EscapeDataString(returnUrl)}", true);
    }
}
