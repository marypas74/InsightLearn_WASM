@page "/login"
@inject IAuthService AuthService
@inject IToastService ToastService
@inject NavigationManager Navigation

<PageTitle>Login - InsightLearn</PageTitle>

<!-- Modern two-column auth layout matching homepage design -->
<div class="auth-container">
    <!-- Left Column: Auth Form -->
    <div class="auth-content">
        <!-- Logo removed per user request - cleaner login experience -->

        <div class="auth-main">
            <div class="auth-card">
                <div class="auth-card-header">
                    <h1>Welcome Back</h1>
                    <p class="text-muted">Sign in to your InsightLearn account</p>
                </div>

                <div class="auth-card-body">
                    <!-- Google Sign-In Button -->
                    <button @onclick="LoginWithGoogle" class="google-signin-btn" disabled="@isLoading" type="button" aria-label="Sign in with Google">
                        @if (isLoading)
                        {
                            <div class="google-spinner"></div>
                            <span>Signing in with Google...</span>
                        }
                        else
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="google-icon" role="img" aria-hidden="true">
                                <path fill="#4285F4" d="M24 9.5c3.8 0 6.4 1.6 7.9 3l5.8-5.8C33.8 3.3 29.3 1.5 24 1.5 14.7 1.5 6.9 7.3 3.9 15.5l6.7 5.2C12.2 14.5 17.5 9.5 24 9.5z"/>
                                <path fill="#34A853" d="M46.5 24c0-1.5-.2-3-.5-4.4H24v8.5h12.7c-.6 3-2.3 5.5-5 7.2l7.7 6c4.5-4.2 7.1-10.3 7.1-17.3z"/>
                                <path fill="#FBBC05" d="M10.6 28.4c-.9-2.6-.9-5.4 0-8l-6.7-5.2c-2.9 5.8-2.9 12.6 0 18.4l6.7-5.2z"/>
                                <path fill="#EA4335" d="M24 46.5c5.3 0 9.8-1.8 13.1-4.8l-7.7-6c-2.1 1.4-4.8 2.3-8.4 2.3-6.5 0-11.8-5-13.4-11.3l-6.7 5.2c3 8.2 10.8 14 20.1 14z"/>
                            </svg>
                            <span>Continue with Google</span>
                        }
                    </button>

                    <!-- Divider -->
                    <div class="auth-divider">
                        <span>Or continue with email</span>
                    </div>

                    <!-- Login Form -->
                    <EditForm Model="@loginRequest" OnValidSubmit="HandleLogin" class="auth-form">
                        <DataAnnotationsValidator />

                        <div class="form-group">
                            <label for="email" class="form-label">Email Address</label>
                            <InputText id="email" class="form-input" @bind-Value="loginRequest.Email"
                                       placeholder="your@email.com" aria-required="true" />
                            <ValidationMessage For="@(() => loginRequest.Email)" class="field-validation-error" />
                        </div>

                        <div class="form-group">
                            <label for="password" class="form-label">Password</label>
                            <div class="password-input-container">
                                <InputText id="password" type="@(showPassword ? "text" : "password")" class="form-input"
                                           @bind-Value="loginRequest.Password"
                                           placeholder="Enter your password" aria-required="true" />
                                <button type="button" class="password-toggle-btn" @onclick="TogglePasswordVisibility"
                                        aria-label="@(showPassword ? "Hide password" : "Show password")">
                                    <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="@(() => loginRequest.Password)" class="field-validation-error" />
                        </div>

                        <div class="form-check-container">
                            <label class="form-check-label">
                                <InputCheckbox id="rememberMe" class="form-check-input" @bind-Value="loginRequest.RememberMe" />
                                <span class="checkmark"></span>
                                <span>Keep me signed in for 30 days</span>
                            </label>
                            <p class="remember-me-hint">For your security, don't check this on shared devices</p>
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="error-message" role="alert">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>@errorMessage</span>
                            </div>
                        }

                        <button type="submit" class="auth-submit-btn @(isLoading ? "loading" : "")" disabled="@isLoading"
                                style="width: 100% !important; display: flex !important; align-items: center !important; justify-content: center !important; gap: 8px; padding: 12px 16px !important; background: #A435F0 !important; color: white !important; border: 1px solid #A435F0 !important; border-radius: 8px; font-size: 16px !important; font-weight: 600; cursor: pointer; margin-top: 16px; min-height: 48px !important; position: relative !important; visibility: visible !important; opacity: 1 !important; z-index: 10 !important;">
                            @if (isLoading)
                            {
                                <div class="spinner"></div>
                                <span>Signing in...</span>
                            }
                            else
                            {
                                <span>Sign In</span>
                            }
                        </button>
                    </EditForm>

                    <!-- Sign Up Link -->
                    <div class="auth-signup">
                        <p>Don't have an account? <a href="/register" class="auth-link-primary">Create Account</a></p>
                    </div>

                    <!-- Forgot Password -->
                    <div class="auth-footer">
                        <a href="/forgot-password" class="auth-link">Forgot your password?</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Visual Content -->
    <div class="auth-visual">
        <div class="visual-content">
            <div class="visual-illustration">
                <div class="floating-elements">
                    <div class="floating-element element-1">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="floating-element element-2">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="floating-element element-3">
                        <i class="fas fa-certificate"></i>
                    </div>
                </div>
            </div>

            <div class="visual-text">
                <h2>Join thousands of learners worldwide</h2>
                <p>Transform your career with expert-led courses and industry-recognized certifications</p>
            </div>

            <div class="visual-stats">
                <div class="stat">
                    <span class="stat-number">10,000+</span>
                    <span class="stat-label">Courses</span>
                </div>
                <div class="stat">
                    <span class="stat-number">50K+</span>
                    <span class="stat-label">Students</span>
                </div>
                <div class="stat">
                    <span class="stat-number">150+</span>
                    <span class="stat-label">Countries</span>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new();
    private string? errorMessage;
    private bool isLoading = false;
    private bool showPassword = false;

    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var response = await AuthService.LoginAsync(loginRequest);

            if (response.Success)
            {
                ToastService.ShowSuccess("Login successful!");

                // Add logging to debug authentication flow
                Console.WriteLine($"[LOGIN] Login successful for user");
                Console.WriteLine($"[LOGIN] Token saved to localStorage");
                Console.WriteLine($"[LOGIN] Auth state updated");

                // FIX: L'API non restituisce IsProfileComplete nel UserDto
                // Quindi andiamo direttamente alla dashboard per utenti già registrati
                // La registrazione completa è solo per nuovi utenti che arrivano da /register
                var redirectUrl = ReturnUrl ?? "/dashboard";

                // CRITICAL FIX: Remove 'true' parameter to avoid forced page reload
                // Forced reload causes auth state to be lost temporarily
                Navigation.NavigateTo(redirectUrl);
            }
            else
            {
                errorMessage = response.Message ?? "Login failed";
                if (response.Errors.Any())
                {
                    errorMessage += ": " + string.Join(", ", response.Errors);
                }
                ToastService.ShowError(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
            ToastService.ShowError(errorMessage);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void LoginWithGoogle()
    {
        // OAuth flow - redirect to API endpoint that handles Google OAuth
        var returnUrl = ReturnUrl ?? "/dashboard";
        // Note: OAuth requires full navigation to external auth provider, so 'true' is correct here
        Navigation.NavigateTo($"/api/auth/google-login?returnUrl={Uri.EscapeDataString(returnUrl)}", true);
    }
}
