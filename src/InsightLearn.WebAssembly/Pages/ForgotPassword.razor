@page "/forgot-password"
@using System.ComponentModel.DataAnnotations
@* @inject IAuthService AuthService *@
@inject NavigationManager Navigation
@* @inject IToastService Toast *@

<PageTitle>Forgot Password - InsightLearn</PageTitle>

<div class="auth-container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--color-bg-secondary); padding: var(--spacing-6);">
    <div class="auth-card" style="max-width: 400px; width: 100%; background: white; border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); padding: var(--spacing-8);">
        <div class="auth-header" style="text-align: center; margin-bottom: var(--spacing-6);">
            <div style="width: 64px; height: 64px; background: var(--gradient-primary); border-radius: 50%; margin: 0 auto var(--spacing-4); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-lock" style="font-size: 32px; color: white;"></i>
            </div>
            <h1 style="font-size: var(--text-3xl); font-weight: var(--font-extrabold); color: var(--color-gray-900); margin-bottom: var(--spacing-2);">Reset Your Password</h1>
            <p class="lead" style="color: var(--color-gray-600); font-size: var(--text-base);">Enter your email address and we'll send you a link to reset your password.</p>
        </div>

        @if (!emailSent)
        {
            <EditForm Model="model" OnValidSubmit="HandleSubmitAsync">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <InputText @bind-Value="model.Email"
                               class="form-control"
                               placeholder="your@email.com"
                               disabled="@isSubmitting" />
                    <ValidationMessage For="@(() => model.Email)" class="invalid-feedback" style="display: block;" />
                </div>

                <div class="btn-group-vertical" style="gap: var(--spacing-3); margin-top: var(--spacing-6);">
                    <button type="submit"
                            class="btn btn-primary btn-lg @(isSubmitting ? "btn-loading" : "")"
                            disabled="@isSubmitting"
                            style="width: 100%;">
                        @if (!isSubmitting)
                        {
                            <i class="fas fa-paper-plane" style="margin-right: var(--spacing-2);"></i>
                            <span>Send Reset Link</span>
                        }
                        else
                        {
                            <span>Sending...</span>
                        }
                    </button>
                </div>
            </EditForm>

            <div class="auth-footer" style="text-align: center; margin-top: var(--spacing-6); padding-top: var(--spacing-6); border-top: 1px solid var(--color-border);">
                <a href="/login" style="color: var(--color-primary); text-decoration: none; font-weight: var(--font-medium); transition: color var(--transition-fast);">
                    <i class="fas fa-arrow-left" style="margin-right: var(--spacing-2);"></i>
                    Back to Login
                </a>
            </div>
        }
        else
        {
            <div class="alert alert-success" role="alert">
                <div class="alert-title" style="display: flex; align-items: center; gap: var(--spacing-2);">
                    <i class="fas fa-check-circle" style="font-size: var(--text-xl);"></i>
                    <span>Check Your Email</span>
                </div>
                <p style="margin-top: var(--spacing-2); margin-bottom: 0;">
                    We've sent password reset instructions to <strong>@model.Email</strong>.
                    Please check your inbox and follow the link to reset your password.
                </p>
            </div>

            <div class="btn-group-vertical" style="gap: var(--spacing-3); margin-top: var(--spacing-6);">
                <button type="button"
                        class="btn btn-outline"
                        @onclick="ResetForm"
                        style="width: 100%;">
                    <i class="fas fa-redo" style="margin-right: var(--spacing-2);"></i>
                    Send Another Link
                </button>

                <a href="/login" class="btn btn-ghost" style="width: 100%;">
                    <i class="fas fa-arrow-left" style="margin-right: var(--spacing-2);"></i>
                    Back to Login
                </a>
            </div>

            <div style="margin-top: var(--spacing-6); padding: var(--spacing-4); background: var(--color-gray-50); border-radius: var(--radius-md); text-align: center;">
                <p class="text-small" style="color: var(--color-gray-600); margin-bottom: var(--spacing-2);">
                    <i class="fas fa-info-circle"></i> Didn't receive the email?
                </p>
                <p class="text-xs" style="color: var(--color-gray-500); margin: 0;">
                    Check your spam folder or contact support if the problem persists.
                </p>
            </div>
        }
    </div>
</div>

@code {
    private ForgotPasswordModel model = new();
    private bool isSubmitting = false;
    private bool emailSent = false;

    private async Task HandleSubmitAsync()
    {
        isSubmitting = true;
        try
        {
            // TODO: API not implemented
            // await AuthService.ForgotPasswordAsync(model.Email);

            // Simulate API call
            await Task.Delay(1500);

            emailSent = true;

            // Toast.ShowSuccess("Password reset email sent successfully!");
            Console.WriteLine($"[ForgotPassword] Reset email sent to: {model.Email}");
        }
        catch (Exception ex)
        {
            // Toast.ShowError($"Error: {ex.Message}");
            Console.Error.WriteLine($"[ForgotPassword] Error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void ResetForm()
    {
        emailSent = false;
        model = new();
    }

    public class ForgotPasswordModel
    {
        [Required(ErrorMessage = "Email address is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string Email { get; set; } = string.Empty;
    }
}
