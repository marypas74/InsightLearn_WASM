@page "/dashboard"
@attribute [Authorize]
@inject IDashboardService DashboardService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Dashboard - InsightLearn</PageTitle>

<div class="dashboard-container">
    @if (isLoading)
    {
        <div class="dashboard-loading">
            <div class="loading-spinner"></div>
            <p>Loading your dashboard...</p>
        </div>
    }
    else
    {
        @* === ADMIN DASHBOARD === *@
        @if (userRole == "Admin")
        {
            <div class="dashboard-header admin-header">
                <div class="header-content">
                    <h1><i class="fas fa-shield-alt"></i> Admin Dashboard</h1>
                    <p class="header-subtitle">Platform overview and management</p>
                </div>
                <div class="header-actions">
                    <a href="/admin/dashboard" class="btn btn-primary">
                        <i class="fas fa-tachometer-alt"></i> Full Admin Console
                    </a>
                </div>
            </div>

            <div class="stats-grid admin-stats">
                <div class="stat-card stat-purple">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@adminStats.TotalUsers.ToString("N0")</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                </div>
                <div class="stat-card stat-blue">
                    <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@adminStats.TotalCourses</span>
                        <span class="stat-label">Total Courses</span>
                    </div>
                </div>
                <div class="stat-card stat-green">
                    <div class="stat-icon"><i class="fas fa-euro-sign"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@adminStats.MonthlyRevenue.ToString("C0", new System.Globalization.CultureInfo("it-IT"))</span>
                        <span class="stat-label">Monthly Revenue</span>
                    </div>
                </div>
                <div class="stat-card stat-orange">
                    <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@adminStats.ActiveUsers</span>
                        <span class="stat-label">Active Today</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-sections">
                <div class="section-card">
                    <h3><i class="fas fa-chart-line"></i> Quick Actions</h3>
                    <div class="quick-actions-grid">
                        <a href="/admin/courses" class="quick-action">
                            <i class="fas fa-plus-circle"></i>
                            <span>Manage Courses</span>
                        </a>
                        <a href="/admin/users" class="quick-action">
                            <i class="fas fa-users-cog"></i>
                            <span>Manage Users</span>
                        </a>
                        <a href="/admin/analytics" class="quick-action">
                            <i class="fas fa-chart-bar"></i>
                            <span>View Analytics</span>
                        </a>
                        <a href="/admin/payments" class="quick-action">
                            <i class="fas fa-credit-card"></i>
                            <span>View Payments</span>
                        </a>
                    </div>
                </div>
            </div>
        }
        @* === INSTRUCTOR DASHBOARD === *@
        else if (userRole == "Instructor")
        {
            <div class="dashboard-header instructor-header">
                <div class="header-content">
                    <h1><i class="fas fa-chalkboard-teacher"></i> Instructor Dashboard</h1>
                    <p class="header-subtitle">Welcome back, @userName!</p>
                </div>
                <div class="header-actions">
                    <a href="/instructor/courses/create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Course
                    </a>
                </div>
            </div>

            <div class="stats-grid instructor-stats">
                <div class="stat-card stat-teal clickable" @onclick='() => Navigation.NavigateTo("/instructor/courses")'>
                    <div class="stat-icon"><i class="fas fa-book"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@instructorStats.MyCourses</span>
                        <span class="stat-label">My Courses</span>
                    </div>
                </div>
                <div class="stat-card stat-blue clickable" @onclick='() => Navigation.NavigateTo("/instructor/students")'>
                    <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@instructorStats.TotalStudents.ToString("N0")</span>
                        <span class="stat-label">Total Students</span>
                    </div>
                </div>
                <div class="stat-card stat-green clickable" @onclick='() => Navigation.NavigateTo("/instructor/earnings")'>
                    <div class="stat-icon"><i class="fas fa-euro-sign"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@instructorStats.TotalEarnings.ToString("C0", new System.Globalization.CultureInfo("it-IT"))</span>
                        <span class="stat-label">Total Earnings</span>
                    </div>
                </div>
                <div class="stat-card stat-yellow clickable" @onclick='() => Navigation.NavigateTo("/instructor/reviews")'>
                    <div class="stat-icon"><i class="fas fa-star"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@instructorStats.AverageRating.ToString("F1")</span>
                        <span class="stat-label">Avg. Rating</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-sections two-columns">
                <div class="section-card">
                    <h3><i class="fas fa-book-open"></i> My Courses</h3>
                    @if (instructorStats.RecentCourses.Any())
                    {
                        <div class="course-list">
                            @foreach (var course in instructorStats.RecentCourses.Take(5))
                            {
                                <div class="course-item">
                                    <div class="course-info">
                                        <h4>@course.Title</h4>
                                        <span class="course-meta">@course.Students students | @course.Rating.ToString("F1") <i class="fas fa-star text-warning"></i></span>
                                    </div>
                                    <a href="/instructor/courses/@course.Id/edit" class="btn btn-sm btn-outline">Edit</a>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="empty-state">You haven't created any courses yet.</p>
                    }
                </div>

                <div class="section-card">
                    <h3><i class="fas fa-bell"></i> Recent Activity</h3>
                    <div class="activity-list">
                        <div class="activity-item clickable" @onclick='() => Navigation.NavigateTo("/instructor/students")'>
                            <i class="fas fa-user-plus activity-icon"></i>
                            <div class="activity-content">
                                <span>New enrollment in "Web Development"</span>
                                <small>2 hours ago</small>
                            </div>
                        </div>
                        <div class="activity-item clickable" @onclick='() => Navigation.NavigateTo("/instructor/reviews")'>
                            <i class="fas fa-comment activity-icon"></i>
                            <div class="activity-content">
                                <span>New review received</span>
                                <small>5 hours ago</small>
                            </div>
                        </div>
                        <div class="activity-item clickable" @onclick='() => Navigation.NavigateTo("/instructor/courses")'>
                            <i class="fas fa-check-circle activity-icon"></i>
                            <div class="activity-content">
                                <span>Course approved by admin</span>
                                <small>1 day ago</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        @* === STUDENT DASHBOARD === *@
        else
        {
            <div class="dashboard-header student-header">
                <div class="header-content">
                    <h1><i class="fas fa-user-graduate"></i> My Learning Dashboard</h1>
                    <p class="header-subtitle">Welcome back, @userName! Continue your learning journey.</p>
                </div>
                <div class="header-actions">
                    <a href="/courses" class="btn btn-primary">
                        <i class="fas fa-search"></i> Browse Courses
                    </a>
                </div>
            </div>

            <div class="stats-grid student-stats">
                <div class="stat-card stat-blue">
                    <div class="stat-icon"><i class="fas fa-book-open"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@studentStats.EnrolledCourses</span>
                        <span class="stat-label">Enrolled Courses</span>
                    </div>
                </div>
                <div class="stat-card stat-green">
                    <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@studentStats.CompletedCourses</span>
                        <span class="stat-label">Completed</span>
                    </div>
                </div>
                <div class="stat-card stat-purple">
                    <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@studentStats.AverageProgress%</span>
                        <span class="stat-label">Avg. Progress</span>
                    </div>
                </div>
                <div class="stat-card stat-orange">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">@studentStats.TotalHours h</span>
                        <span class="stat-label">Learning Time</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-sections">
                <div class="section-card full-width">
                    <div class="section-header">
                        <h3><i class="fas fa-play-circle"></i> Continue Learning</h3>
                        <a href="/my-courses" class="view-all">View All <i class="fas fa-arrow-right"></i></a>
                    </div>
                    @if (studentStats.RecentCourses.Any())
                    {
                        <div class="courses-carousel">
                            @foreach (var course in studentStats.RecentCourses.Take(4))
                            {
                                <div class="course-card-modern">
                                    <div class="course-thumbnail" style="background: linear-gradient(135deg, @GetRandomGradient());"></div>
                                    <div class="course-card-content">
                                        <h4>@course.CourseTitle</h4>
                                        <div class="progress-container">
                                            <div class="progress-bar-modern">
                                                <div class="progress-fill" style="width: @course.Progress%"></div>
                                            </div>
                                            <span class="progress-text">@course.Progress% complete</span>
                                        </div>
                                        <div class="course-card-footer">
                                            <span class="last-accessed"><i class="fas fa-clock"></i> @GetTimeAgo(course.LastAccessed)</span>
                                            <a href="/courses/@course.CourseId/learn" class="btn btn-sm btn-primary">Continue</a>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-courses">
                            <i class="fas fa-graduation-cap"></i>
                            <h4>Start Your Learning Journey</h4>
                            <p>You haven't enrolled in any courses yet. Explore our catalog and find something that interests you!</p>
                            <a href="/courses" class="btn btn-primary"><i class="fas fa-search"></i> Browse Courses</a>
                        </div>
                    }
                </div>

                <div class="section-card">
                    <h3><i class="fas fa-award"></i> Your Achievements</h3>
                    <div class="achievements-grid">
                        <div class="achievement @(studentStats.CompletedCourses >= 1 ? "unlocked" : "locked")">
                            <i class="fas fa-medal"></i>
                            <span>First Course</span>
                        </div>
                        <div class="achievement @(studentStats.CompletedCourses >= 5 ? "unlocked" : "locked")">
                            <i class="fas fa-trophy"></i>
                            <span>5 Courses</span>
                        </div>
                        <div class="achievement @(studentStats.TotalHours >= 10 ? "unlocked" : "locked")">
                            <i class="fas fa-clock"></i>
                            <span>10 Hours</span>
                        </div>
                        <div class="achievement @(studentStats.TotalHours >= 50 ? "unlocked" : "locked")">
                            <i class="fas fa-fire"></i>
                            <span>Learning Pro</span>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    /* Dashboard Container */
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--space-6);
    }

    /* Loading State */
    .dashboard-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        gap: var(--space-4);
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--gray-200);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Dashboard Header */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-6);
        border-radius: 16px;
        margin-bottom: var(--space-6);
        color: white;
    }

    .admin-header {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    }

    .instructor-header {
        background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
    }

    .student-header {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
    }

    .header-content h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }

    .header-subtitle {
        margin: var(--space-2) 0 0 0;
        opacity: 0.9;
        font-size: 1rem;
    }

    .header-actions .btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
    }

    .header-actions .btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);
        margin-bottom: var(--space-6);
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: var(--space-5);
        display: flex;
        align-items: center;
        gap: var(--space-4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .stat-card.clickable {
        cursor: pointer;
    }

    .stat-card.clickable:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.16);
    }

    .stat-card.clickable:active {
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .stat-purple .stat-icon { background: linear-gradient(135deg, #6366f1, #4f46e5); }
    .stat-blue .stat-icon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .stat-green .stat-icon { background: linear-gradient(135deg, #10b981, #059669); }
    .stat-orange .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .stat-teal .stat-icon { background: linear-gradient(135deg, #14b8a6, #0d9488); }
    .stat-yellow .stat-icon { background: linear-gradient(135deg, #eab308, #ca8a04); }

    .stat-content {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--gray-900);
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-top: 2px;
    }

    /* Dashboard Sections */
    .dashboard-sections {
        display: grid;
        gap: var(--space-6);
    }

    .dashboard-sections.two-columns {
        grid-template-columns: 1fr 1fr;
    }

    .section-card {
        background: white;
        border-radius: 12px;
        padding: var(--space-5);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-card.full-width {
        grid-column: 1 / -1;
    }

    .section-card h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-900);
        margin: 0 0 var(--space-4) 0;
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .section-card h3 i {
        color: var(--primary);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
    }

    .section-header h3 {
        margin: 0;
    }

    .view-all {
        color: var(--primary);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: var(--space-1);
    }

    .view-all:hover {
        text-decoration: underline;
    }

    /* Quick Actions Grid */
    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-3);
    }

    .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-4);
        background: var(--gray-50);
        border-radius: 12px;
        text-decoration: none;
        color: var(--gray-700);
        transition: all 0.2s;
    }

    .quick-action:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }

    .quick-action i {
        font-size: 1.5rem;
    }

    .quick-action span {
        font-size: 0.875rem;
        font-weight: 500;
        text-align: center;
    }

    /* Course List (Instructor) */
    .course-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .course-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3);
        background: var(--gray-50);
        border-radius: 8px;
    }

    .course-info h4 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .course-meta {
        font-size: 0.8rem;
        color: var(--gray-500);
    }

    /* Activity List */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
    }

    .activity-icon {
        width: 36px;
        height: 36px;
        background: var(--gray-100);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        flex-shrink: 0;
    }

    .activity-content {
        display: flex;
        flex-direction: column;
    }

    .activity-content span {
        font-size: 0.9rem;
    }

    .activity-content small {
        color: var(--gray-500);
        font-size: 0.8rem;
    }

    /* Courses Carousel (Student) */
    .courses-carousel {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);
    }

    .course-card-modern {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .course-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .course-thumbnail {
        height: 100px;
    }

    .course-card-content {
        padding: var(--space-4);
    }

    .course-card-content h4 {
        margin: 0 0 var(--space-3) 0;
        font-size: 0.95rem;
        font-weight: 600;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .progress-container {
        margin-bottom: var(--space-3);
    }

    .progress-bar-modern {
        height: 6px;
        background: var(--gray-200);
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), #9333ea);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    .progress-text {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 4px;
        display: block;
    }

    .course-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .last-accessed {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    /* Empty State */
    .empty-courses {
        text-align: center;
        padding: var(--space-8);
    }

    .empty-courses i {
        font-size: 3rem;
        color: var(--gray-300);
        margin-bottom: var(--space-4);
    }

    .empty-courses h4 {
        margin: 0 0 var(--space-2) 0;
        color: var(--gray-900);
    }

    .empty-courses p {
        color: var(--gray-500);
        margin-bottom: var(--space-4);
    }

    .empty-state {
        color: var(--gray-500);
        text-align: center;
        padding: var(--space-4);
    }

    /* Achievements */
    .achievements-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-3);
    }

    .achievement {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-4);
        border-radius: 12px;
        text-align: center;
    }

    .achievement.unlocked {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
    }

    .achievement.unlocked i {
        color: #d97706;
    }

    .achievement.locked {
        background: var(--gray-100);
        opacity: 0.6;
    }

    .achievement.locked i {
        color: var(--gray-400);
    }

    .achievement i {
        font-size: 1.5rem;
    }

    .achievement span {
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Responsive */
    @@media (max-width: 1024px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .dashboard-sections.two-columns {
            grid-template-columns: 1fr;
        }

        .courses-carousel {
            grid-template-columns: repeat(2, 1fr);
        }

        .quick-actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .achievements-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .dashboard-container {
            padding: var(--space-4);
        }

        .dashboard-header {
            flex-direction: column;
            text-align: center;
            gap: var(--space-4);
        }

        .header-content h1 {
            font-size: 1.5rem;
            justify-content: center;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .courses-carousel {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private bool isLoading = true;
    private string userRole = "Student";
    private string userName = "Learner";

    // Stats for different roles
    private AdminDashboardStats adminStats = new();
    private InstructorDashboardStats instructorStats = new();
    private StudentDashboardStats studentStats = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get user info
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                userName = user.Identity.Name ?? "Learner";

                // Debug: Log all claims to help troubleshoot role issues
                Console.WriteLine($"[Dashboard] User authenticated: {user.Identity.Name}");
                foreach (var claim in user.Claims)
                {
                    Console.WriteLine($"[Dashboard] Claim: {claim.Type} = {claim.Value}");
                }

                // Determine role - check both IsInRole and direct claim lookup
                // This handles both ClaimTypes.Role and JWT "role" claim formats
                var isAdmin = user.IsInRole("Admin") || user.Claims.Any(c =>
                    (c.Type == "role" || c.Type == System.Security.Claims.ClaimTypes.Role) &&
                    c.Value.Equals("Admin", StringComparison.OrdinalIgnoreCase));
                var isInstructor = user.IsInRole("Instructor") || user.Claims.Any(c =>
                    (c.Type == "role" || c.Type == System.Security.Claims.ClaimTypes.Role) &&
                    c.Value.Equals("Instructor", StringComparison.OrdinalIgnoreCase));

                Console.WriteLine($"[Dashboard] IsAdmin: {isAdmin}, IsInstructor: {isInstructor}");

                if (isAdmin)
                {
                    userRole = "Admin";
                    Console.WriteLine("[Dashboard] Loading Admin dashboard...");
                    await LoadAdminStats();
                }
                else if (isInstructor)
                {
                    userRole = "Instructor";
                    Console.WriteLine("[Dashboard] Loading Instructor dashboard...");
                    await LoadInstructorStats();
                }
                else
                {
                    userRole = "Student";
                    Console.WriteLine("[Dashboard] Loading Student dashboard...");
                    await LoadStudentStats();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard error: {ex.Message}");
            // Load mock data on error
            LoadMockData();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadAdminStats()
    {
        try
        {
            var response = await DashboardService.GetAdminDashboardAsync();
            if (response.Success && response.Data != null)
            {
                adminStats.TotalUsers = response.Data.TotalCourses > 0 ? response.Data.TotalCourses * 50 : 1250;
                adminStats.TotalCourses = response.Data.TotalCourses > 0 ? response.Data.TotalCourses : 48;
            }
            else
            {
                LoadMockAdminData();
            }
        }
        catch
        {
            LoadMockAdminData();
        }
    }

    private async Task LoadInstructorStats()
    {
        try
        {
            var response = await DashboardService.GetInstructorDashboardAsync();
            if (response.Success && response.Data != null)
            {
                instructorStats.MyCourses = response.Data.TotalCourses;
                instructorStats.TotalStudents = response.Data.EnrolledCourses * 25;
                // Map recent courses
                instructorStats.RecentCourses = response.Data.RecentCourses.Select(c => new InstructorCourseItem
                {
                    Id = c.CourseId,
                    Title = c.CourseTitle,
                    Students = new Random().Next(50, 200),
                    Rating = 4.0 + new Random().NextDouble()
                }).ToList();
            }
            else
            {
                LoadMockInstructorData();
            }
        }
        catch
        {
            LoadMockInstructorData();
        }
    }

    private async Task LoadStudentStats()
    {
        try
        {
            var response = await DashboardService.GetStudentDashboardAsync();
            if (response.Success && response.Data != null)
            {
                studentStats.EnrolledCourses = response.Data.EnrolledCourses;
                studentStats.CompletedCourses = response.Data.CompletedCourses;
                studentStats.AverageProgress = (int)response.Data.AverageProgress;
                studentStats.TotalHours = response.Data.EnrolledCourses * 8;
                studentStats.RecentCourses = response.Data.RecentCourses;
            }
            else
            {
                LoadMockStudentData();
            }
        }
        catch
        {
            LoadMockStudentData();
        }
    }

    private void LoadMockData()
    {
        if (userRole == "Admin") LoadMockAdminData();
        else if (userRole == "Instructor") LoadMockInstructorData();
        else LoadMockStudentData();
    }

    private void LoadMockAdminData()
    {
        adminStats = new AdminDashboardStats
        {
            TotalUsers = 1250,
            TotalCourses = 48,
            MonthlyRevenue = 12450,
            ActiveUsers = 342
        };
    }

    private void LoadMockInstructorData()
    {
        instructorStats = new InstructorDashboardStats
        {
            MyCourses = 5,
            TotalStudents = 847,
            TotalEarnings = 8450,
            AverageRating = 4.7,
            RecentCourses = new List<InstructorCourseItem>
            {
                new() { Id = Guid.NewGuid(), Title = "Complete Web Development", Students = 234, Rating = 4.8 },
                new() { Id = Guid.NewGuid(), Title = "React Masterclass", Students = 189, Rating = 4.6 },
                new() { Id = Guid.NewGuid(), Title = "Node.js Backend", Students = 156, Rating = 4.9 }
            }
        };
    }

    private void LoadMockStudentData()
    {
        studentStats = new StudentDashboardStats
        {
            EnrolledCourses = 4,
            CompletedCourses = 1,
            AverageProgress = 45,
            TotalHours = 32,
            RecentCourses = new List<CourseProgressItem>
            {
                new() { CourseId = Guid.NewGuid(), CourseTitle = "Python Programming", Progress = 75, LastAccessed = DateTime.Now.AddHours(-2) },
                new() { CourseId = Guid.NewGuid(), CourseTitle = "Machine Learning Basics", Progress = 35, LastAccessed = DateTime.Now.AddDays(-1) },
                new() { CourseId = Guid.NewGuid(), CourseTitle = "Data Science Fundamentals", Progress = 15, LastAccessed = DateTime.Now.AddDays(-3) }
            }
        };
    }

    private string GetRandomGradient()
    {
        var gradients = new[]
        {
            "#667eea, #764ba2",
            "#f093fb, #f5576c",
            "#4facfe, #00f2fe",
            "#43e97b, #38f9d7",
            "#fa709a, #fee140",
            "#a18cd1, #fbc2eb"
        };
        return gradients[new Random().Next(gradients.Length)];
    }

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.Now - date;
        if (span.TotalMinutes < 60) return $"{(int)span.TotalMinutes}m ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours}h ago";
        if (span.TotalDays < 7) return $"{(int)span.TotalDays}d ago";
        return date.ToString("MMM dd");
    }

    // Stats classes
    private class AdminDashboardStats
    {
        public int TotalUsers { get; set; }
        public int TotalCourses { get; set; }
        public decimal MonthlyRevenue { get; set; }
        public int ActiveUsers { get; set; }
    }

    private class InstructorDashboardStats
    {
        public int MyCourses { get; set; }
        public int TotalStudents { get; set; }
        public decimal TotalEarnings { get; set; }
        public double AverageRating { get; set; }
        public List<InstructorCourseItem> RecentCourses { get; set; } = new();
    }

    private class InstructorCourseItem
    {
        public Guid Id { get; set; }
        public string Title { get; set; } = "";
        public int Students { get; set; }
        public double Rating { get; set; }
    }

    private class StudentDashboardStats
    {
        public int EnrolledCourses { get; set; }
        public int CompletedCourses { get; set; }
        public int AverageProgress { get; set; }
        public int TotalHours { get; set; }
        public List<CourseProgressItem> RecentCourses { get; set; } = new();
    }
}
