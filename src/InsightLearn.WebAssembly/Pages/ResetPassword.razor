@page "/reset-password"
@using System.ComponentModel.DataAnnotations
@* @inject IAuthService AuthService *@
@inject NavigationManager Navigation
@* @inject IToastService Toast *@

<PageTitle>Reset Password - InsightLearn</PageTitle>

<div class="auth-container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--color-bg-secondary); padding: var(--spacing-6);">
    <div class="auth-card" style="max-width: 450px; width: 100%; background: white; border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); padding: var(--spacing-8);">
        <div class="auth-header" style="text-align: center; margin-bottom: var(--spacing-6);">
            <div style="width: 64px; height: 64px; background: var(--gradient-primary); border-radius: 50%; margin: 0 auto var(--spacing-4); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-key" style="font-size: 32px; color: white;"></i>
            </div>
            <h1 style="font-size: var(--text-3xl); font-weight: var(--font-extrabold); color: var(--color-gray-900); margin-bottom: var(--spacing-2);">Set New Password</h1>
            <p class="lead" style="color: var(--color-gray-600); font-size: var(--text-base);">Enter your new password below.</p>
        </div>

        @if (!passwordReset)
        {
            @if (string.IsNullOrEmpty(Token) || string.IsNullOrEmpty(Email))
            {
                <div class="alert alert-danger" role="alert">
                    <div class="alert-title" style="display: flex; align-items: center; gap: var(--spacing-2);">
                        <i class="fas fa-exclamation-triangle" style="font-size: var(--text-xl);"></i>
                        <span>Invalid Reset Link</span>
                    </div>
                    <p style="margin-top: var(--spacing-2); margin-bottom: 0;">
                        This password reset link is invalid or has expired. Please request a new password reset link.
                    </p>
                </div>

                <div class="btn-group-vertical" style="gap: var(--spacing-3); margin-top: var(--spacing-6);">
                    <a href="/forgot-password" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-redo" style="margin-right: var(--spacing-2);"></i>
                        Request New Link
                    </a>
                    <a href="/login" class="btn btn-ghost" style="width: 100%;">
                        <i class="fas fa-arrow-left" style="margin-right: var(--spacing-2);"></i>
                        Back to Login
                    </a>
                </div>
            }
            else
            {
                <EditForm Model="model" OnValidSubmit="HandleSubmitAsync">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email"
                               class="form-control"
                               value="@Email"
                               disabled
                               style="background: var(--color-gray-100);" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <InputText @bind-Value="model.NewPassword"
                                   type="password"
                                   class="form-control"
                                   placeholder="Enter new password (min. 8 characters)"
                                   disabled="@isSubmitting" />
                        <ValidationMessage For="@(() => model.NewPassword)" class="invalid-feedback" style="display: block;" />

                        <div style="margin-top: var(--spacing-2);">
                            <p class="text-xs" style="color: var(--color-gray-500); margin: 0;">
                                Password must be at least 8 characters long.
                            </p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <InputText @bind-Value="model.ConfirmPassword"
                                   type="password"
                                   class="form-control"
                                   placeholder="Re-enter new password"
                                   disabled="@isSubmitting" />
                        <ValidationMessage For="@(() => model.ConfirmPassword)" class="invalid-feedback" style="display: block;" />
                    </div>

                    <div class="btn-group-vertical" style="gap: var(--spacing-3); margin-top: var(--spacing-6);">
                        <button type="submit"
                                class="btn btn-primary btn-lg @(isSubmitting ? "btn-loading" : "")"
                                disabled="@isSubmitting"
                                style="width: 100%;">
                            @if (!isSubmitting)
                            {
                                <i class="fas fa-check-circle" style="margin-right: var(--spacing-2);"></i>
                                <span>Reset Password</span>
                            }
                            else
                            {
                                <span>Resetting...</span>
                            }
                        </button>
                    </div>
                </EditForm>
            }
        }
        else
        {
            <div class="alert alert-success" role="alert">
                <div class="alert-title" style="display: flex; align-items: center; gap: var(--spacing-2);">
                    <i class="fas fa-check-circle" style="font-size: var(--text-xl);"></i>
                    <span>Password Reset Successful</span>
                </div>
                <p style="margin-top: var(--spacing-2); margin-bottom: 0;">
                    Your password has been reset successfully. You can now log in with your new password.
                </p>
            </div>

            <div class="btn-group-vertical" style="gap: var(--spacing-3); margin-top: var(--spacing-6);">
                <a href="/login" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-sign-in-alt" style="margin-right: var(--spacing-2);"></i>
                    Go to Login
                </a>
            </div>
        }

        <div class="auth-footer" style="text-align: center; margin-top: var(--spacing-6); padding-top: var(--spacing-6); border-top: 1px solid var(--color-border);">
            <a href="/login" style="color: var(--color-primary); text-decoration: none; font-weight: var(--font-medium); transition: color var(--transition-fast);">
                <i class="fas fa-arrow-left" style="margin-right: var(--spacing-2);"></i>
                Back to Login
            </a>
        </div>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Email { get; set; }

    private ResetPasswordModel model = new();
    private bool isSubmitting = false;
    private bool passwordReset = false;

    private async Task HandleSubmitAsync()
    {
        isSubmitting = true;
        try
        {
            // TODO: API not implemented
            // await AuthService.ResetPasswordAsync(Email!, Token!, model.NewPassword);

            // Simulate API call
            await Task.Delay(1500);

            passwordReset = true;

            // Toast.ShowSuccess("Password reset successfully! You can now log in.");
            Console.WriteLine($"[ResetPassword] Password reset for: {Email}");
        }
        catch (Exception ex)
        {
            // Toast.ShowError($"Error: {ex.Message}");
            Console.Error.WriteLine($"[ResetPassword] Error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class ResetPasswordModel
    {
        [Required(ErrorMessage = "New password is required")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "Password must be at least 8 characters long")]
        [DataType(DataType.Password)]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm your password")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        [DataType(DataType.Password)]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
