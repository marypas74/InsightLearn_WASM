@page "/learn/{CourseId:guid}/{LessonId:guid}"
@layout InsightLearn.WebAssembly.Layout.LearningLayout
@attribute [Authorize]
@using InsightLearn.WebAssembly.Components
@using InsightLearn.WebAssembly.Components.LearningSpace
@using InsightLearn.Shared.DTOs
@using Microsoft.AspNetCore.Authorization
@inject ICourseService CourseService
@inject IEnrollmentService EnrollmentService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IToastService ToastService
@* v2.2.0-dev: LinkedIn Learning Style 4-Column Fixed Layout with Tailwind CSS *@

<PageTitle>@(lesson?.Title ?? "Learning") - InsightLearn</PageTitle>

@if (isLoading)
{
    <!-- Loading State - Full Screen Centered -->
    <div class="flex h-screen items-center justify-center bg-gray-50">
        <div class="text-center">
            <div class="relative inline-block">
                <div class="w-16 h-16 border-4 border-blue-200 rounded-full animate-spin border-t-blue-600"></div>
            </div>
            <h3 class="mt-4 text-lg font-semibold text-gray-800">Preparing your learning experience</h3>
            <p class="mt-2 text-sm text-gray-500">Loading video, transcripts, and resources...</p>
        </div>
    </div>
}
else if (errorMessage != null)
{
    <!-- Error State - Full Screen Centered -->
    <div class="flex h-screen items-center justify-center bg-gray-50">
        <div class="text-center max-w-md px-6">
            <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                <i class="fas fa-exclamation-circle text-3xl text-red-500"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800">Unable to load lesson</h3>
            <p class="mt-2 text-gray-600">@errorMessage</p>
            <div class="mt-6 flex justify-center gap-3">
                <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium text-sm"
                        @onclick="@(() => LoadLearningEnvironment())">
                    <i class="fas fa-redo mr-2"></i>Try Again
                </button>
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"
                        @onclick="@(() => Navigation.NavigateTo($"/courses/{CourseId}"))">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Course
                </button>
            </div>
        </div>
    </div>
}
else if (lesson != null && course != null)
{
    <!-- ==========================================================================
         MAIN 4-COLUMN LAYOUT (LinkedIn Learning Style) - Theater Mode Enabled
         - ZONA A: Global Nav (80px)
         - ZONA B: Course Sidebar (350px, dark navy) - Collapsible
         - ZONA C: Main Stage (flex-1, scrollable)
         - ZONA D: AI Assistant (400px) - Collapsible
         ========================================================================== -->
    <div class="flex h-screen overflow-hidden bg-gray-50 font-sans">

        <!-- ================================================================
             ZONA A: GLOBAL NAV RAIL (80px, Estrema Sinistra)
             ================================================================ -->
        <nav class="w-20 bg-white border-r border-gray-200 flex flex-col items-center py-6 space-y-6 flex-shrink-0">
            <!-- Back to Course -->
            <button @onclick="BackToCourse"
                    class="flex flex-col items-center space-y-1 text-gray-500 hover:text-blue-600 transition-colors"
                    title="Back to course">
                <i class="fas fa-arrow-left text-xl"></i>
                <span class="text-xs font-medium">Back</span>
            </button>

            <!-- Home -->
            <button @onclick="@(() => Navigation.NavigateTo("/"))"
                    class="flex flex-col items-center space-y-1 text-gray-500 hover:text-blue-600 transition-colors"
                    title="Home">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs font-medium">Home</span>
            </button>

            <!-- My Learning -->
            <button @onclick="@(() => Navigation.NavigateTo("/my-courses"))"
                    class="flex flex-col items-center space-y-1 text-gray-500 hover:text-blue-600 transition-colors"
                    title="My Learning">
                <i class="fas fa-book-open text-xl"></i>
                <span class="text-xs font-medium">My Learning</span>
            </button>

            <!-- Spacer -->
            <div class="flex-1"></div>

            <!-- Progress Indicator -->
            <div class="text-center">
                <div class="text-xs font-bold text-blue-600">@currentLessonIndex/@totalLessons</div>
                <div class="text-xs text-gray-400">lessons</div>
            </div>
        </nav>

        <!-- ================================================================
             ZONA B: COURSE CONTENT SIDEBAR (350px, BLU SCURO) - Collapsible
             ================================================================ -->
        <aside class="@(IsContentSidebarOpen ? "w-[350px]" : "w-0") bg-dark-navy flex flex-col flex-shrink-0 overflow-hidden transition-all duration-300 ease-in-out @(leftSidebarOpen ? "" : "hidden lg:flex")">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0 min-w-[350px]">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-list-ul text-white text-sm"></i>
                    <h2 class="text-white font-semibold text-sm">Contents</h2>
                </div>
                <div class="flex items-center space-x-1">
                    <!-- Desktop Close Button -->
                    <button @onclick="ToggleContentSidebar"
                            class="hidden lg:flex p-1.5 hover:bg-white/10 rounded transition-colors"
                            title="Hide Contents">
                        <i class="fas fa-chevron-left text-white text-sm"></i>
                    </button>
                    <!-- Mobile Close Button -->
                    <button @onclick="ToggleLeftSidebar"
                            class="lg:hidden p-1.5 hover:bg-white/10 rounded transition-colors">
                        <i class="fas fa-times text-white text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- Course Title -->
            <div class="px-4 py-3 border-b border-gray-700 flex-shrink-0">
                <h3 class="text-white font-medium text-sm truncate">@course.Title</h3>
                <p class="text-gray-400 text-xs mt-1">by @course.InstructorName</p>
            </div>

            <!-- Scrollable Lesson List -->
            <div class="flex-1 overflow-y-auto">
                @if (course.Sections != null)
                {
                    @foreach (var section in course.Sections)
                    {
                        <div class="border-b border-gray-700">
                            <!-- Section Header -->
                            <button class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-white/5 transition-colors"
                                    @onclick="@(() => ToggleSection(section.Id))">
                                <div class="flex items-center space-x-3">
                                    <i class="fas @(expandedSections.Contains(section.Id) ? "fa-chevron-down" : "fa-chevron-right") text-gray-400 text-xs transition-transform"></i>
                                    <span class="text-white font-medium text-sm">@(section.Title)</span>
                                </div>
                                <span class="text-gray-400 text-xs">@FormatSectionDuration(section)</span>
                            </button>

                            <!-- Lessons (Collapsible) -->
                            @if (expandedSections.Contains(section.Id) && section.Lessons != null)
                            {
                                <div class="pl-4">
                                    @foreach (var lessonItem in section.Lessons)
                                    {
                                        var isActive = lessonItem.Id == LessonId;
                                        var isCompleted = lessonItem.IsCompleted;

                                        <div class="lesson-item flex items-center space-x-3 px-4 py-3 cursor-pointer transition-colors @(isActive ? "bg-white/10 border-l-2 border-blue-500" : "hover:bg-white/5")"
                                             @onclick="@(() => NavigateToLesson(lessonItem.Id))">
                                            <!-- Status Circle -->
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0
                                                        @(isCompleted ? "border-green-500" : isActive ? "border-blue-500" : "border-gray-500")">
                                                @if (isCompleted)
                                                {
                                                    <i class="fas fa-check text-green-500 text-xs"></i>
                                                }
                                                else if (isActive)
                                                {
                                                    <i class="fas fa-play text-blue-500 text-xs"></i>
                                                }
                                            </div>
                                            <!-- Lesson Info -->
                                            <div class="flex-1 min-w-0">
                                                <p class="@(isActive ? "text-white font-medium" : "text-gray-300") text-sm truncate">
                                                    @lessonItem.Title
                                                </p>
                                                <p class="text-gray-500 text-xs">@FormatDuration(lessonItem.DurationMinutes)</p>
                                            </div>
                                            <!-- Free Badge -->
                                            @if (lessonItem.IsFree)
                                            {
                                                <span class="text-xs text-green-400 font-medium">FREE</span>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        </aside>

        <!-- ================================================================
             ZONA C: MAIN STAGE (Flex-1, Scrollabile)
             ================================================================ -->
        <main class="flex-1 overflow-y-auto bg-gray-100">
            <!-- Video Player Section -->
            <div class="bg-black relative">

                <!-- ================================================================
                     THEATER MODE OVERLAY CONTROLS
                     Appear when sidebars are collapsed (desktop only)
                     ================================================================ -->

                <!-- Left Overlay: Show Contents Button (when Content Sidebar is closed) -->
                @if (!IsContentSidebarOpen)
                {
                    <button @onclick="ToggleContentSidebar"
                            class="hidden lg:flex absolute top-4 left-4 z-20 items-center space-x-2 px-3 py-2 bg-black/40 hover:bg-black/60 backdrop-blur-sm text-white rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105"
                            title="Show Contents">
                        <i class="fas fa-list-ul"></i>
                        <span>Contents</span>
                        <i class="fas fa-chevron-right text-xs opacity-70"></i>
                    </button>
                }

                <!-- Right Overlay: Show AI Button (when AI Sidebar is closed) -->
                @if (!IsAISidebarOpen)
                {
                    <button @onclick="ToggleAISidebar"
                            class="hidden lg:flex absolute top-4 right-4 z-20 items-center space-x-2 px-3 py-2 bg-black/40 hover:bg-black/60 backdrop-blur-sm text-white rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105"
                            title="Show AI Assistant">
                        <i class="fas fa-chevron-left text-xs opacity-70"></i>
                        <span>AI Help</span>
                        <i class="fas fa-star"></i>
                    </button>
                }

                <!-- Theater Mode Indicator (when both sidebars are closed) -->
                @if (!IsContentSidebarOpen && !IsAISidebarOpen)
                {
                    <div class="hidden lg:flex absolute top-4 left-1/2 transform -translate-x-1/2 z-20 items-center space-x-2 px-3 py-1.5 bg-black/30 backdrop-blur-sm text-white/70 rounded-full text-xs">
                        <i class="fas fa-expand"></i>
                        <span>Theater Mode</span>
                    </div>
                }

                <!-- Mobile Toggle for Left Sidebar -->
                <button @onclick="ToggleLeftSidebar"
                        class="lg:hidden absolute top-4 left-4 z-10 px-3 py-2 bg-black/50 hover:bg-black/70 text-white rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-list-ul mr-2"></i>Contents
                </button>

                <!-- Mobile Toggle for Right Sidebar (AI) -->
                <button @onclick="ToggleRightSidebar"
                        class="lg:hidden absolute top-4 right-4 z-10 px-3 py-2 bg-black/50 hover:bg-black/70 text-white rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-robot mr-2"></i>AI Help
                </button>

                <!-- Video Player Component -->
                <VideoPlayer @ref="videoPlayerRef"
                             LessonId="@LessonId"
                             VideoUrl="@lesson.VideoUrl"
                             ShowControls="true"
                             ShowMetadata="false"
                             SubtitleTracks="@GetSubtitleTracks()"
                             DefaultSubtitleLanguage="@GetUserLanguage()"
                             OnTimeUpdate="@HandleTimeUpdate"
                             OnPlayStateChanged="@HandlePlayStateChanged"
                             OnVideoEnded="@HandleVideoEnded" />
            </div>

            <!-- TABS BAR (Sticky) -->
            <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
                <div class="flex px-6 overflow-x-auto">
                    <!-- Tab: Overview -->
                    <button @onclick="@(() => SetActiveTab("overview"))"
                            class="flex items-center space-x-2 py-4 px-4 border-b-2 whitespace-nowrap transition-colors text-sm font-medium
                                   @(activeTab == "overview" ? "border-gray-900 text-gray-900" : "border-transparent text-gray-500 hover:text-gray-700")">
                        <i class="far fa-file-alt"></i>
                        <span>Overview</span>
                    </button>

                    <!-- Tab: Notebook -->
                    <button @onclick="@(() => SetActiveTab("notes"))"
                            class="flex items-center space-x-2 py-4 px-4 border-b-2 whitespace-nowrap transition-colors text-sm font-medium
                                   @(activeTab == "notes" ? "border-gray-900 text-gray-900" : "border-transparent text-gray-500 hover:text-gray-700")">
                        <i class="far fa-sticky-note"></i>
                        <span>Notebook</span>
                    </button>

                    <!-- Tab: Transcript -->
                    <button @onclick="@(() => SetActiveTab("transcript"))"
                            class="flex items-center space-x-2 py-4 px-4 border-b-2 whitespace-nowrap transition-colors text-sm font-medium
                                   @(activeTab == "transcript" ? "border-gray-900 text-gray-900" : "border-transparent text-gray-500 hover:text-gray-700")">
                        <i class="fas fa-align-left"></i>
                        <span>Transcript</span>
                    </button>

                    <!-- Tab: Exercise Files -->
                    <button @onclick="@(() => SetActiveTab("exercise-files"))"
                            class="flex items-center space-x-2 py-4 px-4 border-b-2 whitespace-nowrap transition-colors text-sm font-medium
                                   @(activeTab == "exercise-files" ? "border-gray-900 text-gray-900" : "border-transparent text-gray-500 hover:text-gray-700")">
                        <i class="far fa-folder"></i>
                        <span>Exercise Files</span>
                        @if (HasExerciseFiles())
                        {
                            <span class="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full">@GetExerciseFileCount()</span>
                        }
                    </button>

                    <!-- Tab: Q&A -->
                    <button @onclick="@(() => SetActiveTab("qa"))"
                            class="flex items-center space-x-2 py-4 px-4 border-b-2 whitespace-nowrap transition-colors text-sm font-medium
                                   @(activeTab == "qa" ? "border-gray-900 text-gray-900" : "border-transparent text-gray-500 hover:text-gray-700")">
                        <i class="far fa-comments"></i>
                        <span>Q&A</span>
                    </button>
                </div>
            </div>

            <!-- TAB CONTENT -->
            <div class="bg-white min-h-[400px]">
                @if (activeTab == "overview")
                {
                    <!-- OVERVIEW TAB -->
                    <div class="p-6 space-y-6 max-w-4xl">
                        <!-- Lesson Title & Status -->
                        <div class="flex items-start justify-between">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900">@lesson.Title</h1>
                                @if (!string.IsNullOrEmpty(lesson.Description))
                                {
                                    <p class="mt-2 text-gray-600">@lesson.Description</p>
                                }
                            </div>
                            @if (lesson.IsCompleted)
                            {
                                <span class="flex items-center space-x-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Completed</span>
                                </span>
                            }
                        </div>

                        <!-- Lesson Meta -->
                        <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                            <span class="flex items-center space-x-1">
                                <i class="fas fa-clock"></i>
                                <span>@FormatDuration(lesson.DurationMinutes)</span>
                            </span>
                            <span class="flex items-center space-x-1">
                                <i class="fas fa-layer-group"></i>
                                <span>@currentSection?.Title</span>
                            </span>
                            @if (lesson.IsFree)
                            {
                                <span class="flex items-center space-x-1 text-green-600">
                                    <i class="fas fa-unlock"></i>
                                    <span>Free Preview</span>
                                </span>
                            }
                        </div>

                        <!-- Instructor Section -->
                        <div class="border-t border-gray-200 pt-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Instructor</h2>
                            <div class="flex items-start space-x-4">
                                <div class="w-16 h-16 rounded-full bg-blue-600 flex items-center justify-center text-white text-xl font-bold flex-shrink-0">
                                    @GetInstructorInitials()
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-base font-semibold text-gray-900">@course.InstructorName</h3>
                                    <p class="text-sm text-gray-600 mt-1">Course Instructor</p>
                                </div>
                            </div>
                        </div>

                        <!-- Related Resources -->
                        @if (!string.IsNullOrEmpty(lesson.AttachmentUrl))
                        {
                            <div class="border-t border-gray-200 pt-6">
                                <h2 class="text-lg font-semibold text-gray-900 mb-4">Related to this course</h2>
                                <a href="@lesson.AttachmentUrl" target="_blank"
                                   class="flex items-center justify-between py-3 px-3 -mx-3 hover:bg-gray-50 rounded-lg transition-colors">
                                    <div class="flex items-center space-x-3">
                                        <i class="far fa-folder text-gray-600 text-lg"></i>
                                        <span class="text-sm font-medium text-gray-900">@(lesson.AttachmentName ?? "Exercise Files")</span>
                                    </div>
                                    <i class="fas fa-download text-blue-600"></i>
                                </a>
                            </div>
                        }

                        <!-- Course Details -->
                        <div class="border-t border-gray-200 pt-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Course details</h2>
                            <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-lg">
                                @if (!string.IsNullOrEmpty(course.ThumbnailUrl))
                                {
                                    <img src="@course.ThumbnailUrl" alt="@course.Title"
                                         class="w-24 h-16 object-cover rounded flex-shrink-0" />
                                }
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-medium text-gray-900 truncate">@course.Title</h4>
                                    <p class="text-sm text-gray-500 mt-1">
                                        @course.LessonCount lessons â€¢ @FormatDuration(course.EstimatedDurationMinutes)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="border-t border-gray-200 pt-6 flex justify-between">
                            <button @onclick="NavigateToPreviousLesson"
                                    disabled="@(!hasPreviousLesson)"
                                    class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium text-sm transition-colors
                                           @(hasPreviousLesson ? "hover:bg-gray-50" : "opacity-50 cursor-not-allowed")">
                                <i class="fas fa-chevron-left mr-2"></i>Previous
                            </button>
                            <button @onclick="NavigateToNextLesson"
                                    disabled="@(!hasNextLesson)"
                                    class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium text-sm transition-colors
                                           @(hasNextLesson ? "hover:bg-blue-700" : "bg-green-600 hover:bg-green-700")">
                                @if (hasNextLesson)
                                {
                                    <span>Next<i class="fas fa-chevron-right ml-2"></i></span>
                                }
                                else
                                {
                                    <span><i class="fas fa-check mr-2"></i>Complete Course</span>
                                }
                            </button>
                        </div>
                    </div>
                }
                else if (activeTab == "notes")
                {
                    <!-- NOTEBOOK TAB -->
                    <div class="p-6">
                        <StudentNotesPanel LessonId="@LessonId"
                                           CurrentVideoTimestamp="@((int)currentVideoTime)"
                                           OnTimestampClick="@HandleNotesTimestampClick" />
                    </div>
                }
                else if (activeTab == "transcript")
                {
                    <!-- TRANSCRIPT TAB -->
                    <div class="p-6">
                        <VideoTranscriptViewer LessonId="@LessonId"
                                               CurrentVideoTimestamp="@((int)currentVideoTime)"
                                               OnTimestampClick="@HandleTranscriptTimestampClick" />
                    </div>
                }
                else if (activeTab == "exercise-files")
                {
                    <!-- EXERCISE FILES TAB -->
                    <div class="p-6">
                        <ExerciseFilesPanel LessonId="@LessonId"
                                            CourseId="@CourseId" />
                    </div>
                }
                else if (activeTab == "qa")
                {
                    <!-- Q&A TAB -->
                    <div class="p-6">
                        <QAPanel LessonId="@LessonId"
                                 CourseId="@CourseId" />
                    </div>
                }
            </div>
        </main>

        <!-- ================================================================
             ZONA D: AI ASSISTANT SIDEBAR (400px, Destra) - Collapsible
             ================================================================ -->
        <aside class="@(IsAISidebarOpen ? "w-[400px]" : "w-0") bg-white border-l border-gray-200 flex flex-col flex-shrink-0 overflow-hidden transition-all duration-300 ease-in-out @(rightSidebarOpen ? "" : "hidden lg:flex")">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0 min-w-[400px]">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-star text-blue-600"></i>
                    <h2 class="font-semibold text-gray-800 text-sm">AI Learning Assistant</h2>
                </div>
                <div class="flex items-center space-x-1">
                    <!-- Desktop Close Button -->
                    <button @onclick="ToggleAISidebar"
                            class="hidden lg:flex p-1.5 hover:bg-gray-100 rounded transition-colors"
                            title="Hide AI Assistant">
                        <i class="fas fa-chevron-right text-gray-500 text-sm"></i>
                    </button>
                    <!-- Mobile Close Button -->
                    <button @onclick="ToggleRightSidebar"
                            class="lg:hidden p-1.5 hover:bg-gray-100 rounded transition-colors">
                        <i class="fas fa-times text-gray-500"></i>
                    </button>
                </div>
            </div>

            <!-- AI Chat Content -->
            <div class="flex-1 overflow-hidden">
                <AIChatPanel LessonId="@LessonId"
                             CurrentVideoTimestamp="@((int)currentVideoTime)"
                             OnTimestampClick="@HandleAIChatTimestampClick" />
            </div>
        </aside>

    </div>

    <!-- Mobile Backdrop Overlay -->
    @if (leftSidebarOpen || rightSidebarOpen)
    {
        <div class="lg:hidden fixed inset-0 bg-black/50 z-40" @onclick="CloseAllSidebars"></div>
    }

    <!-- Mobile Bottom Navigation (Optional) -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
        <div class="flex justify-around py-2">
            <button @onclick="NavigateToPreviousLesson"
                    disabled="@(!hasPreviousLesson)"
                    class="flex flex-col items-center py-2 px-4 @(!hasPreviousLesson ? "opacity-50" : "")">
                <i class="fas fa-chevron-left text-gray-600"></i>
                <span class="text-xs text-gray-600 mt-1">Previous</span>
            </button>
            <button @onclick="ToggleLeftSidebar"
                    class="flex flex-col items-center py-2 px-4">
                <i class="fas fa-list-ul text-gray-600"></i>
                <span class="text-xs text-gray-600 mt-1">Contents</span>
            </button>
            <button @onclick="ToggleRightSidebar"
                    class="flex flex-col items-center py-2 px-4">
                <i class="fas fa-robot text-gray-600"></i>
                <span class="text-xs text-gray-600 mt-1">AI Help</span>
            </button>
            <button @onclick="NavigateToNextLesson"
                    disabled="@(!hasNextLesson)"
                    class="flex flex-col items-center py-2 px-4 @(!hasNextLesson ? "opacity-50" : "")">
                <i class="fas fa-chevron-right text-gray-600"></i>
                <span class="text-xs text-gray-600 mt-1">Next</span>
            </button>
        </div>
    </div>
}

@code {
    [Parameter] public Guid CourseId { get; set; }
    [Parameter] public Guid LessonId { get; set; }

    private VideoPlayer? videoPlayerRef;
    private CourseDto? course;
    private LessonDto? lesson;
    private SectionDto? currentSection;
    private bool isLoading = true;
    private string? errorMessage;
    private bool isEnrolled = false;

    // Video state
    private double currentVideoTime = 0;
    private double videoDuration = 0;
    private bool isPlaying = false;

    // UI state
    private string activeTab = "overview";
    private bool leftSidebarOpen = false;   // Mobile sidebar toggle
    private bool rightSidebarOpen = false;  // Mobile sidebar toggle
    private HashSet<Guid> expandedSections = new();

    // Theater Mode state (Desktop sidebar visibility)
    private bool IsContentSidebarOpen = true;  // Left sidebar (Contents)
    private bool IsAISidebarOpen = true;       // Right sidebar (AI Assistant)

    // Navigation state
    private int currentLessonIndex = 1;
    private int totalLessons = 1;
    private bool hasPreviousLesson = false;
    private bool hasNextLesson = false;
    private Guid? previousLessonId;
    private Guid? nextLessonId;

    protected override async Task OnInitializedAsync()
    {
        await LoadLearningEnvironment();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (LessonId != Guid.Empty && lesson?.Id != LessonId)
        {
            await LoadLearningEnvironment();
        }
    }

    private async Task LoadLearningEnvironment()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var courseResponse = await CourseService.GetCourseByIdAsync(CourseId);
            if (!courseResponse.Success || courseResponse.Data == null)
            {
                errorMessage = "Course not found.";
                return;
            }
            course = courseResponse.Data;

            lesson = FindLesson(course, LessonId);
            if (lesson == null)
            {
                errorMessage = "Lesson not found in this course.";
                return;
            }

            // Expand the section containing the current lesson
            if (currentSection != null)
            {
                expandedSections.Add(currentSection.Id);
            }

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

            if (lesson.IsFree)
            {
                if (isAuthenticated)
                {
                    var enrollmentResponse = await CourseService.IsEnrolledAsync(CourseId);
                    isEnrolled = enrollmentResponse.Data;
                }
            }
            else
            {
                if (!isAuthenticated)
                {
                    Navigation.NavigateTo($"/login?returnUrl=/learn/{CourseId}/{LessonId}");
                    return;
                }

                var enrollmentResponse = await CourseService.IsEnrolledAsync(CourseId);
                isEnrolled = enrollmentResponse.Data;

                if (!isEnrolled)
                {
                    errorMessage = "You must be enrolled in this course to access this lesson.";
                    return;
                }
            }

            CalculateLessonNavigation();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading lesson: {ex.Message}";
            Console.Error.WriteLine($"[Learn] Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private LessonDto? FindLesson(CourseDto course, Guid lessonId)
    {
        foreach (var section in course.Sections ?? Enumerable.Empty<SectionDto>())
        {
            var foundLesson = section.Lessons?.FirstOrDefault(l => l.Id == lessonId);
            if (foundLesson != null)
            {
                currentSection = section;
                return foundLesson;
            }
        }
        return null;
    }

    private void CalculateLessonNavigation()
    {
        if (course == null || lesson == null) return;

        var allLessons = course.Sections?
            .SelectMany(s => s.Lessons ?? Enumerable.Empty<LessonDto>())
            .ToList() ?? new List<LessonDto>();

        totalLessons = allLessons.Count;
        currentLessonIndex = allLessons.FindIndex(l => l.Id == LessonId) + 1;

        if (currentLessonIndex > 1)
        {
            previousLessonId = allLessons[currentLessonIndex - 2].Id;
            hasPreviousLesson = true;
        }

        if (currentLessonIndex < totalLessons)
        {
            nextLessonId = allLessons[currentLessonIndex].Id;
            hasNextLesson = true;
        }
    }

    // Video event handlers
    private void HandleTimeUpdate(VideoPlayer.VideoTimeUpdate timeUpdate)
    {
        currentVideoTime = timeUpdate.CurrentTime;
        videoDuration = timeUpdate.Duration;
    }

    private void HandlePlayStateChanged(bool playing) => isPlaying = playing;

    private void HandleVideoEnded()
    {
        ToastService.ShowSuccess("Lesson completed! Great job!");
        if (hasNextLesson) NavigateToNextLesson();
    }

    // Timestamp click handlers
    private async Task HandleNotesTimestampClick(int timestamp)
    {
        if (videoPlayerRef != null) await videoPlayerRef.SeekToAsync(timestamp);
    }

    private async Task HandleTranscriptTimestampClick(double timestamp)
    {
        if (videoPlayerRef != null) await videoPlayerRef.SeekToAsync(timestamp);
    }

    private async Task HandleAIChatTimestampClick(int timestamp)
    {
        if (videoPlayerRef != null) await videoPlayerRef.SeekToAsync(timestamp);
    }

    // Navigation
    private void NavigateToLesson(Guid lessonId) => Navigation.NavigateTo($"/learn/{CourseId}/{lessonId}");
    private void NavigateToPreviousLesson() { if (previousLessonId.HasValue) Navigation.NavigateTo($"/learn/{CourseId}/{previousLessonId.Value}"); }
    private void NavigateToNextLesson() { if (nextLessonId.HasValue) Navigation.NavigateTo($"/learn/{CourseId}/{nextLessonId.Value}"); }
    private void BackToCourse() => Navigation.NavigateTo($"/courses/{CourseId}");

    // UI helpers
    private void SetActiveTab(string tab) => activeTab = tab;
    private void ToggleLeftSidebar() { leftSidebarOpen = !leftSidebarOpen; if (leftSidebarOpen) rightSidebarOpen = false; }
    private void ToggleRightSidebar() { rightSidebarOpen = !rightSidebarOpen; if (rightSidebarOpen) leftSidebarOpen = false; }
    private void CloseAllSidebars() { leftSidebarOpen = false; rightSidebarOpen = false; }

    // Theater Mode toggles (Desktop sidebar visibility)
    private void ToggleContentSidebar() => IsContentSidebarOpen = !IsContentSidebarOpen;
    private void ToggleAISidebar() => IsAISidebarOpen = !IsAISidebarOpen;
    private void EnterTheaterMode() { IsContentSidebarOpen = false; IsAISidebarOpen = false; }
    private void ExitTheaterMode() { IsContentSidebarOpen = true; IsAISidebarOpen = true; }

    private void ToggleSection(Guid sectionId)
    {
        if (expandedSections.Contains(sectionId))
            expandedSections.Remove(sectionId);
        else
            expandedSections.Add(sectionId);
    }

    private string FormatDuration(int minutes)
    {
        if (minutes < 60) return $"{minutes}m";
        var hours = minutes / 60;
        var mins = minutes % 60;
        return mins > 0 ? $"{hours}h {mins}m" : $"{hours}h";
    }

    private string FormatSectionDuration(SectionDto section)
    {
        var totalMinutes = section.Lessons?.Sum(l => l.DurationMinutes) ?? 0;
        return FormatDuration(totalMinutes);
    }

    private string GetInstructorInitials()
    {
        if (string.IsNullOrEmpty(course?.InstructorName)) return "IN";
        var parts = course.InstructorName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
    }

    private List<VideoPlayer.SubtitleTrack>? GetSubtitleTracks()
    {
        if (lesson?.SubtitleTracks == null || !lesson.SubtitleTracks.Any()) return null;
        return lesson.SubtitleTracks.Select(t => new VideoPlayer.SubtitleTrack
        {
            Url = t.Url,
            Language = t.Language,
            Label = t.Label,
            Kind = t.Kind,
            IsDefault = t.IsDefault
        }).ToList();
    }

    private string GetUserLanguage() => "it";

    private bool HasExerciseFiles() => !string.IsNullOrEmpty(lesson?.AttachmentUrl);

    private int GetExerciseFileCount() => !string.IsNullOrEmpty(lesson?.AttachmentUrl) ? 1 : 0;
}
