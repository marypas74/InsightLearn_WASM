@page "/learn/{CourseId:guid}/{LessonId:guid}"
@layout InsightLearn.WebAssembly.Layout.LearningLayout
@using InsightLearn.WebAssembly.Components
@using InsightLearn.WebAssembly.Components.LearningSpace
@using InsightLearn.Shared.DTOs
@inject ICourseService CourseService
@inject IEnrollmentService EnrollmentService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IToastService ToastService
@* v2.1.0-dev: Removed [Authorize] to allow anonymous preview of free lessons *@

<PageTitle>@(lesson?.Title ?? "Learning") - InsightLearn</PageTitle>

@if (isLoading)
{
    <div class="ll-learning-loading">
        <div class="ll-loading-content">
            <div class="ll-loading-spinner">
                <div class="ll-spinner-ring"></div>
                <div class="ll-spinner-ring"></div>
                <div class="ll-spinner-ring"></div>
            </div>
            <h3>Preparing your learning experience</h3>
            <p>Loading video, transcripts, and resources...</p>
        </div>
    </div>
}
else if (errorMessage != null)
{
    <div class="ll-learning-error">
        <div class="ll-error-content">
            <div class="ll-error-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h3>Unable to load lesson</h3>
            <p>@errorMessage</p>
            <div class="ll-error-actions">
                <button class="ll-btn ll-btn-secondary" @onclick="@(() => LoadLearningEnvironment())">
                    <i class="fas fa-redo"></i> Try Again
                </button>
                <button class="ll-btn ll-btn-primary" @onclick="@(() => Navigation.NavigateTo($"/courses/{CourseId}"))">
                    <i class="fas fa-arrow-left"></i> Back to Course
                </button>
            </div>
        </div>
    </div>
}
else if (lesson != null && course != null)
{
    <div class="learning-space-container">
        <!-- Top Navigation Bar - LinkedIn Learning Style -->
        <nav class="ll-learning-navbar">
            <div class="ll-navbar-left">
                <button class="ll-btn-back" @onclick="BackToCourse" title="Back to course">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="ll-course-info">
                    <span class="ll-course-title">@course.Title</span>
                    <span class="ll-lesson-title">@lesson.Title</span>
                </div>
            </div>
            <div class="ll-navbar-center">
                <div class="ll-progress-pill">
                    <span class="ll-lesson-counter">@currentLessonIndex of @totalLessons</span>
                    <div class="ll-progress-bar-mini">
                        <div class="ll-progress-fill" style="width: @((currentLessonIndex * 100.0 / totalLessons).ToString("0"))%"></div>
                    </div>
                </div>
            </div>
            <div class="ll-navbar-right">
                <div class="ll-nav-buttons">
                    <button class="ll-nav-btn @(!hasPreviousLesson ? "disabled" : "")"
                            @onclick="NavigateToPreviousLesson"
                            disabled="@(!hasPreviousLesson)"
                            title="Previous lesson">
                        <i class="fas fa-chevron-left"></i>
                        <span>Previous</span>
                    </button>
                    <button class="ll-nav-btn ll-nav-btn-next @(!hasNextLesson ? "disabled" : "")"
                            @onclick="NavigateToNextLesson"
                            disabled="@(!hasNextLesson)"
                            title="@(hasNextLesson ? "Next lesson" : "Course completed")">
                        <span>@(hasNextLesson ? "Next" : "Complete")</span>
                        <i class="fas @(hasNextLesson ? "fa-chevron-right" : "fa-check")"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Sidebar Backdrop Overlay -->
        @if (leftSidebarOpen || rightSidebarOpen)
        {
            <div class="ll-sidebar-backdrop visible" @onclick="CloseAllSidebars"></div>
        }

        <!-- Left Sidebar: Course Curriculum (Overlay) -->
        <aside class="ll-learning-sidebar ll-sidebar-left @(leftSidebarOpen ? "open" : "")">
            <div class="ll-sidebar-header">
                <div class="ll-sidebar-title">
                    <i class="fas fa-list-ul"></i>
                    <span>Course Content</span>
                </div>
                <button class="ll-sidebar-close" @onclick="ToggleLeftSidebar" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ll-sidebar-content">
                <CourseCurriculum Sections="@course.Sections"
                                  CurrentLessonId="@LessonId"
                                  OnLessonClick="NavigateToLesson" />
            </div>
        </aside>

        <!-- Right Sidebar: AI Assistant (Overlay) -->
        <aside class="ll-learning-sidebar ll-sidebar-right @(rightSidebarOpen ? "open" : "")">
            <div class="ll-sidebar-header">
                <div class="ll-sidebar-title">
                    <i class="fas fa-brain"></i>
                    <span>AI Learning Assistant</span>
                </div>
                <button class="ll-sidebar-close" @onclick="ToggleRightSidebar" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ll-sidebar-content ll-ai-sidebar-content">
                <AIChatPanel LessonId="@LessonId"
                             CurrentVideoTimestamp="@((int)currentVideoTime)"
                             OnTimestampClick="@HandleAIChatTimestampClick" />
            </div>
        </aside>

        <!-- Main Learning Space Layout -->
        <div class="ll-learning-layout">
            <!-- Center: Video Player + Tabs -->
            <main class="ll-main-content">
                <!-- Video Player with Toggle Buttons - LinkedIn Learning style responsive layout -->
                <div class="ll-video-player-wrapper">
                    <!-- Toggle Buttons on Video -->
                    <div class="ll-sidebar-toggles">
                        <button class="ll-sidebar-toggle ll-toggle-left @(leftSidebarOpen ? "active" : "")" @onclick="ToggleLeftSidebar">
                            <i class="fas fa-list-ul"></i>
                            <span>Contents</span>
                        </button>
                        <button class="ll-sidebar-toggle ll-toggle-right @(rightSidebarOpen ? "active" : "")" @onclick="ToggleRightSidebar">
                            <i class="fas fa-brain"></i>
                            <span>AI Help</span>
                        </button>
                    </div>
                    <VideoPlayer @ref="videoPlayerRef"
                                 LessonId="@LessonId"
                                 VideoUrl="@lesson.VideoUrl"
                                 ShowControls="true"
                                 ShowMetadata="false"
                                 SubtitleTracks="@GetSubtitleTracks()"
                                 DefaultSubtitleLanguage="@GetUserLanguage()"
                                 OnTimeUpdate="@HandleTimeUpdate"
                                 OnPlayStateChanged="@HandlePlayStateChanged"
                                 OnVideoEnded="@HandleVideoEnded" />
                </div>

                <!-- Video Progress Indicator -->
                <div class="ll-progress-indicator-wrapper">
                    <VideoProgressIndicator LessonId="@LessonId"
                                            CurrentPosition="@currentVideoTime"
                                            TotalDuration="@videoDuration"
                                            OnSeek="@HandleProgressSeek" />
                </div>

                <!-- Lesson Header - LinkedIn Learning Style -->
                <div class="ll-lesson-header">
                    <div class="ll-lesson-header-content">
                        <h2 class="ll-lesson-title">@lesson.Title</h2>
                        @if (!string.IsNullOrEmpty(lesson.Description))
                        {
                            <p class="ll-lesson-description">@lesson.Description</p>
                        }
                    </div>
                    <div class="ll-lesson-actions">
                        @if (lesson.IsCompleted)
                        {
                            <span class="ll-completed-badge">
                                <i class="fas fa-check-circle"></i> Completed
                            </span>
                        }
                    </div>
                </div>

                <!-- Tab Navigation - LinkedIn Learning Style -->
                <div class="ll-learning-tabs">
                    <div class="ll-tabs-container">
                        <div class="ll-tabs-nav" role="tablist">
                            <button class="ll-tab-btn @(activeTab == "overview" ? "active" : "")"
                                    @onclick="@(() => SetActiveTab("overview"))"
                                    type="button" role="tab"
                                    aria-selected="@(activeTab == "overview")">
                                <i class="fas fa-info-circle"></i>
                                <span>Overview</span>
                            </button>
                            <button class="ll-tab-btn @(activeTab == "notes" ? "active" : "")"
                                    @onclick="@(() => SetActiveTab("notes"))"
                                    type="button" role="tab"
                                    aria-selected="@(activeTab == "notes")">
                                <i class="fas fa-sticky-note"></i>
                                <span>Notes</span>
                            </button>
                            <button class="ll-tab-btn @(activeTab == "transcript" ? "active" : "")"
                                    @onclick="@(() => SetActiveTab("transcript"))"
                                    type="button" role="tab"
                                    aria-selected="@(activeTab == "transcript")">
                                <i class="fas fa-closed-captioning"></i>
                                <span>Transcript</span>
                            </button>
                            <button class="ll-tab-btn @(activeTab == "exercise-files" ? "active" : "")"
                                    @onclick="@(() => SetActiveTab("exercise-files"))"
                                    type="button" role="tab"
                                    aria-selected="@(activeTab == "exercise-files")">
                                <i class="fas fa-folder-open"></i>
                                <span>Exercise Files</span>
                                @if (HasExerciseFiles())
                                {
                                    <span class="ll-tab-badge">@GetExerciseFileCount()</span>
                                }
                            </button>
                            <button class="ll-tab-btn @(activeTab == "qa" ? "active" : "")"
                                    @onclick="@(() => SetActiveTab("qa"))"
                                    type="button" role="tab"
                                    aria-selected="@(activeTab == "qa")">
                                <i class="fas fa-comments"></i>
                                <span>Q&A</span>
                            </button>
                        </div>
                    </div>

                    <div class="ll-tab-content">
                        @if (activeTab == "overview")
                        {
                            <div class="ll-tab-pane ll-overview-pane">
                                <div class="ll-lesson-info">
                                    <div class="ll-lesson-meta">
                                        <span class="ll-meta-item">
                                            <i class="fas fa-clock"></i>
                                            @FormatDuration(lesson.DurationMinutes)
                                        </span>
                                        <span class="ll-meta-item">
                                            <i class="fas fa-layer-group"></i>
                                            @currentSection?.Title
                                        </span>
                                        @if (lesson.IsFree)
                                        {
                                            <span class="ll-meta-badge ll-badge-free">
                                                <i class="fas fa-unlock"></i> Free Preview
                                            </span>
                                        }
                                        @if (lesson.IsCompleted)
                                        {
                                            <span class="ll-meta-badge ll-badge-completed">
                                                <i class="fas fa-check-circle"></i> Completed
                                            </span>
                                        }
                                    </div>

                                    @if (!string.IsNullOrEmpty(lesson.Description))
                                    {
                                        <div class="ll-overview-section">
                                            <h4 class="ll-section-title">About this lesson</h4>
                                            <p class="ll-description">@lesson.Description</p>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(lesson.AttachmentUrl))
                                    {
                                        <div class="ll-overview-section">
                                            <h4 class="ll-section-title">Resources</h4>
                                            <a href="@lesson.AttachmentUrl" target="_blank" class="ll-resource-link">
                                                <i class="fas fa-file-download"></i>
                                                <span>@(lesson.AttachmentName ?? "Download Attachment")</span>
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </div>
                                    }

                                    <div class="ll-overview-section ll-course-info">
                                        <h4 class="ll-section-title">About this course</h4>
                                        <div class="ll-course-card">
                                            @if (!string.IsNullOrEmpty(course.ThumbnailUrl))
                                            {
                                                <img src="@course.ThumbnailUrl" alt="@course.Title" class="ll-course-thumb" />
                                            }
                                            <div class="ll-course-details">
                                                <h5>@course.Title</h5>
                                                <p class="ll-instructor">by @course.InstructorName</p>
                                                @if (course.LessonCount > 0)
                                                {
                                                    <p class="ll-course-stats">
                                                        @course.LessonCount lessons • @FormatDuration(course.EstimatedDurationMinutes)
                                                    </p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else if (activeTab == "notes")
                        {
                            <div class="ll-tab-pane">
                                <StudentNotesPanel LessonId="@LessonId"
                                                   CurrentVideoTimestamp="@((int)currentVideoTime)"
                                                   OnTimestampClick="@HandleNotesTimestampClick" />
                            </div>
                        }
                        else if (activeTab == "transcript")
                        {
                            <div class="ll-tab-pane">
                                <VideoTranscriptViewer LessonId="@LessonId"
                                                       CurrentVideoTimestamp="@((int)currentVideoTime)"
                                                       OnTimestampClick="@HandleTranscriptTimestampClick" />
                            </div>
                        }
                        else if (activeTab == "exercise-files")
                        {
                            <div class="ll-tab-pane ll-exercise-files-pane">
                                <ExerciseFilesPanel LessonId="@LessonId"
                                                    CourseId="@CourseId" />
                            </div>
                        }
                        else if (activeTab == "qa")
                        {
                            <div class="ll-tab-pane ll-qa-pane">
                                <QAPanel LessonId="@LessonId"
                                         CourseId="@CourseId" />
                            </div>
                        }
                    </div>
                </div>
            </main>
        </div>
    </div>
}

@code {
    [Parameter] public Guid CourseId { get; set; }
    [Parameter] public Guid LessonId { get; set; }

    private VideoPlayer? videoPlayerRef;
    private CourseDto? course;
    private LessonDto? lesson;
    private SectionDto? currentSection;
    private bool isLoading = true;
    private string? errorMessage;
    private bool isEnrolled = false;

    // Video state
    private double currentVideoTime = 0;
    private double videoDuration = 0;
    private bool isPlaying = false;

    // UI state
    private string activeTab = "overview"; // LinkedIn Learning default tab
    private bool leftSidebarOpen = false; // MUST start closed for LinkedIn Learning style
    private bool rightSidebarOpen = false; // MUST start closed for LinkedIn Learning style

    // Navigation state
    private int currentLessonIndex = 1;
    private int totalLessons = 1;
    private bool hasPreviousLesson = false;
    private bool hasNextLesson = false;
    private Guid? previousLessonId;
    private Guid? nextLessonId;

    protected override async Task OnInitializedAsync()
    {
        await LoadLearningEnvironment();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (LessonId != Guid.Empty && lesson?.Id != LessonId)
        {
            await LoadLearningEnvironment();
        }
    }

    private async Task LoadLearningEnvironment()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Load course data FIRST (needed to check if lesson is free)
            var courseResponse = await CourseService.GetCourseByIdAsync(CourseId);
            if (!courseResponse.Success || courseResponse.Data == null)
            {
                errorMessage = "Course not found.";
                return;
            }
            course = courseResponse.Data;

            // Find current lesson FIRST (needed to check if it's free)
            lesson = FindLesson(course, LessonId);
            if (lesson == null)
            {
                errorMessage = "Lesson not found in this course.";
                return;
            }

            // v2.1.0-dev: FREE lessons can be viewed by ANYONE (anonymous or authenticated)
            // PAID lessons require authentication AND enrollment
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

            if (lesson.IsFree)
            {
                // FREE lesson - allow anonymous preview
                // If authenticated, check enrollment status for progress tracking
                if (isAuthenticated)
                {
                    var enrollmentResponse = await CourseService.IsEnrolledAsync(CourseId);
                    isEnrolled = enrollmentResponse.Data;
                }
                // Continue to show the lesson (anonymous or authenticated)
            }
            else
            {
                // PAID lesson - require authentication
                if (!isAuthenticated)
                {
                    Navigation.NavigateTo($"/login?returnUrl=/learn/{CourseId}/{LessonId}");
                    return;
                }

                // Check enrollment for paid lessons
                var enrollmentResponse = await CourseService.IsEnrolledAsync(CourseId);
                isEnrolled = enrollmentResponse.Data;

                if (!isEnrolled)
                {
                    errorMessage = "You must be enrolled in this course to access this lesson.";
                    return;
                }
            }

            // Calculate lesson navigation
            CalculateLessonNavigation();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading lesson: {ex.Message}";
            Console.Error.WriteLine($"[Learn] Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private LessonDto? FindLesson(CourseDto course, Guid lessonId)
    {
        foreach (var section in course.Sections ?? Enumerable.Empty<SectionDto>())
        {
            var foundLesson = section.Lessons?.FirstOrDefault(l => l.Id == lessonId);
            if (foundLesson != null)
            {
                currentSection = section;
                return foundLesson;
            }
        }
        return null;
    }

    private void CalculateLessonNavigation()
    {
        if (course == null || lesson == null) return;

        var allLessons = course.Sections?
            .SelectMany(s => s.Lessons ?? Enumerable.Empty<LessonDto>())
            .ToList() ?? new List<LessonDto>();

        totalLessons = allLessons.Count;
        currentLessonIndex = allLessons.FindIndex(l => l.Id == LessonId) + 1;

        if (currentLessonIndex > 1)
        {
            previousLessonId = allLessons[currentLessonIndex - 2].Id;
            hasPreviousLesson = true;
        }

        if (currentLessonIndex < totalLessons)
        {
            nextLessonId = allLessons[currentLessonIndex].Id;
            hasNextLesson = true;
        }
    }

    // Video event handlers
    private void HandleTimeUpdate(VideoPlayer.VideoTimeUpdate timeUpdate)
    {
        currentVideoTime = timeUpdate.CurrentTime;
        videoDuration = timeUpdate.Duration;
    }

    private void HandlePlayStateChanged(bool playing)
    {
        isPlaying = playing;
    }

    private void HandleVideoEnded()
    {
        ToastService.ShowSuccess("Lesson completed! Great job!", settings => settings.Position = ToastPosition.TopCenter);
        if (hasNextLesson)
        {
            NavigateToNextLesson();
        }
    }

    // Timestamp click handlers (from components → video)
    private async Task HandleNotesTimestampClick(int timestamp)
    {
        if (videoPlayerRef != null)
        {
            await videoPlayerRef.SeekToAsync(timestamp);
        }
    }

    private async Task HandleTranscriptTimestampClick(double timestamp)
    {
        if (videoPlayerRef != null)
        {
            await videoPlayerRef.SeekToAsync(timestamp);
        }
    }

    private async Task HandleTakeawayTimestampClick(double timestamp)
    {
        if (videoPlayerRef != null)
        {
            await videoPlayerRef.SeekToAsync(timestamp);
        }
    }

    private async Task HandleAIChatTimestampClick(int timestamp)
    {
        if (videoPlayerRef != null)
        {
            await videoPlayerRef.SeekToAsync(timestamp);
        }
    }

    private async Task HandleProgressSeek(double timestamp)
    {
        if (videoPlayerRef != null)
        {
            await videoPlayerRef.SeekToAsync(timestamp);
        }
    }

    // Navigation
    private void NavigateToLesson(Guid lessonId)
    {
        Navigation.NavigateTo($"/learn/{CourseId}/{lessonId}");
    }

    private void NavigateToPreviousLesson()
    {
        if (previousLessonId.HasValue)
        {
            Navigation.NavigateTo($"/learn/{CourseId}/{previousLessonId.Value}");
        }
    }

    private void NavigateToNextLesson()
    {
        if (nextLessonId.HasValue)
        {
            Navigation.NavigateTo($"/learn/{CourseId}/{nextLessonId.Value}");
        }
    }

    private void BackToCourse()
    {
        Navigation.NavigateTo($"/courses/{CourseId}");
    }

    // UI helpers
    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private void ToggleLeftSidebar()
    {
        leftSidebarOpen = !leftSidebarOpen;
        if (leftSidebarOpen) rightSidebarOpen = false; // Close other sidebar
    }

    private void ToggleRightSidebar()
    {
        rightSidebarOpen = !rightSidebarOpen;
        if (rightSidebarOpen) leftSidebarOpen = false; // Close other sidebar
    }

    private void CloseAllSidebars()
    {
        leftSidebarOpen = false;
        rightSidebarOpen = false;
    }

    private List<string> ParseList(string input)
    {
        if (string.IsNullOrEmpty(input)) return new List<string>();
        return input.Split(new[] { ';', '\n', '|' }, StringSplitOptions.RemoveEmptyEntries)
                   .Select(s => s.Trim())
                   .Where(s => !string.IsNullOrEmpty(s))
                   .ToList();
    }

    private string FormatDuration(int minutes)
    {
        if (minutes < 60)
            return $"{minutes} min";
        var hours = minutes / 60;
        var mins = minutes % 60;
        return mins > 0 ? $"{hours}h {mins}m" : $"{hours}h";
    }

    /// <summary>
    /// Get subtitle tracks from lesson data, converting Shared DTO to VideoPlayer.SubtitleTrack
    /// </summary>
    private List<VideoPlayer.SubtitleTrack>? GetSubtitleTracks()
    {
        if (lesson?.SubtitleTracks == null || !lesson.SubtitleTracks.Any())
            return null;

        return lesson.SubtitleTracks.Select(t => new VideoPlayer.SubtitleTrack
        {
            Url = t.Url,
            Language = t.Language,
            Label = t.Label,
            Kind = t.Kind,
            IsDefault = t.IsDefault
        }).ToList();
    }

    /// <summary>
    /// Get user's preferred language for subtitles (defaults to browser language or "en")
    /// </summary>
    private string GetUserLanguage()
    {
        // Could be enhanced to read from user preferences or browser settings
        // For now, return Italian as default for the Italian user base
        return "it";
    }

    /// <summary>
    /// Check if the current lesson has exercise files (attachment)
    /// </summary>
    private bool HasExerciseFiles()
    {
        // Check lesson attachment URL
        return !string.IsNullOrEmpty(lesson?.AttachmentUrl);
    }

    /// <summary>
    /// Get the count of exercise files for the badge
    /// </summary>
    private int GetExerciseFileCount()
    {
        // Currently only counts the main attachment
        return !string.IsNullOrEmpty(lesson?.AttachmentUrl) ? 1 : 0;
    }
}
