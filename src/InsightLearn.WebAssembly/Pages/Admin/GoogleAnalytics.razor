@page "/admin/google-analytics"
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager Navigation
@inject IToastService Toast
@using Microsoft.AspNetCore.Authorization

<PageTitle>Google Analytics - InsightLearn Admin</PageTitle>

<div class="dashboard-layout">
    <div class="breadcrumb-nav">
        <nav class="breadcrumb">
            <a href="/" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/admin" class="breadcrumb-item">Admin</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Google Analytics</span>
        </nav>
    </div>

    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fab fa-google" style="color: #4285f4;"></i>
                Google Analytics
            </h1>
            <p class="page-description">Track and analyze website traffic with Google Analytics 4</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" @onclick="RefreshData" disabled="@isLoading">
                <i class="fas fa-sync-alt @(isLoading ? "fa-spin" : "")"></i>
                Refresh
            </button>
            <button class="btn btn-primary" @onclick="SaveSettings" disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="spinner spinner-sm"></span>
                }
                else
                {
                    <i class="fas fa-save"></i>
                }
                Save Settings
            </button>
        </div>
    </div>

    <!-- Google Analytics Configuration -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-cog"></i> Analytics Configuration</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="measurementId">Measurement ID (GA4)</label>
                <input type="text" id="measurementId" class="form-control" @bind="measurementId" placeholder="G-XXXXXXXXXX" />
                <small class="form-text text-muted">Your Google Analytics 4 Measurement ID (starts with G-)</small>
            </div>

            <div class="form-group mt-3">
                <label for="streamId">Data Stream ID</label>
                <input type="text" id="streamId" class="form-control" @bind="streamId" placeholder="1234567890" />
                <small class="form-text text-muted">Your GA4 data stream ID for API access</small>
            </div>

            <div class="form-check mt-3">
                <input type="checkbox" class="form-check-input" id="enableTracking" @bind="enableTracking" />
                <label class="form-check-label" for="enableTracking">
                    Enable Google Analytics tracking
                </label>
            </div>

            <div class="form-check mt-2">
                <input type="checkbox" class="form-check-input" id="anonymizeIp" @bind="anonymizeIp" />
                <label class="form-check-label" for="anonymizeIp">
                    Anonymize IP addresses (GDPR compliance)
                </label>
            </div>
        </div>
    </div>

    <!-- Real-time Overview (Placeholder) -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-chart-line"></i> Real-time Overview</h3>
        </div>
        <div class="card-body">
            @if (isLoading)
            {
                <div class="loading-state">
                    <div class="spinner spinner-lg"></div>
                    <p>Loading analytics data...</p>
                </div>
            }
            else
            {
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4285f4, #34a853);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">@activeUsers</span>
                            <span class="stat-label">Active Users (30 min)</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ea4335, #fbbc05);">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">@pageviews</span>
                            <span class="stat-label">Pageviews Today</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #34a853, #4285f4);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">@avgSessionDuration</span>
                            <span class="stat-label">Avg Session Duration</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fbbc05, #ea4335);">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-value">@bounceRate%</span>
                            <span class="stat-label">Bounce Rate</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Top Pages -->
    <div class="card mb-4">
        <div class="card-header">
            <h3><i class="fas fa-file-alt"></i> Top Pages (Last 7 Days)</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Page</th>
                        <th>Views</th>
                        <th>Unique Views</th>
                        <th>Avg. Time</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pageItem in topPages)
                    {
                        <tr>
                            <td>@pageItem.Path</td>
                            <td>@pageItem.Views.ToString("N0")</td>
                            <td>@pageItem.UniqueViews.ToString("N0")</td>
                            <td>@pageItem.AvgTime</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Traffic Sources -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-globe"></i> Traffic Sources</h3>
        </div>
        <div class="card-body">
            <div class="traffic-sources">
                @foreach (var source in trafficSources)
                {
                    <div class="source-item">
                        <div class="source-info">
                            <i class="@source.Icon" style="color: @source.Color;"></i>
                            <span class="source-name">@source.Name</span>
                        </div>
                        <div class="source-bar-container">
                            <div class="source-bar" style="width: @source.Percentage%; background: @source.Color;"></div>
                        </div>
                        <span class="source-percentage">@source.Percentage%</span>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
    }

    .stat-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.8125rem;
        color: #64748b;
    }

    .traffic-sources {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .source-item {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .source-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 140px;
    }

    .source-name {
        font-weight: 500;
        color: #1e293b;
    }

    .source-bar-container {
        flex: 1;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .source-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .source-percentage {
        min-width: 50px;
        text-align: right;
        font-weight: 600;
        color: #475569;
    }
</style>

@code {
    private bool isLoading = false;
    private bool isSaving = false;

    // Configuration
    private string measurementId = "G-";
    private string streamId = "";
    private bool enableTracking = true;
    private bool anonymizeIp = true;

    // Analytics Data (simulated)
    private int activeUsers = 47;
    private int pageviews = 3245;
    private string avgSessionDuration = "4:32";
    private double bounceRate = 42.3;

    private List<PageStats> topPages = new();
    private List<TrafficSource> trafficSources = new();

    protected override void OnInitialized()
    {
        LoadSampleData();
    }

    private void LoadSampleData()
    {
        topPages = new List<PageStats>
        {
            new() { Path = "/", Views = 1234, UniqueViews = 987, AvgTime = "2:45" },
            new() { Path = "/courses", Views = 856, UniqueViews = 654, AvgTime = "3:12" },
            new() { Path = "/login", Views = 543, UniqueViews = 432, AvgTime = "1:23" },
            new() { Path = "/register", Views = 321, UniqueViews = 298, AvgTime = "2:56" },
            new() { Path = "/courses/development", Views = 287, UniqueViews = 234, AvgTime = "4:15" }
        };

        trafficSources = new List<TrafficSource>
        {
            new() { Name = "Organic Search", Percentage = 45, Icon = "fab fa-google", Color = "#4285f4" },
            new() { Name = "Direct", Percentage = 28, Icon = "fas fa-link", Color = "#34a853" },
            new() { Name = "Social Media", Percentage = 15, Icon = "fas fa-share-alt", Color = "#ea4335" },
            new() { Name = "Referral", Percentage = 8, Icon = "fas fa-external-link-alt", Color = "#fbbc05" },
            new() { Name = "Email", Percentage = 4, Icon = "fas fa-envelope", Color = "#9333ea" }
        };
    }

    private async Task RefreshData()
    {
        isLoading = true;
        StateHasChanged();

        await Task.Delay(1000); // Simulate API call
        LoadSampleData();

        isLoading = false;
        StateHasChanged();
    }

    private async Task SaveSettings()
    {
        isSaving = true;
        StateHasChanged();

        await Task.Delay(1000); // Simulate API call

        isSaving = false;
        Toast.ShowSuccess("Google Analytics settings saved successfully!");
        StateHasChanged();
    }

    private class PageStats
    {
        public string Path { get; set; } = "";
        public int Views { get; set; }
        public int UniqueViews { get; set; }
        public string AvgTime { get; set; } = "";
    }

    private class TrafficSource
    {
        public string Name { get; set; } = "";
        public int Percentage { get; set; }
        public string Icon { get; set; } = "";
        public string Color { get; set; } = "";
    }
}
