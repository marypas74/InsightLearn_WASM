@page "/admin/auth/diagnostics"
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager Navigation
@inject IApiClient ApiClient
@inject IToastService Toast
@using Microsoft.AspNetCore.Authorization
@using InsightLearn.WebAssembly.Services.Http

<PageTitle>Auth Diagnostics - InsightLearn Admin</PageTitle>

<div class="auth-diagnostics-page">
    <div class="breadcrumb-nav">
        <nav class="breadcrumb">
            <a href="/" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/admin" class="breadcrumb-item">Admin</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Auth Diagnostics</span>
        </nav>
    </div>

    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <span class="title-icon">üîê</span>
                Auth Diagnostics
            </h1>
            <p class="page-description">Authentication & authorization debugging tools</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" @onclick="RefreshAll" disabled="@isLoading">
                <i class="fas fa-sync-alt @(isLoading ? "fa-spin" : "")"></i>
                Refresh All
            </button>
            <button class="btn btn-outline" @onclick="ExportDiagnostics">
                <i class="fas fa-download"></i>
                Export Report
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner spinner-lg"></div>
            <p>Running diagnostics...</p>
        </div>
    }
    else if (error != null)
    {
        <div class="error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>@error</h3>
            <button class="btn btn-primary" @onclick="LoadData">Retry</button>
        </div>
    }
    else
    {
        <!-- System Health Overview -->
        <div class="health-overview">
            <div class="health-card @(systemHealth?.OverallStatus == "Healthy" ? "healthy" : systemHealth?.OverallStatus == "Degraded" ? "degraded" : "unhealthy")">
                <div class="health-icon">
                    @if (systemHealth?.OverallStatus == "Healthy")
                    {
                        <i class="fas fa-check-circle"></i>
                    }
                    else if (systemHealth?.OverallStatus == "Degraded")
                    {
                        <i class="fas fa-exclamation-circle"></i>
                    }
                    else
                    {
                        <i class="fas fa-times-circle"></i>
                    }
                </div>
                <div class="health-info">
                    <span class="health-status">@systemHealth?.OverallStatus</span>
                    <span class="health-label">System Status</span>
                </div>
            </div>
            <div class="health-card @(systemHealth?.JwtStatus == "Valid" ? "healthy" : "unhealthy")">
                <div class="health-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="health-info">
                    <span class="health-status">@systemHealth?.JwtStatus</span>
                    <span class="health-label">JWT Configuration</span>
                </div>
            </div>
            <div class="health-card @(systemHealth?.OAuthStatus == "Connected" ? "healthy" : systemHealth?.OAuthStatus == "Partial" ? "degraded" : "unhealthy")">
                <div class="health-icon">
                    <i class="fas fa-plug"></i>
                </div>
                <div class="health-info">
                    <span class="health-status">@systemHealth?.OAuthStatus</span>
                    <span class="health-label">OAuth Providers</span>
                </div>
            </div>
            <div class="health-card @(systemHealth?.RedisStatus == "Connected" ? "healthy" : "unhealthy")">
                <div class="health-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="health-info">
                    <span class="health-status">@systemHealth?.RedisStatus</span>
                    <span class="health-label">Session Store</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2 class="section-title">Quick Actions</h2>
            <div class="actions-grid">
                <button class="action-card" @onclick="TestJwtValidation">
                    <div class="action-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <span class="action-label">Test JWT Validation</span>
                </button>
                <button class="action-card" @onclick="TestApiConnection">
                    <div class="action-icon">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <span class="action-label">Test API Connection</span>
                </button>
                <button class="action-card" @onclick="TestTokenRefresh">
                    <div class="action-icon">
                        <i class="fas fa-redo"></i>
                    </div>
                    <span class="action-label">Test Token Refresh</span>
                </button>
                <button class="action-card" @onclick="ClearAuthCache">
                    <div class="action-icon">
                        <i class="fas fa-broom"></i>
                    </div>
                    <span class="action-label">Clear Auth Cache</span>
                </button>
                <button class="action-card" @onclick="ToggleTokenInspector">
                    <div class="action-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <span class="action-label">Token Inspector</span>
                </button>
                <button class="action-card" @onclick="ViewLoginAttempts">
                    <div class="action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <span class="action-label">Login History</span>
                </button>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="diagnostics-grid">
            <!-- JWT Token Info -->
            <div class="diag-card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-id-badge"></i>
                        Current Token Info
                    </h3>
                    <span class="badge @(tokenInfo?.IsValid == true ? "badge-success" : "badge-danger")">
                        @(tokenInfo?.IsValid == true ? "Valid" : "Invalid")
                    </span>
                </div>
                <div class="card-content">
                    @if (tokenInfo != null)
                    {
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">User ID</span>
                                <span class="info-value monospace">@tokenInfo.UserId</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email</span>
                                <span class="info-value">@tokenInfo.Email</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Roles</span>
                                <span class="info-value">
                                    @foreach (var role in tokenInfo.Roles)
                                    {
                                        <span class="role-badge">@role</span>
                                    }
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Issued At</span>
                                <span class="info-value">@tokenInfo.IssuedAt?.ToString("yyyy-MM-dd HH:mm:ss")</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Expires At</span>
                                <span class="info-value @(tokenInfo.ExpiresAt < DateTime.UtcNow.AddMinutes(30) ? "text-warning" : "")">
                                    @tokenInfo.ExpiresAt?.ToString("yyyy-MM-dd HH:mm:ss")
                                    @if (tokenInfo.ExpiresAt.HasValue)
                                    {
                                        var remaining = tokenInfo.ExpiresAt.Value - DateTime.UtcNow;
                                        <small class="time-remaining">(@FormatTimeRemaining(remaining))</small>
                                    }
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Issuer</span>
                                <span class="info-value">@tokenInfo.Issuer</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Audience</span>
                                <span class="info-value">@tokenInfo.Audience</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="no-data">No token information available</div>
                    }
                </div>
            </div>

            <!-- Auth Configuration -->
            <div class="diag-card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-cogs"></i>
                        Auth Configuration
                    </h3>
                </div>
                <div class="card-content">
                    <div class="config-list">
                        @foreach (var config in authConfig)
                        {
                            <div class="config-item">
                                <div class="config-icon @(config.IsValid ? "valid" : "invalid")">
                                    <i class="fas @(config.IsValid ? "fa-check" : "fa-times")"></i>
                                </div>
                                <div class="config-info">
                                    <span class="config-name">@config.Name</span>
                                    <span class="config-value">@config.Value</span>
                                </div>
                                @if (!string.IsNullOrEmpty(config.Warning))
                                {
                                    <span class="config-warning" title="@config.Warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </span>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- OAuth Providers -->
            <div class="diag-card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-link"></i>
                        OAuth Providers
                    </h3>
                </div>
                <div class="card-content">
                    <div class="provider-list">
                        @foreach (var provider in oauthProviders)
                        {
                            <div class="provider-item">
                                <div class="provider-icon @provider.Name.ToLower()">
                                    <i class="fab fa-@provider.Name.ToLower()"></i>
                                </div>
                                <div class="provider-info">
                                    <span class="provider-name">@provider.Name</span>
                                    <span class="provider-status @provider.Status.ToLower()">@provider.Status</span>
                                </div>
                                <div class="provider-meta">
                                    <span class="provider-logins">@provider.TotalLogins logins</span>
                                    <span class="provider-last">Last: @provider.LastUsed?.ToString("MMM d")</span>
                                </div>
                                <button class="btn btn-sm btn-outline" @onclick="() => TestOAuthProvider(provider.Name)" title="Test Connection">
                                    <i class="fas fa-plug"></i>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Recent Login Attempts -->
            <div class="diag-card full-width">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-sign-in-alt"></i>
                        Recent Login Attempts
                    </h3>
                    <div class="header-actions">
                        <select class="filter-select" @bind="loginFilterStatus">
                            <option value="">All Status</option>
                            <option value="Success">Success</option>
                            <option value="Failed">Failed</option>
                            <option value="Locked">Locked</option>
                        </select>
                        <button class="btn btn-sm btn-outline" @onclick="ViewAllLoginAttempts">View All</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="login-attempts-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Email</th>
                                    <th>IP Address</th>
                                    <th>Location</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var attempt in filteredLoginAttempts)
                                {
                                    <tr class="@attempt.Status.ToLower()">
                                        <td class="time-cell">
                                            <span class="time">@attempt.Timestamp.ToString("HH:mm:ss")</span>
                                            <span class="date">@attempt.Timestamp.ToString("MMM d")</span>
                                        </td>
                                        <td class="email-cell">
                                            <span class="email">@attempt.Email</span>
                                        </td>
                                        <td class="ip-cell monospace">@attempt.IpAddress</td>
                                        <td class="location-cell">
                                            <i class="fas fa-map-marker-alt"></i>
                                            @attempt.Location
                                        </td>
                                        <td class="method-cell">
                                            <span class="method-badge @attempt.Method.ToLower()">@attempt.Method</span>
                                        </td>
                                        <td class="status-cell">
                                            <span class="status-badge @attempt.Status.ToLower()">
                                                @if (attempt.Status == "Success")
                                                {
                                                    <i class="fas fa-check"></i>
                                                }
                                                else if (attempt.Status == "Failed")
                                                {
                                                    <i class="fas fa-times"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-lock"></i>
                                                }
                                                @attempt.Status
                                            </span>
                                        </td>
                                        <td class="details-cell">
                                            <button class="btn btn-icon" @onclick="() => ViewAttemptDetails(attempt)" title="View Details">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Active Sessions -->
            <div class="diag-card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-desktop"></i>
                        Active Sessions
                    </h3>
                    <span class="badge badge-info">@activeSessions.Count active</span>
                </div>
                <div class="card-content">
                    <div class="sessions-list">
                        @foreach (var session in activeSessions)
                        {
                            <div class="session-item @(session.IsCurrent ? "current" : "")">
                                <div class="session-icon">
                                    <i class="fas @GetDeviceIcon(session.DeviceType)"></i>
                                </div>
                                <div class="session-info">
                                    <span class="session-device">@session.DeviceType - @session.Browser</span>
                                    <span class="session-details">
                                        @session.IpAddress ‚Ä¢ @session.Location
                                    </span>
                                    <span class="session-time">
                                        Last active: @FormatLastActive(session.LastActive)
                                    </span>
                                </div>
                                @if (session.IsCurrent)
                                {
                                    <span class="current-badge">Current</span>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-danger" @onclick="() => RevokeSession(session.SessionId)" title="Revoke Session">
                                        <i class="fas fa-times"></i>
                                    </button>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Security Events -->
            <div class="diag-card">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-shield-alt"></i>
                        Security Events
                    </h3>
                    <span class="badge badge-warning">@securityEvents.Count(e => !e.IsResolved) unresolved</span>
                </div>
                <div class="card-content">
                    <div class="events-list">
                        @if (securityEvents.Any())
                        {
                            @foreach (var evt in securityEvents.Take(5))
                            {
                                <div class="event-item @evt.Severity.ToLower()">
                                    <div class="event-icon">
                                        <i class="fas @GetSeverityIcon(evt.Severity)"></i>
                                    </div>
                                    <div class="event-info">
                                        <span class="event-title">@evt.Title</span>
                                        <span class="event-description">@evt.Description</span>
                                        <span class="event-time">@evt.Timestamp.ToString("MMM d, HH:mm")</span>
                                    </div>
                                    @if (!evt.IsResolved)
                                    {
                                        <button class="btn btn-sm btn-outline" @onclick="() => ResolveEvent(evt.Id)">
                                            Resolve
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="resolved-badge">
                                            <i class="fas fa-check"></i> Resolved
                                        </span>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-events">
                                <i class="fas fa-check-circle"></i>
                                <span>No security events</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Token Inspector Modal -->
        @if (showTokenInspector)
        {
            <div class="modal-backdrop" @onclick="() => showTokenInspector = false">
                <div class="modal-dialog large" @onclick:stopPropagation>
                    <div class="modal-header">
                        <h3>
                            <i class="fas fa-search"></i>
                            Token Inspector
                        </h3>
                        <button class="btn btn-icon" @onclick="() => showTokenInspector = false">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="token-inspector">
                            <div class="token-input-section">
                                <label>Paste JWT Token to Inspect</label>
                                <textarea @bind="inspectorToken" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." rows="4"></textarea>
                                <button class="btn btn-primary" @onclick="InspectToken" disabled="@string.IsNullOrEmpty(inspectorToken)">
                                    <i class="fas fa-search"></i>
                                    Inspect Token
                                </button>
                            </div>

                            @if (inspectedToken != null)
                            {
                                <div class="token-parts">
                                    <div class="token-part header">
                                        <h4>Header</h4>
                                        <pre>@inspectedToken.HeaderJson</pre>
                                    </div>
                                    <div class="token-part payload">
                                        <h4>Payload</h4>
                                        <pre>@inspectedToken.PayloadJson</pre>
                                    </div>
                                    <div class="token-validation">
                                        <h4>Validation</h4>
                                        <div class="validation-results">
                                            <div class="validation-item @(inspectedToken.SignatureValid ? "valid" : "invalid")">
                                                <i class="fas @(inspectedToken.SignatureValid ? "fa-check-circle" : "fa-times-circle")"></i>
                                                <span>Signature: @(inspectedToken.SignatureValid ? "Valid" : "Invalid")</span>
                                            </div>
                                            <div class="validation-item @(!inspectedToken.IsExpired ? "valid" : "invalid")">
                                                <i class="fas @(!inspectedToken.IsExpired ? "fa-check-circle" : "fa-times-circle")"></i>
                                                <span>Expiration: @(!inspectedToken.IsExpired ? "Valid" : "Expired")</span>
                                            </div>
                                            <div class="validation-item @(inspectedToken.IssuerValid ? "valid" : "invalid")">
                                                <i class="fas @(inspectedToken.IssuerValid ? "fa-check-circle" : "fa-times-circle")"></i>
                                                <span>Issuer: @(inspectedToken.IssuerValid ? "Valid" : "Invalid")</span>
                                            </div>
                                            <div class="validation-item @(inspectedToken.AudienceValid ? "valid" : "invalid")">
                                                <i class="fas @(inspectedToken.AudienceValid ? "fa-check-circle" : "fa-times-circle")"></i>
                                                <span>Audience: @(inspectedToken.AudienceValid ? "Valid" : "Invalid")</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Test Results Panel -->
        @if (showTestResults)
        {
            <div class="modal-backdrop" @onclick="() => showTestResults = false">
                <div class="modal-dialog" @onclick:stopPropagation>
                    <div class="modal-header">
                        <h3>
                            <i class="fas fa-flask"></i>
                            Test Results
                        </h3>
                        <button class="btn btn-icon" @onclick="() => showTestResults = false">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="test-results">
                            @foreach (var result in testResults)
                            {
                                <div class="test-result @(result.Success ? "success" : "failure")">
                                    <div class="result-icon">
                                        <i class="fas @(result.Success ? "fa-check-circle" : "fa-times-circle")"></i>
                                    </div>
                                    <div class="result-info">
                                        <span class="result-name">@result.TestName</span>
                                        <span class="result-message">@result.Message</span>
                                        <span class="result-duration">@result.Duration.TotalMilliseconds.ToString("F0")ms</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" @onclick="() => showTestResults = false">Close</button>
                    </div>
                </div>
            </div>
        }

        <!-- Login Attempt Details Modal -->
        @if (showAttemptDetails && selectedAttempt != null)
        {
            <div class="modal-backdrop" @onclick="CloseAttemptDetails">
                <div class="modal-dialog" @onclick:stopPropagation>
                    <div class="modal-header">
                        <h3>
                            <i class="fas fa-info-circle"></i>
                            Login Attempt Details
                        </h3>
                        <button class="btn btn-icon" @onclick="CloseAttemptDetails">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="attempt-details">
                            <div class="detail-row">
                                <span class="label">Timestamp</span>
                                <span class="value">@selectedAttempt.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Email</span>
                                <span class="value">@selectedAttempt.Email</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">IP Address</span>
                                <span class="value monospace">@selectedAttempt.IpAddress</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Location</span>
                                <span class="value">@selectedAttempt.Location</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">User Agent</span>
                                <span class="value">@selectedAttempt.UserAgent</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Method</span>
                                <span class="value">
                                    <span class="method-badge @selectedAttempt.Method.ToLower()">@selectedAttempt.Method</span>
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Status</span>
                                <span class="value">
                                    <span class="status-badge @selectedAttempt.Status.ToLower()">@selectedAttempt.Status</span>
                                </span>
                            </div>
                            @if (!string.IsNullOrEmpty(selectedAttempt.FailureReason))
                            {
                                <div class="detail-row">
                                    <span class="label">Failure Reason</span>
                                    <span class="value error-text">@selectedAttempt.FailureReason</span>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        @if (selectedAttempt.Status != "Locked")
                        {
                            <button class="btn btn-danger" @onclick="() => BlockIpAddress(selectedAttempt.IpAddress)">
                                <i class="fas fa-ban"></i>
                                Block IP
                            </button>
                        }
                        <button class="btn btn-outline" @onclick="CloseAttemptDetails">Close</button>
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .auth-diagnostics-page {
        padding: 24px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .breadcrumb-nav {
        margin-bottom: 16px;
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .breadcrumb-item {
        color: #64748b;
        text-decoration: none;
    }

    .breadcrumb-item:hover {
        color: #0073b1;
    }

    .breadcrumb-item.active {
        color: #1e293b;
        font-weight: 500;
    }

    .breadcrumb-separator {
        color: #cbd5e1;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .title-icon {
        font-size: 32px;
    }

    .page-description {
        color: #64748b;
        margin: 8px 0 0 0;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    /* Health Overview */
    .health-overview {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .health-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #94a3b8;
    }

    .health-card.healthy {
        border-left-color: #10b981;
    }

    .health-card.degraded {
        border-left-color: #f59e0b;
    }

    .health-card.unhealthy {
        border-left-color: #ef4444;
    }

    .health-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: #f1f5f9;
        color: #64748b;
    }

    .health-card.healthy .health-icon {
        background: #d1fae5;
        color: #10b981;
    }

    .health-card.degraded .health-icon {
        background: #fef3c7;
        color: #f59e0b;
    }

    .health-card.unhealthy .health-icon {
        background: #fee2e2;
        color: #ef4444;
    }

    .health-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .health-status {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
    }

    .health-label {
        font-size: 13px;
        color: #64748b;
    }

    /* Quick Actions */
    .quick-actions {
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 16px;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
    }

    .action-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .action-card:hover {
        border-color: #0073b1;
        box-shadow: 0 4px 12px rgba(0, 115, 177, 0.15);
        transform: translateY(-2px);
    }

    .action-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #0073b1 0%, #005582 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
    }

    .action-label {
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        text-align: center;
    }

    /* Diagnostics Grid */
    .diagnostics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .diag-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .diag-card.full-width {
        grid-column: 1 / -1;
    }

    .diag-card .card-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .diag-card .card-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .diag-card .card-header h3 i {
        color: #0073b1;
    }

    .diag-card .card-content {
        padding: 20px;
    }

    /* Info Grid */
    .info-grid {
        display: grid;
        gap: 16px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-label {
        font-size: 12px;
        font-weight: 500;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 14px;
        color: #1e293b;
    }

    .info-value.monospace {
        font-family: 'Fira Code', monospace;
    }

    .role-badge {
        display: inline-block;
        padding: 2px 8px;
        background: #dbeafe;
        color: #1d4ed8;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-right: 4px;
    }

    .time-remaining {
        color: #64748b;
        margin-left: 8px;
    }

    .text-warning {
        color: #f59e0b;
    }

    /* Config List */
    .config-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .config-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
    }

    .config-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .config-icon.valid {
        background: #d1fae5;
        color: #10b981;
    }

    .config-icon.invalid {
        background: #fee2e2;
        color: #ef4444;
    }

    .config-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .config-name {
        font-size: 14px;
        font-weight: 500;
        color: #1e293b;
    }

    .config-value {
        font-size: 12px;
        color: #64748b;
    }

    .config-warning {
        color: #f59e0b;
    }

    /* Provider List */
    .provider-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .provider-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
    }

    .provider-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
    }

    .provider-icon.google {
        background: #ea4335;
    }

    .provider-icon.microsoft {
        background: #00a4ef;
    }

    .provider-icon.github {
        background: #24292e;
    }

    .provider-icon.linkedin {
        background: #0077b5;
    }

    .provider-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .provider-name {
        font-size: 14px;
        font-weight: 500;
        color: #1e293b;
    }

    .provider-status {
        font-size: 12px;
        font-weight: 500;
    }

    .provider-status.connected {
        color: #10b981;
    }

    .provider-status.disconnected {
        color: #ef4444;
    }

    .provider-status.partial {
        color: #f59e0b;
    }

    .provider-meta {
        display: flex;
        flex-direction: column;
        gap: 2px;
        text-align: right;
    }

    .provider-logins,
    .provider-last {
        font-size: 12px;
        color: #64748b;
    }

    /* Login Attempts Table */
    .login-attempts-table {
        overflow-x: auto;
    }

    .login-attempts-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .login-attempts-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    .login-attempts-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f5f9;
    }

    .login-attempts-table tr:hover {
        background: #f8fafc;
    }

    .time-cell {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .time-cell .time {
        font-weight: 500;
        color: #1e293b;
    }

    .time-cell .date {
        font-size: 12px;
        color: #64748b;
    }

    .email-cell .email {
        font-size: 14px;
        color: #1e293b;
    }

    .ip-cell {
        font-family: 'Fira Code', monospace;
        font-size: 13px;
        color: #64748b;
    }

    .location-cell {
        font-size: 13px;
        color: #64748b;
    }

    .location-cell i {
        margin-right: 4px;
        color: #94a3b8;
    }

    .method-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .method-badge.password {
        background: #e0e7ff;
        color: #4338ca;
    }

    .method-badge.oauth {
        background: #dcfce7;
        color: #16a34a;
    }

    .method-badge.token {
        background: #fef3c7;
        color: #d97706;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-badge.success {
        background: #d1fae5;
        color: #059669;
    }

    .status-badge.failed {
        background: #fee2e2;
        color: #dc2626;
    }

    .status-badge.locked {
        background: #fef3c7;
        color: #d97706;
    }

    /* Sessions List */
    .sessions-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .session-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        border: 2px solid transparent;
    }

    .session-item.current {
        border-color: #0073b1;
        background: #f0f9ff;
    }

    .session-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #64748b;
    }

    .session-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .session-device {
        font-size: 14px;
        font-weight: 500;
        color: #1e293b;
    }

    .session-details,
    .session-time {
        font-size: 12px;
        color: #64748b;
    }

    .current-badge {
        padding: 4px 12px;
        background: #0073b1;
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    /* Events List */
    .events-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .event-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        border-radius: 8px;
        background: #f8fafc;
        border-left: 3px solid;
    }

    .event-item.high {
        border-left-color: #ef4444;
        background: #fef2f2;
    }

    .event-item.medium {
        border-left-color: #f59e0b;
        background: #fffbeb;
    }

    .event-item.low {
        border-left-color: #3b82f6;
        background: #eff6ff;
    }

    .event-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .event-item.high .event-icon {
        background: #fee2e2;
        color: #ef4444;
    }

    .event-item.medium .event-icon {
        background: #fef3c7;
        color: #f59e0b;
    }

    .event-item.low .event-icon {
        background: #dbeafe;
        color: #3b82f6;
    }

    .event-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .event-title {
        font-size: 14px;
        font-weight: 500;
        color: #1e293b;
    }

    .event-description {
        font-size: 13px;
        color: #64748b;
    }

    .event-time {
        font-size: 12px;
        color: #94a3b8;
    }

    .resolved-badge {
        font-size: 12px;
        color: #10b981;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .no-events {
        text-align: center;
        padding: 32px;
        color: #10b981;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .no-events i {
        font-size: 32px;
    }

    /* Modal Styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-dialog {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 560px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-dialog.large {
        max-width: 800px;
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-header h3 i {
        color: #0073b1;
    }

    .modal-content {
        padding: 24px;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    /* Token Inspector */
    .token-inspector {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .token-input-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .token-input-section label {
        font-size: 14px;
        font-weight: 500;
        color: #475569;
    }

    .token-input-section textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-family: 'Fira Code', monospace;
        font-size: 13px;
        resize: vertical;
    }

    .token-parts {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .token-part {
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .token-part.header {
        background: #fef3c7;
        border-color: #fcd34d;
    }

    .token-part.payload {
        background: #dbeafe;
        border-color: #93c5fd;
    }

    .token-part h4 {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        margin: 0 0 12px 0;
        text-transform: uppercase;
    }

    .token-part pre {
        margin: 0;
        font-family: 'Fira Code', monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .token-validation {
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
    }

    .validation-results {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .validation-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .validation-item.valid {
        color: #10b981;
    }

    .validation-item.invalid {
        color: #ef4444;
    }

    /* Test Results */
    .test-results {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .test-result {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 8px;
        background: #f8fafc;
    }

    .test-result.success {
        background: #f0fdf4;
        border-left: 3px solid #10b981;
    }

    .test-result.failure {
        background: #fef2f2;
        border-left: 3px solid #ef4444;
    }

    .result-icon {
        font-size: 20px;
    }

    .test-result.success .result-icon {
        color: #10b981;
    }

    .test-result.failure .result-icon {
        color: #ef4444;
    }

    .result-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .result-name {
        font-size: 14px;
        font-weight: 500;
        color: #1e293b;
    }

    .result-message {
        font-size: 13px;
        color: #64748b;
    }

    .result-duration {
        font-size: 12px;
        color: #94a3b8;
    }

    /* Attempt Details */
    .attempt-details {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .detail-row {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-row .label {
        font-size: 12px;
        font-weight: 500;
        color: #64748b;
        text-transform: uppercase;
    }

    .detail-row .value {
        font-size: 14px;
        color: #1e293b;
    }

    .detail-row .value.monospace {
        font-family: 'Fira Code', monospace;
    }

    .error-text {
        color: #ef4444;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: #0073b1;
        color: white;
    }

    .btn-primary:hover {
        background: #005582;
    }

    .btn-outline {
        background: white;
        border: 1px solid #e2e8f0;
        color: #475569;
    }

    .btn-outline:hover {
        border-color: #0073b1;
        color: #0073b1;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        border-radius: 6px;
        background: transparent;
        border: none;
        color: #64748b;
        cursor: pointer;
    }

    .btn-icon:hover {
        background: #f1f5f9;
        color: #0073b1;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Badges */
    .badge {
        display: inline-block;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 20px;
    }

    .badge-success {
        background: #d1fae5;
        color: #059669;
    }

    .badge-danger {
        background: #fee2e2;
        color: #dc2626;
    }

    .badge-warning {
        background: #fef3c7;
        color: #d97706;
    }

    .badge-info {
        background: #dbeafe;
        color: #2563eb;
    }

    /* Filter Select */
    .filter-select {
        padding: 6px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 13px;
        color: #475569;
        background: white;
    }

    /* Loading State */
    .loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 40px;
        text-align: center;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e2e8f0;
        border-top-color: #0073b1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .spinner-lg {
        width: 48px;
        height: 48px;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .no-data {
        text-align: center;
        padding: 32px;
        color: #94a3b8;
    }

    /* Responsive */
    @@media (max-width: 1200px) {
        .health-overview {
            grid-template-columns: repeat(2, 1fr);
        }

        .actions-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .auth-diagnostics-page {
            padding: 16px;
        }

        .page-header {
            flex-direction: column;
            gap: 16px;
        }

        .health-overview {
            grid-template-columns: 1fr;
        }

        .actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .diagnostics-grid {
            grid-template-columns: 1fr;
        }

        .login-attempts-table {
            font-size: 13px;
        }
    }
</style>

@code {
    private bool isLoading = true;
    private string? error;

    // System health
    private SystemHealth? systemHealth;

    // Token info
    private TokenInfo? tokenInfo;

    // Auth config
    private List<AuthConfigItem> authConfig = new();

    // OAuth providers
    private List<OAuthProvider> oauthProviders = new();

    // Login attempts
    private List<LoginAttempt> loginAttempts = new();
    private string loginFilterStatus = "";

    // Active sessions
    private List<ActiveSession> activeSessions = new();

    // Security events
    private List<SecurityEvent> securityEvents = new();

    // Token Inspector
    private bool showTokenInspector = false;
    private string inspectorToken = "";
    private InspectedToken? inspectedToken;

    // Test Results
    private bool showTestResults = false;
    private List<TestResult> testResults = new();

    // Attempt Details
    private bool showAttemptDetails = false;
    private LoginAttempt? selectedAttempt;

    private IEnumerable<LoginAttempt> filteredLoginAttempts =>
        string.IsNullOrEmpty(loginFilterStatus)
            ? loginAttempts
            : loginAttempts.Where(a => a.Status == loginFilterStatus);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            error = null;
            StateHasChanged();

            await Task.Delay(300); // Simulated API call

            // Load mock data
            LoadSystemHealth();
            LoadTokenInfo();
            LoadAuthConfig();
            LoadOAuthProviders();
            LoadLoginAttempts();
            LoadActiveSessions();
            LoadSecurityEvents();

            isLoading = false;
        }
        catch (Exception ex)
        {
            error = "An error occurred while loading diagnostics";
            Toast.ShowError(error);
            Console.WriteLine($"AuthDiagnostics error: {ex}");
            isLoading = false;
        }
    }

    private void LoadSystemHealth()
    {
        systemHealth = new SystemHealth
        {
            OverallStatus = "Healthy",
            JwtStatus = "Valid",
            OAuthStatus = "Connected",
            RedisStatus = "Connected"
        };
    }

    private void LoadTokenInfo()
    {
        tokenInfo = new TokenInfo
        {
            IsValid = true,
            UserId = "usr_a1b2c3d4e5f6",
            Email = "admin@insightlearn.cloud",
            Roles = new[] { "Admin", "Instructor" },
            IssuedAt = DateTime.UtcNow.AddHours(-2),
            ExpiresAt = DateTime.UtcNow.AddDays(7).AddHours(-2),
            Issuer = "InsightLearn.Api",
            Audience = "InsightLearn.Users"
        };
    }

    private void LoadAuthConfig()
    {
        authConfig = new List<AuthConfigItem>
        {
            new AuthConfigItem { Name = "JWT Secret", Value = "Configured (64 chars)", IsValid = true },
            new AuthConfigItem { Name = "JWT Issuer", Value = "InsightLearn.Api", IsValid = true },
            new AuthConfigItem { Name = "JWT Audience", Value = "InsightLearn.Users", IsValid = true },
            new AuthConfigItem { Name = "Token Expiration", Value = "7 days", IsValid = true },
            new AuthConfigItem { Name = "Refresh Token", Value = "Enabled", IsValid = true },
            new AuthConfigItem { Name = "CORS Policy", Value = "Configured", IsValid = true },
            new AuthConfigItem { Name = "Rate Limiting", Value = "100 req/min", IsValid = true },
            new AuthConfigItem { Name = "HTTPS Only", Value = "Enabled", IsValid = true, Warning = "Verify SSL cert expiry" }
        };
    }

    private void LoadOAuthProviders()
    {
        oauthProviders = new List<OAuthProvider>
        {
            new OAuthProvider { Name = "Google", Status = "Connected", TotalLogins = 1247, LastUsed = DateTime.Now.AddHours(-1) },
            new OAuthProvider { Name = "Microsoft", Status = "Connected", TotalLogins = 456, LastUsed = DateTime.Now.AddDays(-1) },
            new OAuthProvider { Name = "GitHub", Status = "Disconnected", TotalLogins = 89, LastUsed = DateTime.Now.AddDays(-7) },
            new OAuthProvider { Name = "LinkedIn", Status = "Partial", TotalLogins = 234, LastUsed = DateTime.Now.AddHours(-3) }
        };
    }

    private void LoadLoginAttempts()
    {
        loginAttempts = new List<LoginAttempt>
        {
            new LoginAttempt { Timestamp = DateTime.Now.AddMinutes(-5), Email = "admin@insightlearn.cloud", IpAddress = "192.168.1.100", Location = "Rome, IT", Method = "Password", Status = "Success", UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0" },
            new LoginAttempt { Timestamp = DateTime.Now.AddMinutes(-15), Email = "john.doe@example.com", IpAddress = "45.67.89.123", Location = "London, UK", Method = "OAuth", Status = "Success", UserAgent = "Mozilla/5.0 (Macintosh; Intel Mac OS X) Safari/17.0" },
            new LoginAttempt { Timestamp = DateTime.Now.AddMinutes(-23), Email = "hacker@evil.com", IpAddress = "185.234.72.91", Location = "Unknown", Method = "Password", Status = "Failed", UserAgent = "curl/7.84.0", FailureReason = "Invalid credentials (attempt 3/5)" },
            new LoginAttempt { Timestamp = DateTime.Now.AddMinutes(-45), Email = "jane.smith@example.com", IpAddress = "78.12.34.56", Location = "Paris, FR", Method = "Token", Status = "Success", UserAgent = "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0) Safari/604.1" },
            new LoginAttempt { Timestamp = DateTime.Now.AddHours(-1), Email = "suspicious@test.com", IpAddress = "103.45.67.89", Location = "Beijing, CN", Method = "Password", Status = "Locked", UserAgent = "Python-requests/2.28.0", FailureReason = "Account locked after 5 failed attempts" },
            new LoginAttempt { Timestamp = DateTime.Now.AddHours(-2), Email = "maria.rossi@company.com", IpAddress = "151.22.33.44", Location = "Milan, IT", Method = "OAuth", Status = "Success", UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Edge/120.0" }
        };
    }

    private void LoadActiveSessions()
    {
        activeSessions = new List<ActiveSession>
        {
            new ActiveSession { SessionId = "sess_current", DeviceType = "Desktop", Browser = "Chrome 120", IpAddress = "192.168.1.100", Location = "Rome, IT", LastActive = DateTime.Now, IsCurrent = true },
            new ActiveSession { SessionId = "sess_mobile", DeviceType = "Mobile", Browser = "Safari 17", IpAddress = "78.12.34.56", Location = "Rome, IT", LastActive = DateTime.Now.AddMinutes(-15), IsCurrent = false },
            new ActiveSession { SessionId = "sess_tablet", DeviceType = "Tablet", Browser = "Chrome 119", IpAddress = "192.168.1.101", Location = "Rome, IT", LastActive = DateTime.Now.AddHours(-2), IsCurrent = false }
        };
    }

    private void LoadSecurityEvents()
    {
        securityEvents = new List<SecurityEvent>
        {
            new SecurityEvent { Id = "evt_001", Severity = "High", Title = "Multiple Failed Login Attempts", Description = "5 failed login attempts from IP 185.234.72.91", Timestamp = DateTime.Now.AddMinutes(-30), IsResolved = false },
            new SecurityEvent { Id = "evt_002", Severity = "Medium", Title = "Unusual Login Location", Description = "Login from new location: Beijing, CN", Timestamp = DateTime.Now.AddHours(-1), IsResolved = false },
            new SecurityEvent { Id = "evt_003", Severity = "Low", Title = "Password Changed", Description = "User admin@insightlearn.cloud changed password", Timestamp = DateTime.Now.AddDays(-1), IsResolved = true },
            new SecurityEvent { Id = "evt_004", Severity = "Medium", Title = "OAuth Token Refresh Failure", Description = "GitHub OAuth token refresh failed for 3 users", Timestamp = DateTime.Now.AddDays(-2), IsResolved = true }
        };
    }

    private async Task RefreshAll()
    {
        await LoadData();
        Toast.ShowSuccess("Diagnostics refreshed");
    }

    private async Task ExportDiagnostics()
    {
        Toast.ShowInfo("Generating diagnostics report...");
        await Task.Delay(500);
        Toast.ShowSuccess("Report exported successfully");
    }

    private async Task TestJwtValidation()
    {
        testResults.Clear();
        var sw = System.Diagnostics.Stopwatch.StartNew();

        await Task.Delay(200);
        testResults.Add(new TestResult { TestName = "JWT Signature Validation", Success = true, Message = "Token signature is valid", Duration = TimeSpan.FromMilliseconds(45) });

        await Task.Delay(100);
        testResults.Add(new TestResult { TestName = "Token Expiration Check", Success = true, Message = "Token expires in 6 days, 22 hours", Duration = TimeSpan.FromMilliseconds(12) });

        await Task.Delay(100);
        testResults.Add(new TestResult { TestName = "Issuer Validation", Success = true, Message = "Issuer matches: InsightLearn.Api", Duration = TimeSpan.FromMilliseconds(8) });

        await Task.Delay(100);
        testResults.Add(new TestResult { TestName = "Audience Validation", Success = true, Message = "Audience matches: InsightLearn.Users", Duration = TimeSpan.FromMilliseconds(8) });

        showTestResults = true;
        Toast.ShowSuccess("JWT validation tests completed");
    }

    private async Task TestApiConnection()
    {
        testResults.Clear();

        await Task.Delay(300);
        testResults.Add(new TestResult { TestName = "API Health Check", Success = true, Message = "API is healthy (HTTP 200)", Duration = TimeSpan.FromMilliseconds(127) });

        await Task.Delay(200);
        testResults.Add(new TestResult { TestName = "Auth Endpoint", Success = true, Message = "/api/auth/me responds correctly", Duration = TimeSpan.FromMilliseconds(89) });

        await Task.Delay(150);
        testResults.Add(new TestResult { TestName = "Database Connection", Success = true, Message = "SQL Server connected", Duration = TimeSpan.FromMilliseconds(234) });

        await Task.Delay(100);
        testResults.Add(new TestResult { TestName = "Redis Connection", Success = true, Message = "Redis PING successful", Duration = TimeSpan.FromMilliseconds(23) });

        showTestResults = true;
        Toast.ShowSuccess("API connection tests completed");
    }

    private async Task TestTokenRefresh()
    {
        testResults.Clear();

        await Task.Delay(400);
        testResults.Add(new TestResult { TestName = "Token Refresh Request", Success = true, Message = "New token issued successfully", Duration = TimeSpan.FromMilliseconds(312) });

        await Task.Delay(100);
        testResults.Add(new TestResult { TestName = "Old Token Invalidation", Success = true, Message = "Previous token added to blacklist", Duration = TimeSpan.FromMilliseconds(45) });

        showTestResults = true;
        Toast.ShowSuccess("Token refresh test completed");
    }

    private async Task ClearAuthCache()
    {
        Toast.ShowInfo("Clearing authentication cache...");
        await Task.Delay(500);
        Toast.ShowSuccess("Auth cache cleared successfully");
    }

    private void ToggleTokenInspector()
    {
        showTokenInspector = true;
        inspectedToken = null;
        inspectorToken = "";
    }

    private void InspectToken()
    {
        if (string.IsNullOrEmpty(inspectorToken)) return;

        try
        {
            // Mock token inspection
            inspectedToken = new InspectedToken
            {
                HeaderJson = "{\n  \"alg\": \"HS256\",\n  \"typ\": \"JWT\"\n}",
                PayloadJson = "{\n  \"sub\": \"usr_a1b2c3d4e5f6\",\n  \"email\": \"admin@insightlearn.cloud\",\n  \"roles\": [\"Admin\", \"Instructor\"],\n  \"iat\": 1700000000,\n  \"exp\": 1700604800,\n  \"iss\": \"InsightLearn.Api\",\n  \"aud\": \"InsightLearn.Users\"\n}",
                SignatureValid = true,
                IsExpired = false,
                IssuerValid = true,
                AudienceValid = true
            };
        }
        catch
        {
            Toast.ShowError("Invalid JWT token format");
        }
    }

    private void ViewLoginAttempts()
    {
        Navigation.NavigateTo("/admin/auth/login-history");
    }

    private void ViewAllLoginAttempts()
    {
        Navigation.NavigateTo("/admin/auth/login-history");
    }

    private void ViewAttemptDetails(LoginAttempt attempt)
    {
        selectedAttempt = attempt;
        showAttemptDetails = true;
    }

    private void CloseAttemptDetails()
    {
        showAttemptDetails = false;
        selectedAttempt = null;
    }

    private async Task TestOAuthProvider(string providerName)
    {
        Toast.ShowInfo($"Testing {providerName} connection...");
        await Task.Delay(800);
        Toast.ShowSuccess($"{providerName} connection verified");
    }

    private async Task RevokeSession(string sessionId)
    {
        Toast.ShowInfo("Revoking session...");
        await Task.Delay(500);
        activeSessions.RemoveAll(s => s.SessionId == sessionId);
        Toast.ShowSuccess("Session revoked successfully");
    }

    private async Task ResolveEvent(string eventId)
    {
        var evt = securityEvents.FirstOrDefault(e => e.Id == eventId);
        if (evt != null)
        {
            Toast.ShowInfo("Marking event as resolved...");
            await Task.Delay(300);
            evt.IsResolved = true;
            Toast.ShowSuccess("Security event resolved");
        }
    }

    private async Task BlockIpAddress(string ipAddress)
    {
        Toast.ShowInfo($"Blocking IP address {ipAddress}...");
        await Task.Delay(500);
        Toast.ShowSuccess($"IP address {ipAddress} has been blocked");
        CloseAttemptDetails();
    }

    private string GetDeviceIcon(string deviceType) => deviceType.ToLower() switch
    {
        "desktop" => "fa-desktop",
        "mobile" => "fa-mobile-alt",
        "tablet" => "fa-tablet-alt",
        _ => "fa-question"
    };

    private string GetSeverityIcon(string severity) => severity.ToLower() switch
    {
        "high" => "fa-exclamation-triangle",
        "medium" => "fa-exclamation-circle",
        "low" => "fa-info-circle",
        _ => "fa-bell"
    };

    private string FormatTimeRemaining(TimeSpan remaining)
    {
        if (remaining.TotalDays >= 1)
            return $"{(int)remaining.TotalDays}d {remaining.Hours}h remaining";
        if (remaining.TotalHours >= 1)
            return $"{(int)remaining.TotalHours}h {remaining.Minutes}m remaining";
        if (remaining.TotalMinutes >= 1)
            return $"{(int)remaining.TotalMinutes}m remaining";
        return "expiring soon";
    }

    private string FormatLastActive(DateTime lastActive)
    {
        var diff = DateTime.Now - lastActive;
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        return $"{(int)diff.TotalDays}d ago";
    }

    // Internal Models
    private class SystemHealth
    {
        public string OverallStatus { get; set; } = "";
        public string JwtStatus { get; set; } = "";
        public string OAuthStatus { get; set; } = "";
        public string RedisStatus { get; set; } = "";
    }

    private class TokenInfo
    {
        public bool IsValid { get; set; }
        public string UserId { get; set; } = "";
        public string Email { get; set; } = "";
        public string[] Roles { get; set; } = Array.Empty<string>();
        public DateTime? IssuedAt { get; set; }
        public DateTime? ExpiresAt { get; set; }
        public string Issuer { get; set; } = "";
        public string Audience { get; set; } = "";
    }

    private class AuthConfigItem
    {
        public string Name { get; set; } = "";
        public string Value { get; set; } = "";
        public bool IsValid { get; set; }
        public string? Warning { get; set; }
    }

    private class OAuthProvider
    {
        public string Name { get; set; } = "";
        public string Status { get; set; } = "";
        public int TotalLogins { get; set; }
        public DateTime? LastUsed { get; set; }
    }

    private class LoginAttempt
    {
        public DateTime Timestamp { get; set; }
        public string Email { get; set; } = "";
        public string IpAddress { get; set; } = "";
        public string Location { get; set; } = "";
        public string Method { get; set; } = "";
        public string Status { get; set; } = "";
        public string UserAgent { get; set; } = "";
        public string? FailureReason { get; set; }
    }

    private class ActiveSession
    {
        public string SessionId { get; set; } = "";
        public string DeviceType { get; set; } = "";
        public string Browser { get; set; } = "";
        public string IpAddress { get; set; } = "";
        public string Location { get; set; } = "";
        public DateTime LastActive { get; set; }
        public bool IsCurrent { get; set; }
    }

    private class SecurityEvent
    {
        public string Id { get; set; } = "";
        public string Severity { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public DateTime Timestamp { get; set; }
        public bool IsResolved { get; set; }
    }

    private class InspectedToken
    {
        public string HeaderJson { get; set; } = "";
        public string PayloadJson { get; set; } = "";
        public bool SignatureValid { get; set; }
        public bool IsExpired { get; set; }
        public bool IssuerValid { get; set; }
        public bool AudienceValid { get; set; }
    }

    private class TestResult
    {
        public string TestName { get; set; } = "";
        public bool Success { get; set; }
        public string Message { get; set; } = "";
        public TimeSpan Duration { get; set; }
    }
}
