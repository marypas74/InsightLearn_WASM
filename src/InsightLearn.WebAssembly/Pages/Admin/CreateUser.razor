@page "/admin/users/create"
@attribute [Authorize(Roles = "Admin")]
@inject NavigationManager Navigation
@inject IApiClient ApiClient
@inject Blazored.Toast.Services.IToastService Toast
@using Microsoft.AspNetCore.Authorization
@using InsightLearn.WebAssembly.Services.Http
@using System.ComponentModel.DataAnnotations

<PageTitle>Create User - InsightLearn Admin</PageTitle>

<link href="css/admin-components.css" rel="stylesheet" />

<div class="admin-page-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb-nav">
        <nav class="breadcrumb">
            <a href="/" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/admin" class="breadcrumb-item">Admin</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/admin/users" class="breadcrumb-item">Users</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">Create</span>
        </nav>
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Create User</h1>
            <p class="page-description">Add a new user to the platform</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" @onclick="NavigateBack">
                <i class="fas fa-arrow-left"></i> Back to Users
            </button>
        </div>
    </div>

    <!-- Form Card -->
    <div class="form-card">
        <EditForm Model="@model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <!-- Personal Information Section -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i> Personal Information
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName" class="form-label required">First Name</label>
                        <InputText id="firstName" @bind-Value="model.FirstName" class="form-control" placeholder="Enter first name" />
                        <ValidationMessage For="@(() => model.FirstName)" class="validation-error" />
                    </div>
                    <div class="form-group">
                        <label for="lastName" class="form-label required">Last Name</label>
                        <InputText id="lastName" @bind-Value="model.LastName" class="form-control" placeholder="Enter last name" />
                        <ValidationMessage For="@(() => model.LastName)" class="validation-error" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email" class="form-label required">Email Address</label>
                        <InputText id="email" @bind-Value="model.Email" class="form-control" placeholder="user@example.com" type="email" />
                        <ValidationMessage For="@(() => model.Email)" class="validation-error" />
                    </div>
                    <div class="form-group">
                        <label for="phone" class="form-label">Phone Number</label>
                        <InputText id="phone" @bind-Value="model.PhoneNumber" class="form-control" placeholder="+1 (555) 123-4567" />
                        <ValidationMessage For="@(() => model.PhoneNumber)" class="validation-error" />
                    </div>
                </div>
            </div>

            <!-- Account Settings Section -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-shield-alt"></i> Account Settings
                </h3>

                <div class="form-row">
                    <div class="form-group">
                        <label for="password" class="form-label required">Password</label>
                        <div class="password-input-wrapper">
                            <InputText id="password" @bind-Value="model.Password" class="form-control"
                                       type="@(showPassword ? "text" : "password")" placeholder="Enter password" />
                            <button type="button" class="password-toggle" @onclick="TogglePasswordVisibility">
                                <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                            </button>
                        </div>
                        <ValidationMessage For="@(() => model.Password)" class="validation-error" />
                        <span class="form-hint">Minimum 8 characters with uppercase, lowercase, and number</span>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword" class="form-label required">Confirm Password</label>
                        <InputText id="confirmPassword" @bind-Value="model.ConfirmPassword" class="form-control"
                                   type="@(showPassword ? "text" : "password")" placeholder="Confirm password" />
                        <ValidationMessage For="@(() => model.ConfirmPassword)" class="validation-error" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="role" class="form-label required">User Role</label>
                        <InputSelect id="role" @bind-Value="model.Role" class="form-control">
                            <option value="">Select a role...</option>
                            <option value="Student">Student</option>
                            <option value="Instructor">Instructor</option>
                            <option value="Admin">Administrator</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => model.Role)" class="validation-error" />
                        <span class="form-hint">
                            @GetRoleDescription(model.Role)
                        </span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Status</label>
                        <div class="toggle-group">
                            <label class="toggle-switch">
                                <InputCheckbox @bind-Value="model.IsActive" />
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">@(model.IsActive ? "Active" : "Inactive")</span>
                        </div>
                        <span class="form-hint">Inactive users cannot log in</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email Verification</label>
                        <div class="toggle-group">
                            <label class="toggle-switch">
                                <InputCheckbox @bind-Value="model.EmailConfirmed" />
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">@(model.EmailConfirmed ? "Verified" : "Not Verified")</span>
                        </div>
                        <span class="form-hint">Skip email verification step</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Send Welcome Email</label>
                        <div class="toggle-group">
                            <label class="toggle-switch">
                                <InputCheckbox @bind-Value="model.SendWelcomeEmail" />
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">@(model.SendWelcomeEmail ? "Yes" : "No")</span>
                        </div>
                        <span class="form-hint">Send credentials via email</span>
                    </div>
                </div>
            </div>

            <!-- Profile Information Section -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-id-card"></i> Profile Information (Optional)
                </h3>

                <div class="form-group">
                    <label for="profilePicture" class="form-label">Profile Picture URL</label>
                    <div class="avatar-input-wrapper">
                        <InputText id="profilePicture" @bind-Value="model.ProfilePictureUrl" class="form-control"
                                   placeholder="https://example.com/avatar.jpg" />
                        @if (!string.IsNullOrEmpty(model.ProfilePictureUrl))
                        {
                            <div class="avatar-preview">
                                <img src="@model.ProfilePictureUrl" alt="Avatar preview" @onerror="OnAvatarError" />
                            </div>
                        }
                        else
                        {
                            <div class="avatar-preview placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        }
                    </div>
                    <ValidationMessage For="@(() => model.ProfilePictureUrl)" class="validation-error" />
                </div>

                <div class="form-group">
                    <label for="bio" class="form-label">Bio</label>
                    <InputTextArea id="bio" @bind-Value="model.Bio" class="form-control" rows="3"
                                   placeholder="Brief description about the user..." />
                    <ValidationMessage For="@(() => model.Bio)" class="validation-error" />
                    <span class="form-hint">@(model.Bio?.Length ?? 0) / 500 characters</span>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="jobTitle" class="form-label">Job Title</label>
                        <InputText id="jobTitle" @bind-Value="model.JobTitle" class="form-control"
                                   placeholder="e.g., Software Developer" />
                    </div>
                    <div class="form-group">
                        <label for="company" class="form-label">Company</label>
                        <InputText id="company" @bind-Value="model.Company" class="form-control"
                                   placeholder="e.g., Tech Corp" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="location" class="form-label">Location</label>
                        <InputText id="location" @bind-Value="model.Location" class="form-control"
                                   placeholder="e.g., New York, USA" />
                    </div>
                    <div class="form-group">
                        <label for="website" class="form-label">Website</label>
                        <InputText id="website" @bind-Value="model.Website" class="form-control"
                                   placeholder="https://example.com" />
                        <ValidationMessage For="@(() => model.Website)" class="validation-error" />
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" @onclick="NavigateBack" disabled="@isSaving">
                    Cancel
                </button>
                <button type="button" class="btn btn-outline" @onclick="ResetForm" disabled="@isSaving">
                    <i class="fas fa-redo"></i> Reset
                </button>
                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner spinner-sm"></span>
                        <span>Creating...</span>
                    }
                    else
                    {
                        <i class="fas fa-plus"></i>
                        <span>Create User</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>
</div>

<style>
    .password-input-wrapper {
        position: relative;
    }

    .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-secondary, #666);
        padding: 0;
    }

    .password-toggle:hover {
        color: var(--primary, #6366f1);
    }

    .toggle-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
        margin: 0;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
        background-color: #22c55e;
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    .toggle-label {
        font-size: 0.875rem;
        color: var(--text-primary, #333);
    }

    .avatar-input-wrapper {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }

    .avatar-input-wrapper .form-control {
        flex: 1;
    }

    .avatar-preview {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        overflow: hidden;
        border: 2px solid var(--border-color, #e5e7eb);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary, #f8f9fa);
        flex-shrink: 0;
    }

    .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-preview.placeholder {
        color: var(--text-tertiary, #999);
        font-size: 1.5rem;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--border-color, #e5e7eb);
        color: var(--text-primary, #333);
    }

    .btn-outline:hover {
        background: var(--bg-secondary, #f8f9fa);
    }
</style>

@code {
    private CreateUserModel model = new();
    private bool isSaving = false;
    private bool showPassword = false;
    private bool avatarError = false;

    private void NavigateBack()
    {
        Navigation.NavigateTo("/admin/users");
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void OnAvatarError()
    {
        avatarError = true;
    }

    private void ResetForm()
    {
        model = new CreateUserModel();
        avatarError = false;
        StateHasChanged();
    }

    private string GetRoleDescription(string? role) => role switch
    {
        "Student" => "Can enroll in courses and track progress",
        "Instructor" => "Can create and manage courses",
        "Admin" => "Full access to all platform features",
        _ => "Select a role to see description"
    };

    private async Task HandleSubmit()
    {
        try
        {
            isSaving = true;
            StateHasChanged();

            // Validate password match
            if (model.Password != model.ConfirmPassword)
            {
                Toast.ShowError("Passwords do not match");
                return;
            }

            // Simulate API call
            await Task.Delay(1500);

            // Create user DTO (simulated)
            var createUserDto = new
            {
                firstName = model.FirstName,
                lastName = model.LastName,
                email = model.Email,
                password = model.Password,
                phoneNumber = model.PhoneNumber,
                role = model.Role,
                isActive = model.IsActive,
                emailConfirmed = model.EmailConfirmed,
                profilePictureUrl = model.ProfilePictureUrl,
                bio = model.Bio,
                jobTitle = model.JobTitle,
                company = model.Company,
                location = model.Location,
                website = model.Website
            };

            // TODO: Replace with actual API call
            // var response = await ApiClient.PostAsync<CreateUserResponse>("api/users", createUserDto);

            Toast.ShowSuccess($"User '{model.FirstName} {model.LastName}' created successfully!");

            if (model.SendWelcomeEmail)
            {
                Toast.ShowInfo("Welcome email sent to user");
            }

            Navigation.NavigateTo("/admin/users");
        }
        catch (Exception ex)
        {
            Toast.ShowError("An error occurred while creating the user");
            Console.WriteLine($"CreateUser error: {ex}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private class CreateUserModel
    {
        [Required(ErrorMessage = "First name is required")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "First name must be between 2 and 50 characters")]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Last name is required")]
        [StringLength(50, MinimumLength = 2, ErrorMessage = "Last name must be between 2 and 50 characters")]
        public string LastName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = string.Empty;

        [Phone(ErrorMessage = "Invalid phone number")]
        public string? PhoneNumber { get; set; }

        [Required(ErrorMessage = "Password is required")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "Password must be at least 8 characters")]
        [RegularExpression(@"^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$",
            ErrorMessage = "Password must contain uppercase, lowercase, and a number")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm password")]
        [Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Role is required")]
        public string Role { get; set; } = string.Empty;

        public bool IsActive { get; set; } = true;
        public bool EmailConfirmed { get; set; } = false;
        public bool SendWelcomeEmail { get; set; } = true;

        [Url(ErrorMessage = "Invalid URL")]
        public string? ProfilePictureUrl { get; set; }

        [StringLength(500, ErrorMessage = "Bio cannot exceed 500 characters")]
        public string? Bio { get; set; }

        [StringLength(100)]
        public string? JobTitle { get; set; }

        [StringLength(100)]
        public string? Company { get; set; }

        [StringLength(100)]
        public string? Location { get; set; }

        [Url(ErrorMessage = "Invalid URL")]
        public string? Website { get; set; }
    }
}
