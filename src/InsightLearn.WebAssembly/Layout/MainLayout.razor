@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDeviceDetectionService DeviceDetection
@implements IAsyncDisposable

<!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Main Layout Structure -->
<div class="main-layout" style="overflow-y: auto !important; overflow-x: hidden !important; transform: none !important; perspective: none !important;">
    <!-- Main Header - Modern 3-Column Grid Layout -->
    <header class="main-header" role="banner" style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; width: 100% !important; z-index: 99999 !important; background: rgba(255,255,255,0.98) !important; backdrop-filter: blur(12px) !important;">
        <div class="main-header-container">
            <!-- Logo Section -->
            <div class="header-logo-section">
                <a href="/" class="logo-link">
                    <img src="images/insightlearn-logo.png" alt="InsightLearn.cloud Logo" class="logo-image" />
                    <span class="logo-text">InsightLearn</span>
                </a>
            </div>

            <!-- Search Section (desktop only) - B2B API Platform -->
            <div class="header-search-section desktop-only">
                <form class="search-form" @onsubmit="HandleSearch">
                    <div class="search-input-wrapper">
                        <input type="search"
                               class="search-input"
                               placeholder="Search APIs, documentation, SDKs..."
                               aria-label="Search documentation"
                               @bind="searchQuery" />
                        <button type="submit" class="search-submit-btn" aria-label="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Actions Section -->
            <div class="header-actions-section">
                <!-- Mobile Menu Toggle Button (v2.2.5) -->
                <button class="mobile-menu-toggle"
                        type="button"
                        @onclick="ToggleMobileMenu"
                        aria-label="@(isMobileMenuOpen ? "Close menu" : "Open menu")"
                        aria-expanded="@isMobileMenuOpen">
                    <i class="fas @(isMobileMenuOpen ? "fa-times" : "fa-bars")" aria-hidden="true"></i>
                </button>

                <!-- Solutions Dropdown Backdrop (closes menu when clicked outside) - B2B -->
                @if (isCategoriesOpen)
                {
                    <div class="categories-backdrop" @onclick="CloseCategories"></div>
                }

                <!-- Solutions Dropdown - B2B API Platform -->
                <div class="nav-dropdown categories-dropdown">
                    <button class="dropdown-trigger categories-trigger"
                            type="button"
                            aria-expanded="@isCategoriesOpen"
                            aria-haspopup="true"
                            @onclick="ToggleCategories"
                            @onclick:stopPropagation="true"
                            aria-label="Browse solutions and use cases">
                        <i class="fas fa-cubes" aria-hidden="true"></i>
                        <span class="desktop-only">Solutions</span>
                        <i class="fas fa-chevron-down dropdown-arrow @(isCategoriesOpen ? "rotated" : "")" aria-hidden="true"></i>
                    </button>
                    <div class="dropdown-menu categories-menu @(isCategoriesOpen ? "show" : "")" role="menu">
                        <div class="categories-grid" style="grid-template-columns: repeat(3, 1fr);">
                            @* Row 1: Use Cases *@
                            <a href="/solutions/corporate-training" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                    <i class="fas fa-building"></i>
                                </span>
                                <span class="category-label">Corporate Training</span>
                            </a>
                            <a href="/solutions/universities" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                    <i class="fas fa-university"></i>
                                </span>
                                <span class="category-label">Universities</span>
                            </a>
                            <a href="/solutions/bootcamps" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                    <i class="fas fa-laptop-code"></i>
                                </span>
                                <span class="category-label">Bootcamps</span>
                            </a>

                            @* Row 2: Industries *@
                            <a href="/solutions/healthcare" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                                    <i class="fas fa-heartbeat"></i>
                                </span>
                                <span class="category-label">Healthcare</span>
                            </a>
                            <a href="/solutions/fintech" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                    <i class="fas fa-chart-line"></i>
                                </span>
                                <span class="category-label">FinTech</span>
                            </a>
                            <a href="/solutions/government" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                                    <i class="fas fa-landmark"></i>
                                </span>
                                <span class="category-label">Government</span>
                            </a>
                        </div>
                        <div class="categories-footer">
                            <a href="/solutions" class="view-all-link" @onclick="CloseCategories">
                                <i class="fas fa-th"></i>
                                <span>View All Solutions</span>
                            </a>
                            <a href="/developers/docs" class="browse-courses-link" @onclick="CloseCategories">
                                <i class="fas fa-book"></i>
                                <span>API Documentation</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Developer Docs Quick Link - B2B -->
                <a href="/developers/docs" class="nav-link desktop-only" aria-label="API Documentation">
                    <i class="fas fa-book" aria-hidden="true"></i>
                    <span>Docs</span>
                </a>

                <!-- Pricing Quick Link - B2B -->
                <a href="/pricing" class="nav-link desktop-only" aria-label="Pricing">
                    <i class="fas fa-tags" aria-hidden="true"></i>
                    <span>Pricing</span>
                </a>

                <AuthorizeView>
                    <Authorized>
                        <!-- User Menu (v2.1.0-dev: auto-close on mouse leave) -->
                        <div class="user-menu-container" @onmouseleave="CloseUserMenu">
                            <button class="user-menu-trigger"
                                    type="button"
                                    aria-expanded="false"
                                    aria-haspopup="true"
                                    @onclick="ToggleUserMenu">
                                <div class="user-avatar">
                                    <span class="avatar-initials">@GetUserInitials(context.User.Identity?.Name)</span>
                                </div>
                                <div class="user-info desktop-only">
                                    <span class="user-name">@context.User.Identity?.Name</span>
                                </div>
                            </button>
                            @if (isUserMenuOpen)
                            {
                                <div class="user-dropdown show user-dropdown-expanded">
                                    @* === ADMIN SECTION (v2.1.0-dev - Grouped Menu) === *@
                                    <AuthorizeView Roles="Admin">
                                        <Authorized Context="adminContext">
                                            <div class="dropdown-section admin-section">
                                                <span class="dropdown-section-title">
                                                    <i class="fas fa-shield-alt"></i> Administration
                                                </span>

                                                @* --- Overview Group --- *@
                                                <div class="admin-menu-group">
                                                    <a href="/admin/dashboard" class="dropdown-item">
                                                        <span class="admin-item-badge badge-indigo">
                                                            <i class="fas fa-tachometer-alt"></i>
                                                        </span>
                                                        Dashboard
                                                    </a>
                                                    <a href="/admin/analytics" class="dropdown-item">
                                                        <span class="admin-item-badge badge-orange">
                                                            <i class="fas fa-chart-line"></i>
                                                        </span>
                                                        Analytics
                                                    </a>
                                                    <a href="/admin/reports" class="dropdown-item">
                                                        <span class="admin-item-badge badge-cyan">
                                                            <i class="fas fa-chart-bar"></i>
                                                        </span>
                                                        Reports
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- Content Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-layer-group"></i> Content
                                                    </span>
                                                    <a href="/admin/courses" class="dropdown-item">
                                                        <span class="admin-item-badge badge-green">
                                                            <i class="fas fa-graduation-cap"></i>
                                                        </span>
                                                        Courses
                                                    </a>
                                                    <a href="/admin/categories" class="dropdown-item">
                                                        <span class="admin-item-badge badge-amber">
                                                            <i class="fas fa-folder-tree"></i>
                                                        </span>
                                                        Categories
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- Users Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-users"></i> Users
                                                    </span>
                                                    <a href="/admin/users" class="dropdown-item">
                                                        <span class="admin-item-badge badge-blue">
                                                            <i class="fas fa-users-cog"></i>
                                                        </span>
                                                        User Management
                                                    </a>
                                                    <a href="/admin/instructors" class="dropdown-item">
                                                        <span class="admin-item-badge badge-purple">
                                                            <i class="fas fa-chalkboard-teacher"></i>
                                                        </span>
                                                        Instructors
                                                    </a>
                                                    <a href="/admin/user-lockouts" class="dropdown-item">
                                                        <span class="admin-item-badge badge-rose">
                                                            <i class="fas fa-user-lock"></i>
                                                        </span>
                                                        User Lockouts
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- Payments Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-credit-card"></i> Finance
                                                    </span>
                                                    <a href="/admin/payments" class="dropdown-item">
                                                        <span class="admin-item-badge badge-red">
                                                            <i class="fas fa-credit-card"></i>
                                                        </span>
                                                        Payments
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- Monitoring Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-eye"></i> Monitoring
                                                    </span>
                                                    <a href="/admin/chatbot-analytics" class="dropdown-item">
                                                        <span class="admin-item-badge badge-violet">
                                                            <i class="fas fa-robot"></i>
                                                        </span>
                                                        Chatbot Analytics
                                                    </a>
                                                    <a href="/admin/access-logs" class="dropdown-item">
                                                        <span class="admin-item-badge badge-gray">
                                                            <i class="fas fa-history"></i>
                                                        </span>
                                                        Access Logs
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- SEO Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-search"></i> SEO & Marketing
                                                    </span>
                                                    <a href="/admin/seo" class="dropdown-item">
                                                        <span class="admin-item-badge badge-sky">
                                                            <i class="fas fa-search-dollar"></i>
                                                        </span>
                                                        SEO Management
                                                    </a>
                                                    <a href="/admin/google-analytics" class="dropdown-item">
                                                        <span class="admin-item-badge badge-blue">
                                                            <i class="fab fa-google"></i>
                                                        </span>
                                                        Google Analytics
                                                    </a>
                                                    <a href="/admin/search-console" class="dropdown-item">
                                                        <span class="admin-item-badge badge-teal">
                                                            <i class="fas fa-search"></i>
                                                        </span>
                                                        Search Console
                                                    </a>
                                                    <a href="/admin/podcast-seo" class="dropdown-item">
                                                        <span class="admin-item-badge badge-violet">
                                                            <i class="fas fa-podcast"></i>
                                                        </span>
                                                        Podcast SEO
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- System Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-cog"></i> System
                                                    </span>
                                                    <a href="/admin/system-health" class="dropdown-item">
                                                        <span class="admin-item-badge badge-lime">
                                                            <i class="fas fa-heartbeat"></i>
                                                        </span>
                                                        System Health
                                                    </a>
                                                    <a href="/admin/auth-diagnostics" class="dropdown-item">
                                                        <span class="admin-item-badge badge-amber">
                                                            <i class="fas fa-key"></i>
                                                        </span>
                                                        Auth Diagnostics
                                                    </a>
                                                    <a href="/admin/settings" class="dropdown-item">
                                                        <span class="admin-item-badge badge-stone">
                                                            <i class="fas fa-cogs"></i>
                                                        </span>
                                                        System Settings
                                                    </a>
                                                </div>
                                            </div>
                                            <hr class="dropdown-divider" />
                                        </Authorized>
                                    </AuthorizeView>

                                    @* === TENANT MANAGEMENT SECTION (for enterprise customers) - B2B === *@
                                    <AuthorizeView Roles="TenantAdmin,Admin">
                                        <Authorized Context="tenantAdminContext">
                                            <div class="dropdown-section">
                                                <span class="dropdown-section-title">
                                                    <i class="fas fa-building"></i> Tenant Management
                                                </span>
                                                <a href="/tenant/overview" class="dropdown-item">
                                                    <i class="fas fa-home"></i>
                                                    Tenant Overview
                                                </a>
                                                <a href="/tenant/users" class="dropdown-item">
                                                    <i class="fas fa-users"></i>
                                                    Manage Users
                                                </a>
                                                <a href="/tenant/content" class="dropdown-item">
                                                    <i class="fas fa-folder-open"></i>
                                                    Content Library
                                                </a>
                                                <a href="/tenant/branding" class="dropdown-item">
                                                    <i class="fas fa-palette"></i>
                                                    White-Label Branding
                                                </a>
                                            </div>
                                            <hr class="dropdown-divider" />
                                        </Authorized>
                                    </AuthorizeView>

                                    @* === DEVELOPER CONSOLE SECTION (All logged-in users) - B2B === *@
                                    <div class="dropdown-section">
                                        <span class="dropdown-section-title">
                                            <i class="fas fa-terminal"></i> Developer Console
                                        </span>
                                        <a href="/console/dashboard" class="dropdown-item">
                                            <i class="fas fa-tachometer-alt"></i>
                                            Dashboard
                                        </a>
                                        <a href="/console/api-keys" class="dropdown-item">
                                            <i class="fas fa-key"></i>
                                            API Keys
                                        </a>
                                        <a href="/console/tenants" class="dropdown-item">
                                            <i class="fas fa-server"></i>
                                            Tenants
                                        </a>
                                        <a href="/console/analytics" class="dropdown-item">
                                            <i class="fas fa-chart-line"></i>
                                            Analytics
                                        </a>
                                        <a href="/console/webhooks" class="dropdown-item">
                                            <i class="fas fa-plug"></i>
                                            Webhooks
                                        </a>
                                        <a href="/console/logs" class="dropdown-item">
                                            <i class="fas fa-list-alt"></i>
                                            Request Logs
                                        </a>
                                        <a href="/console/billing" class="dropdown-item">
                                            <i class="fas fa-credit-card"></i>
                                            Billing & Usage
                                        </a>
                                        <a href="/console/settings" class="dropdown-item">
                                            <i class="fas fa-cog"></i>
                                            Settings
                                        </a>
                                    </div>
                                    <hr class="dropdown-divider" />
                                    <button @onclick="Logout" class="dropdown-item logout-btn">
                                        <i class="fas fa-sign-out-alt"></i>
                                        Logout
                                    </button>
                                </div>
                            }
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <div class="auth-buttons">
                            <a href="/login" class="btn btn-outline" aria-label="Login to Developer Console">
                                <i class="fas fa-terminal" style="margin-right: 6px;"></i>
                                Developer Login
                            </a>
                            <a href="/register" class="btn btn-primary" aria-label="Start your free trial">
                                <i class="fas fa-rocket" style="margin-right: 6px;"></i>
                                Start Free Trial
                            </a>
                        </div>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    </header>

    <!-- Mobile Menu Overlay (v2.2.5) -->
    @if (isMobileMenuOpen)
    {
        <div class="mobile-menu-backdrop" @onclick="CloseMobileMenu"></div>
    }
    <nav class="mobile-menu-panel @(isMobileMenuOpen ? "open" : "")" aria-label="Mobile navigation">
        <div class="mobile-menu-header">
            <span class="mobile-menu-title">InsightLearn API</span>
            <button class="mobile-menu-close" @onclick="CloseMobileMenu" aria-label="Close menu">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>
        <div class="mobile-menu-content">
            <!-- Mobile Search - B2B -->
            <form class="mobile-search-form" @onsubmit="HandleMobileSearch">
                <input type="search"
                       class="mobile-search-input"
                       placeholder="Search APIs, docs..."
                       @bind="searchQuery"
                       aria-label="Search documentation" />
                <button type="submit" class="mobile-search-btn" aria-label="Search">
                    <i class="fas fa-search" aria-hidden="true"></i>
                </button>
            </form>

            <!-- Mobile Navigation Links - B2B Platform -->
            <div class="mobile-nav-section">
                <span class="mobile-nav-section-title">Platform</span>
                <a href="/solutions" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-cubes" aria-hidden="true"></i>
                    <span>Solutions</span>
                </a>
                <a href="/pricing" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-tags" aria-hidden="true"></i>
                    <span>Pricing</span>
                </a>
                <a href="/enterprise" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-building" aria-hidden="true"></i>
                    <span>Enterprise</span>
                </a>
            </div>

            <!-- Mobile Developer Links - B2B -->
            <div class="mobile-nav-section">
                <span class="mobile-nav-section-title">Developers</span>
                <a href="/developers/docs" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-book" aria-hidden="true"></i>
                    <span>API Documentation</span>
                </a>
                <a href="/developers/quickstart" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-rocket" aria-hidden="true"></i>
                    <span>Quickstart Guide</span>
                </a>
                <a href="/developers/sdks" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-cube" aria-hidden="true"></i>
                    <span>SDKs & Libraries</span>
                </a>
                <a href="/developers/api-reference" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-file-code" aria-hidden="true"></i>
                    <span>API Reference</span>
                </a>
                <a href="/status" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-circle" style="color: #10b981;" aria-hidden="true"></i>
                    <span>System Status</span>
                </a>
            </div>

            <!-- Mobile Resources - B2B -->
            <div class="mobile-nav-section">
                <span class="mobile-nav-section-title">Resources</span>
                <a href="/blog" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-rss" aria-hidden="true"></i>
                    <span>Blog</span>
                </a>
                <a href="/case-studies" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-briefcase" aria-hidden="true"></i>
                    <span>Case Studies</span>
                </a>
                <a href="/help" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-question-circle" aria-hidden="true"></i>
                    <span>Help Center</span>
                </a>
            </div>

            <!-- Mobile Auth Section - B2B -->
            <AuthorizeView>
                <Authorized>
                    <div class="mobile-nav-section mobile-user-section">
                        <div class="mobile-user-info">
                            <div class="mobile-user-avatar">
                                <i class="fas fa-user-circle" aria-hidden="true"></i>
                            </div>
                            <span class="mobile-user-name">@context.User.Identity?.Name</span>
                        </div>
                        <a href="/console/dashboard" class="mobile-nav-link" @onclick="CloseMobileMenu">
                            <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                            <span>Developer Console</span>
                        </a>
                        <a href="/console/api-keys" class="mobile-nav-link" @onclick="CloseMobileMenu">
                            <i class="fas fa-key" aria-hidden="true"></i>
                            <span>API Keys</span>
                        </a>
                        <a href="/console/analytics" class="mobile-nav-link" @onclick="CloseMobileMenu">
                            <i class="fas fa-chart-line" aria-hidden="true"></i>
                            <span>Analytics</span>
                        </a>
                        <a href="/console/settings" class="mobile-nav-link" @onclick="CloseMobileMenu">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                            <span>Settings</span>
                        </a>
                        <button @onclick="Logout" class="mobile-nav-link mobile-logout-btn">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <div class="mobile-nav-section mobile-auth-section">
                        <a href="/login" class="mobile-auth-btn mobile-login-btn" @onclick="CloseMobileMenu">
                            <i class="fas fa-terminal" aria-hidden="true"></i>
                            <span>Developer Login</span>
                        </a>
                        <a href="/register" class="mobile-auth-btn mobile-signup-btn" @onclick="CloseMobileMenu">
                            <i class="fas fa-rocket" aria-hidden="true"></i>
                            <span>Start Free Trial</span>
                        </a>
                    </div>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" role="main" id="main-content" style="padding-top: 80px !important;">
        <div class="content-container">
            <!-- CascadingValue for device type - v2.2.2-dev responsive design -->
            <CascadingValue Value="@_deviceType" Name="DeviceType">
                <CascadingValue Value="@_deviceInfo" Name="DeviceInfo">
                    @Body
                </CascadingValue>
            </CascadingValue>
        </div>
    </main>

    <!-- Footer - B2B API Platform -->
    <footer class="main-footer" role="contentinfo" style="background: linear-gradient(180deg, #0f172a 0%, #020617 100%); background-color: #0f172a; color: #e5e7eb;">
        <div class="footer-container">
            <!-- Main Footer Content -->
            <div class="footer-content">
                <!-- Company Info - B2B -->
                <div class="footer-section footer-brand">
                    <div class="footer-logo">
                        <img src="images/insightlearn-logo.png" alt="InsightLearn.cloud API Platform" class="footer-logo-img" style="max-width: 200px; height: auto;" />
                    </div>
                    <p class="footer-description">
                        The headless infrastructure for e-learning. Build, scale, and deploy
                        your custom academy with our enterprise-grade API platform.
                    </p>
                    <div class="footer-social">
                        <a href="https://twitter.com/insightlearn" target="_blank" rel="noopener" class="social-link" aria-label="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://linkedin.com/company/insightlearn" target="_blank" rel="noopener" class="social-link" aria-label="LinkedIn">
                            <i class="fab fa-linkedin"></i>
                        </a>
                        <a href="https://github.com/insightlearn" target="_blank" rel="noopener" class="social-link" aria-label="GitHub">
                            <i class="fab fa-github"></i>
                        </a>
                    </div>
                </div>

                <!-- Platform Links - B2B -->
                <div class="footer-section">
                    <h4 class="footer-heading">Platform</h4>
                    <ul class="footer-links">
                        <li><a href="/solutions" class="footer-link">Solutions</a></li>
                        <li><a href="/pricing" class="footer-link">Pricing</a></li>
                        <li><a href="/enterprise" class="footer-link">Enterprise</a></li>
                        <li><a href="/case-studies" class="footer-link">Case Studies</a></li>
                    </ul>
                </div>

                <!-- Developers Links - B2B -->
                <div class="footer-section">
                    <h4 class="footer-heading">Developers</h4>
                    <ul class="footer-links">
                        <li><a href="/developers/docs" class="footer-link">API Documentation</a></li>
                        <li><a href="/developers/quickstart" class="footer-link">Quickstart Guide</a></li>
                        <li><a href="/developers/sdks" class="footer-link">SDKs & Libraries</a></li>
                        <li><a href="/developers/api-reference" class="footer-link">API Reference</a></li>
                        <li><a href="/developers/changelog" class="footer-link">Changelog</a></li>
                        <li><a href="/status" class="footer-link">System Status</a></li>
                    </ul>
                </div>

                <!-- Support Links - B2B -->
                <div class="footer-section">
                    <h4 class="footer-heading">Support</h4>
                    <ul class="footer-links">
                        <li><a href="/help" class="footer-link">Help Center</a></li>
                        <li><a href="/contact-sales" class="footer-link">Contact Sales</a></li>
                        <li><a href="mailto:support@insightlearn.cloud" class="footer-link">support@insightlearn.cloud</a></li>
                        <li><a href="mailto:enterprise@insightlearn.cloud" class="footer-link">enterprise@insightlearn.cloud</a></li>
                    </ul>
                </div>

                <!-- Legal Links -->
                <div class="footer-section">
                    <h4 class="footer-heading">Legal</h4>
                    <ul class="footer-links">
                        <li><a href="/privacy" class="footer-link">Privacy Policy</a></li>
                        <li><a href="/terms" class="footer-link">Terms of Service</a></li>
                        <li><a href="/security" class="footer-link">Security</a></li>
                        <li><a href="/sla" class="footer-link">SLA</a></li>
                    </ul>
                </div>
            </div>

            <!-- Footer Bottom - B2B Trust Indicators -->
            <div class="footer-bottom">
                <div class="footer-bottom-content">
                    <p class="footer-copyright">
                        &copy; @DateTime.Now.Year InsightLearn. All rights reserved.
                    </p>
                    <div class="footer-badges">
                        <span class="footer-badge">
                            <i class="fas fa-shield-alt"></i> SOC 2 Certified
                        </span>
                        <span class="footer-badge">
                            <i class="fas fa-lock"></i> GDPR Compliant
                        </span>
                        <span class="footer-badge">
                            <i class="fas fa-server"></i> 99.9% Uptime SLA
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>

<!-- Chatbot Widget - Client-side polling instead of SignalR -->
@if (!IsAdminPage())
{
    <ChatbotWidget />
}

<!-- Cookie Consent Wall - GDPR Compliance (Blocking Full-Screen) -->
@if (!IsAuthPage())
{
    <CookieConsentWall />
}

<!-- Session Timeout Warning - Auto logout after inactivity (v2.1.0-dev) -->
<SessionTimeoutWarning />

@code {
    [Inject] private IAuthService AuthService { get; set; } = default!;

    private bool isUserMenuOpen = false;
    private bool isCategoriesOpen = false;
    private bool isMobileMenuOpen = false;  // Mobile menu state (v2.2.5)
    private int cartItemCount = 0;
    private string searchQuery = string.Empty;

    // Device Detection State (v2.2.2-dev - Responsive Design)
    private DeviceInfo? _deviceInfo;
    private DeviceType _deviceType = DeviceType.Desktop;
    private bool _deviceDetectionInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_deviceDetectionInitialized)
        {
            try
            {
                _deviceInfo = await DeviceDetection.GetDeviceInfoAsync();
                _deviceType = _deviceInfo.DeviceType;

                // Subscribe to viewport changes for real-time responsiveness
                DeviceDetection.ViewportChanged += OnViewportChanged;
                DeviceDetection.OrientationChanged += OnOrientationChanged;

                _deviceDetectionInitialized = true;
                StateHasChanged();

                Console.WriteLine($"[MainLayout] Device detected: {_deviceType}, Viewport: {_deviceInfo.ViewportWidth}x{_deviceInfo.ViewportHeight}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[MainLayout] DeviceDetection error: {ex.Message}");
                // Fallback to desktop
                _deviceType = DeviceType.Desktop;
            }
        }
    }

    private void OnViewportChanged(object? sender, ViewportChangedEventArgs e)
    {
        // Update device type based on new viewport width
        // Using if/else instead of switch pattern to avoid Razor parser issues with '<' operator
        DeviceType newDeviceType;
        if (e.NewWidth < 768)
        {
            newDeviceType = DeviceType.Mobile;
        }
        else if (e.NewWidth < 1024)
        {
            newDeviceType = DeviceType.Tablet;
        }
        else
        {
            newDeviceType = DeviceType.Desktop;
        }

        if (newDeviceType != _deviceType)
        {
            _deviceType = newDeviceType;
            if (_deviceInfo != null)
            {
                _deviceInfo.ViewportWidth = e.NewWidth;
                _deviceInfo.ViewportHeight = e.NewHeight;
                _deviceInfo.DeviceType = newDeviceType;
            }
            InvokeAsync(StateHasChanged);
            Console.WriteLine($"[MainLayout] Viewport changed: {e.NewWidth}x{e.NewHeight}, DeviceType: {_deviceType}");
        }
    }

    private void OnOrientationChanged(object? sender, OrientationChangedEventArgs e)
    {
        if (_deviceInfo != null)
        {
            _deviceInfo.Orientation = e.NewOrientation;
        }
        InvokeAsync(StateHasChanged);
        Console.WriteLine($"[MainLayout] Orientation changed: {e.NewOrientation}");
    }

    public async ValueTask DisposeAsync()
    {
        if (_deviceDetectionInitialized)
        {
            DeviceDetection.ViewportChanged -= OnViewportChanged;
            DeviceDetection.OrientationChanged -= OnOrientationChanged;
        }
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/", true);
    }

    private void ToggleUserMenu()
    {
        isUserMenuOpen = !isUserMenuOpen;
    }

    // Close user menu on mouse leave (v2.1.0-dev UX improvement)
    private void CloseUserMenu()
    {
        isUserMenuOpen = false;
    }

    private void ToggleCategories()
    {
        isCategoriesOpen = !isCategoriesOpen;
    }

    // Close categories menu (v2.1.0-dev UX improvement)
    private void CloseCategories()
    {
        isCategoriesOpen = false;
    }

    // Mobile menu toggle (v2.2.5 - Mobile UX Fixes)
    private void ToggleMobileMenu()
    {
        isMobileMenuOpen = !isMobileMenuOpen;
        // Close other menus when mobile menu opens
        if (isMobileMenuOpen)
        {
            isCategoriesOpen = false;
            isUserMenuOpen = false;
        }
    }

    // Close mobile menu (v2.2.5)
    private void CloseMobileMenu()
    {
        isMobileMenuOpen = false;
    }

    // Mobile search handler (v2.2.5)
    private void HandleMobileSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            CloseMobileMenu();
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        }
    }

    private void HandleSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        }
    }

    private string GetUserInitials(string? userName)
    {
        if (string.IsNullOrWhiteSpace(userName))
            return "U";

        var parts = userName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return userName[0].ToString().ToUpper();
    }

    private string GetCurrentPage()
    {
        var uri = Navigation.Uri;
        var path = Navigation.ToBaseRelativePath(uri);
        return "/" + path;
    }

    private bool IsAdminPage()
    {
        var currentPage = GetCurrentPage();
        return currentPage.StartsWith("/admin", StringComparison.OrdinalIgnoreCase) ||
               currentPage.StartsWith("/instructor", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsAuthPage()
    {
        var currentPage = GetCurrentPage().ToLower();
        return currentPage == "/login" ||
               currentPage.StartsWith("/login?") ||
               currentPage == "/register" ||
               currentPage.StartsWith("/register?") ||
               currentPage == "/forgot-password" ||
               currentPage.StartsWith("/reset-password");
    }
}
