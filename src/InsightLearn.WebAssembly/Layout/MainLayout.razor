@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDeviceDetectionService DeviceDetection
@implements IAsyncDisposable

<!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Main Layout Structure -->
<div class="main-layout" style="overflow-y: auto !important; overflow-x: hidden !important; transform: none !important; perspective: none !important;">
    <!-- Main Header - Modern 3-Column Grid Layout -->
    <header class="main-header" role="banner" style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; width: 100% !important; z-index: 99999 !important; background: rgba(255,255,255,0.98) !important; backdrop-filter: blur(12px) !important;">
        <div class="main-header-container">
            <!-- Logo Section -->
            <div class="header-logo-section">
                <a href="/" class="logo-link">
                    <img src="/images/insightlearn-logo.png" alt="InsightLearn.cloud Logo" class="logo-image" />
                    <span class="logo-text">InsightLearn</span>
                </a>
            </div>

            <!-- Search Section (desktop only) - B2C Course Search -->
            <div class="header-search-section desktop-only">
                <form class="search-form" @onsubmit="HandleSearch">
                    <div class="search-input-wrapper">
                        <input type="search"
                               class="search-input"
                               placeholder="Search courses, skills, instructors..."
                               aria-label="Search courses"
                               @bind="searchQuery" />
                        <button type="submit" class="search-submit-btn" aria-label="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Actions Section -->
            <div class="header-actions-section">
                <!-- Mobile Menu Toggle Button (v2.2.5) -->
                <button class="mobile-menu-toggle"
                        type="button"
                        @onclick="ToggleMobileMenu"
                        aria-label="@(isMobileMenuOpen ? "Close menu" : "Open menu")"
                        aria-expanded="@isMobileMenuOpen">
                    <i class="fas @(isMobileMenuOpen ? "fa-times" : "fa-bars")" aria-hidden="true"></i>
                </button>

                <!-- Categories Dropdown Backdrop (closes menu when clicked outside) - B2C -->
                @if (isCategoriesOpen)
                {
                    <div class="categories-backdrop" @onclick="CloseCategories"></div>
                }

                <!-- Categories Dropdown - B2C Course Categories -->
                <div class="nav-dropdown categories-dropdown">
                    <button class="dropdown-trigger categories-trigger"
                            type="button"
                            aria-expanded="@isCategoriesOpen"
                            aria-haspopup="true"
                            @onclick="ToggleCategories"
                            @onclick:stopPropagation="true"
                            aria-label="Browse course categories">
                        <i class="fas fa-th-large" aria-hidden="true"></i>
                        <span class="desktop-only">Categories</span>
                        <i class="fas fa-chevron-down dropdown-arrow @(isCategoriesOpen ? "rotated" : "")" aria-hidden="true"></i>
                    </button>
                    <div class="dropdown-menu categories-menu @(isCategoriesOpen ? "show" : "")" role="menu">
                        <div class="categories-grid" style="grid-template-columns: repeat(3, 1fr);">
                            @* Row 1: Tech Skills *@
                            <a href="/courses?category=data-science" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                    <i class="fas fa-chart-line"></i>
                                </span>
                                <span class="category-label">Data Science</span>
                            </a>
                            <a href="/courses?category=web-development" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                    <i class="fas fa-code"></i>
                                </span>
                                <span class="category-label">Web Development</span>
                            </a>
                            <a href="/courses?category=design" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                    <i class="fas fa-paint-brush"></i>
                                </span>
                                <span class="category-label">Design</span>
                            </a>

                            @* Row 2: More Categories *@
                            <a href="/courses?category=business" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                    <i class="fas fa-briefcase"></i>
                                </span>
                                <span class="category-label">Business</span>
                            </a>
                            <a href="/courses?category=cloud" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                                    <i class="fas fa-cloud"></i>
                                </span>
                                <span class="category-label">Cloud & DevOps</span>
                            </a>
                            <a href="/courses?category=personal-development" class="category-item" @onclick="CloseCategories">
                                <span class="category-icon" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                                    <i class="fas fa-star"></i>
                                </span>
                                <span class="category-label">Personal Growth</span>
                            </a>
                        </div>
                        <div class="categories-footer">
                            <a href="/categories" class="view-all-link" @onclick="CloseCategories">
                                <i class="fas fa-th"></i>
                                <span>All Categories</span>
                            </a>
                            <a href="/courses" class="browse-courses-link" @onclick="CloseCategories">
                                <i class="fas fa-graduation-cap"></i>
                                <span>Browse All Courses</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Courses Quick Link - B2C -->
                <a href="/courses" class="nav-link desktop-only" aria-label="Browse Courses">
                    <i class="fas fa-play-circle" aria-hidden="true"></i>
                    <span>Courses</span>
                </a>

                <!-- Pricing Quick Link - B2C -->
                <a href="/pricing" class="nav-link desktop-only" aria-label="Pricing Plans">
                    <i class="fas fa-tags" aria-hidden="true"></i>
                    <span>Pricing</span>
                </a>

                <AuthorizeView>
                    <Authorized>
                        <!-- User Menu (v2.1.0-dev: auto-close on mouse leave) -->
                        <div class="user-menu-container" @onmouseleave="CloseUserMenu">
                            <button class="user-menu-trigger"
                                    type="button"
                                    aria-expanded="false"
                                    aria-haspopup="true"
                                    @onclick="ToggleUserMenu">
                                <div class="user-avatar">
                                    <span class="avatar-initials">@GetUserInitials(context.User.Identity?.Name)</span>
                                </div>
                                <div class="user-info desktop-only">
                                    <span class="user-name">@context.User.Identity?.Name</span>
                                </div>
                            </button>
                            @if (isUserMenuOpen)
                            {
                                <div class="user-dropdown show user-dropdown-expanded">
                                    @* === ADMIN SECTION (v2.1.0-dev - Grouped Menu) === *@
                                    <AuthorizeView Roles="Admin">
                                        <Authorized Context="adminContext">
                                            <div class="dropdown-section admin-section">
                                                <span class="dropdown-section-title">
                                                    <i class="fas fa-shield-alt"></i> Administration
                                                </span>

                                                @* --- Overview Group --- *@
                                                <div class="admin-menu-group">
                                                    <a href="/admin/dashboard" class="dropdown-item">
                                                        <span class="admin-item-badge badge-indigo">
                                                            <i class="fas fa-tachometer-alt"></i>
                                                        </span>
                                                        Dashboard
                                                    </a>
                                                    <a href="/admin/analytics" class="dropdown-item">
                                                        <span class="admin-item-badge badge-orange">
                                                            <i class="fas fa-chart-line"></i>
                                                        </span>
                                                        Analytics
                                                    </a>
                                                    <a href="/admin/reports" class="dropdown-item">
                                                        <span class="admin-item-badge badge-cyan">
                                                            <i class="fas fa-chart-bar"></i>
                                                        </span>
                                                        Reports
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- Content Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-layer-group"></i> Content
                                                    </span>
                                                    <a href="/admin/courses" class="dropdown-item">
                                                        <span class="admin-item-badge badge-green">
                                                            <i class="fas fa-graduation-cap"></i>
                                                        </span>
                                                        Courses
                                                    </a>
                                                    <a href="/admin/categories" class="dropdown-item">
                                                        <span class="admin-item-badge badge-amber">
                                                            <i class="fas fa-folder-tree"></i>
                                                        </span>
                                                        Categories
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- Users Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-users"></i> Users
                                                    </span>
                                                    <a href="/admin/users" class="dropdown-item">
                                                        <span class="admin-item-badge badge-blue">
                                                            <i class="fas fa-users-cog"></i>
                                                        </span>
                                                        User Management
                                                    </a>
                                                    <a href="/admin/instructors" class="dropdown-item">
                                                        <span class="admin-item-badge badge-purple">
                                                            <i class="fas fa-chalkboard-teacher"></i>
                                                        </span>
                                                        Instructors
                                                    </a>
                                                    <a href="/admin/user-lockouts" class="dropdown-item">
                                                        <span class="admin-item-badge badge-rose">
                                                            <i class="fas fa-user-lock"></i>
                                                        </span>
                                                        User Lockouts
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- Payments Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-credit-card"></i> Finance
                                                    </span>
                                                    <a href="/admin/payments" class="dropdown-item">
                                                        <span class="admin-item-badge badge-red">
                                                            <i class="fas fa-credit-card"></i>
                                                        </span>
                                                        Payments
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- Monitoring Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-eye"></i> Monitoring
                                                    </span>
                                                    <a href="/admin/chatbot-analytics" class="dropdown-item">
                                                        <span class="admin-item-badge badge-violet">
                                                            <i class="fas fa-robot"></i>
                                                        </span>
                                                        Chatbot Analytics
                                                    </a>
                                                    <a href="/admin/access-logs" class="dropdown-item">
                                                        <span class="admin-item-badge badge-gray">
                                                            <i class="fas fa-history"></i>
                                                        </span>
                                                        Access Logs
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- SEO Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-search"></i> SEO & Marketing
                                                    </span>
                                                    <a href="/admin/seo" class="dropdown-item">
                                                        <span class="admin-item-badge badge-sky">
                                                            <i class="fas fa-search-dollar"></i>
                                                        </span>
                                                        SEO Management
                                                    </a>
                                                    <a href="/admin/google-analytics" class="dropdown-item">
                                                        <span class="admin-item-badge badge-blue">
                                                            <i class="fab fa-google"></i>
                                                        </span>
                                                        Google Analytics
                                                    </a>
                                                    <a href="/admin/search-console" class="dropdown-item">
                                                        <span class="admin-item-badge badge-teal">
                                                            <i class="fas fa-search"></i>
                                                        </span>
                                                        Search Console
                                                    </a>
                                                    <a href="/admin/podcast-seo" class="dropdown-item">
                                                        <span class="admin-item-badge badge-violet">
                                                            <i class="fas fa-podcast"></i>
                                                        </span>
                                                        Podcast SEO
                                                    </a>
                                                </div>

                                                <div class="admin-menu-separator"></div>

                                                @* --- System Group --- *@
                                                <div class="admin-menu-group">
                                                    <span class="admin-menu-group-header">
                                                        <i class="fas fa-cog"></i> System
                                                    </span>
                                                    <a href="/admin/system-health" class="dropdown-item">
                                                        <span class="admin-item-badge badge-lime">
                                                            <i class="fas fa-heartbeat"></i>
                                                        </span>
                                                        System Health
                                                    </a>
                                                    <a href="/admin/debug" class="dropdown-item">
                                                        <span class="admin-item-badge badge-danger">
                                                            <i class="fas fa-bug"></i>
                                                        </span>
                                                        Debug Console
                                                    </a>
                                                    <a href="/admin/auth-diagnostics" class="dropdown-item">
                                                        <span class="admin-item-badge badge-amber">
                                                            <i class="fas fa-key"></i>
                                                        </span>
                                                        Auth Diagnostics
                                                    </a>
                                                    <a href="/admin/settings" class="dropdown-item">
                                                        <span class="admin-item-badge badge-stone">
                                                            <i class="fas fa-cogs"></i>
                                                        </span>
                                                        System Settings
                                                    </a>
                                                </div>
                                            </div>
                                            <hr class="dropdown-divider" />
                                        </Authorized>
                                    </AuthorizeView>

                                    @* === TENANT MANAGEMENT SECTION (for enterprise customers) - B2B === *@
                                    <AuthorizeView Roles="TenantAdmin,Admin">
                                        <Authorized Context="tenantAdminContext">
                                            <div class="dropdown-section">
                                                <span class="dropdown-section-title">
                                                    <i class="fas fa-building"></i> Tenant Management
                                                </span>
                                                <a href="/tenant/overview" class="dropdown-item">
                                                    <i class="fas fa-home"></i>
                                                    Tenant Overview
                                                </a>
                                                <a href="/tenant/users" class="dropdown-item">
                                                    <i class="fas fa-users"></i>
                                                    Manage Users
                                                </a>
                                                <a href="/tenant/content" class="dropdown-item">
                                                    <i class="fas fa-folder-open"></i>
                                                    Content Library
                                                </a>
                                                <a href="/tenant/branding" class="dropdown-item">
                                                    <i class="fas fa-palette"></i>
                                                    White-Label Branding
                                                </a>
                                            </div>
                                            <hr class="dropdown-divider" />
                                        </Authorized>
                                    </AuthorizeView>

                                    @* === DEVELOPER CONSOLE SECTION (All logged-in users) - B2B === *@
                                    <div class="dropdown-section">
                                        <span class="dropdown-section-title">
                                            <i class="fas fa-terminal"></i> Developer Console
                                        </span>
                                        <a href="/console/dashboard" class="dropdown-item">
                                            <i class="fas fa-tachometer-alt"></i>
                                            Dashboard
                                        </a>
                                        <a href="/console/api-keys" class="dropdown-item">
                                            <i class="fas fa-key"></i>
                                            API Keys
                                        </a>
                                        <a href="/console/tenants" class="dropdown-item">
                                            <i class="fas fa-server"></i>
                                            Tenants
                                        </a>
                                        <a href="/console/analytics" class="dropdown-item">
                                            <i class="fas fa-chart-line"></i>
                                            Analytics
                                        </a>
                                        <a href="/console/webhooks" class="dropdown-item">
                                            <i class="fas fa-plug"></i>
                                            Webhooks
                                        </a>
                                        <a href="/console/logs" class="dropdown-item">
                                            <i class="fas fa-list-alt"></i>
                                            Request Logs
                                        </a>
                                        <a href="/console/billing" class="dropdown-item">
                                            <i class="fas fa-credit-card"></i>
                                            Billing & Usage
                                        </a>
                                        <a href="/console/settings" class="dropdown-item">
                                            <i class="fas fa-cog"></i>
                                            Settings
                                        </a>
                                    </div>
                                    <hr class="dropdown-divider" />
                                    <button @onclick="Logout" class="dropdown-item logout-btn">
                                        <i class="fas fa-sign-out-alt"></i>
                                        Logout
                                    </button>
                                </div>
                            }
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <div class="auth-buttons">
                            <a href="/login" class="btn btn-outline" aria-label="Login to your account">
                                <i class="fas fa-sign-in-alt" style="margin-right: 6px;"></i>
                                Login
                            </a>
                            <a href="/register" class="btn btn-primary btn-cta-signup" aria-label="Sign up for free">
                                <i class="fas fa-user-plus" style="margin-right: 6px;"></i>
                                Sign Up
                            </a>
                        </div>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    </header>

    <!-- Mobile Menu Overlay (v2.3.1 - B2C Consumer Layout) -->
    @if (isMobileMenuOpen)
    {
        <div class="mobile-menu-backdrop" @onclick="CloseMobileMenu"></div>
    }
    <nav class="mobile-menu-panel @(isMobileMenuOpen ? "open" : "")" aria-label="Mobile navigation">
        <div class="mobile-menu-header">
            <span class="mobile-menu-title">InsightLearn</span>
            <button class="mobile-menu-close" @onclick="CloseMobileMenu" aria-label="Close menu">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>
        <div class="mobile-menu-content">
            <!-- Mobile Search - B2C Courses -->
            <form class="mobile-search-form" @onsubmit="HandleMobileSearch">
                <input type="search"
                       class="mobile-search-input"
                       placeholder="Search courses, skills..."
                       @bind="searchQuery"
                       aria-label="Search courses" />
                <button type="submit" class="mobile-search-btn" aria-label="Search">
                    <i class="fas fa-search" aria-hidden="true"></i>
                </button>
            </form>

            <!-- Mobile Navigation Links - B2C Consumer Platform -->
            <div class="mobile-nav-section">
                <span class="mobile-nav-section-title">Browse</span>
                <a href="/courses" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-graduation-cap" aria-hidden="true"></i>
                    <span>All Courses</span>
                </a>
                <a href="/categories" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-th-large" aria-hidden="true"></i>
                    <span>Categories</span>
                </a>
                <a href="/instructors" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-chalkboard-teacher" aria-hidden="true"></i>
                    <span>Instructors</span>
                </a>
            </div>

            <!-- Mobile Categories - B2C -->
            <div class="mobile-nav-section">
                <span class="mobile-nav-section-title">Popular Categories</span>
                <a href="/courses?category=data-science" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    <span>Data Science</span>
                </a>
                <a href="/courses?category=web-development" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-code" aria-hidden="true"></i>
                    <span>Web Development</span>
                </a>
                <a href="/courses?category=design" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-paint-brush" aria-hidden="true"></i>
                    <span>Design</span>
                </a>
                <a href="/courses?category=business" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-briefcase" aria-hidden="true"></i>
                    <span>Business</span>
                </a>
            </div>

            <!-- Mobile Resources - B2C -->
            <div class="mobile-nav-section">
                <span class="mobile-nav-section-title">Resources</span>
                <a href="/pricing" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-tags" aria-hidden="true"></i>
                    <span>Pricing</span>
                </a>
                <a href="/about" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                    <span>About Us</span>
                </a>
                <a href="/faq" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-question-circle" aria-hidden="true"></i>
                    <span>FAQ</span>
                </a>
                <a href="/contact" class="mobile-nav-link" @onclick="CloseMobileMenu">
                    <i class="fas fa-envelope" aria-hidden="true"></i>
                    <span>Contact</span>
                </a>
            </div>

            <!-- Mobile Auth Section - B2C -->
            <AuthorizeView>
                <Authorized>
                    <div class="mobile-nav-section mobile-user-section">
                        <div class="mobile-user-info">
                            <div class="mobile-user-avatar">
                                <i class="fas fa-user-circle" aria-hidden="true"></i>
                            </div>
                            <span class="mobile-user-name">@context.User.Identity?.Name</span>
                        </div>
                        <a href="/dashboard" class="mobile-nav-link" @onclick="CloseMobileMenu">
                            <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                            <span>My Dashboard</span>
                        </a>
                        <a href="/my-courses" class="mobile-nav-link" @onclick="CloseMobileMenu">
                            <i class="fas fa-book-open" aria-hidden="true"></i>
                            <span>My Courses</span>
                        </a>
                        <a href="/profile" class="mobile-nav-link" @onclick="CloseMobileMenu">
                            <i class="fas fa-user" aria-hidden="true"></i>
                            <span>Profile</span>
                        </a>
                        <a href="/settings" class="mobile-nav-link" @onclick="CloseMobileMenu">
                            <i class="fas fa-cog" aria-hidden="true"></i>
                            <span>Settings</span>
                        </a>
                        <button @onclick="Logout" class="mobile-nav-link mobile-logout-btn">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <div class="mobile-nav-section mobile-auth-section">
                        <a href="/login" class="mobile-auth-btn mobile-login-btn" @onclick="CloseMobileMenu">
                            <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                            <span>Login</span>
                        </a>
                        <a href="/register" class="mobile-auth-btn mobile-signup-btn" @onclick="CloseMobileMenu">
                            <i class="fas fa-user-plus" aria-hidden="true"></i>
                            <span>Start Learning Free</span>
                        </a>
                    </div>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" role="main" id="main-content" style="padding-top: 80px !important;">
        <div class="content-container">
            <!-- CascadingValue for device type - v2.2.2-dev responsive design -->
            <CascadingValue Value="@_deviceType" Name="DeviceType">
                <CascadingValue Value="@_deviceInfo" Name="DeviceInfo">
                    @Body
                </CascadingValue>
            </CascadingValue>
        </div>
    </main>

    <!-- Footer - B2C Learning Platform (v2.3.1) -->
    <footer class="main-footer b2c-footer" role="contentinfo">
        <div class="footer-container">
            <!-- Main Footer Content -->
            <div class="footer-content">
                <!-- Company Info - B2C -->
                <div class="footer-section footer-brand">
                    <div class="footer-logo">
                        <img src="/images/insightlearn-logo.png" alt="InsightLearn Logo" class="footer-logo-img" />
                    </div>
                    <p class="footer-description">
                        Transform your future with expert-led online courses. Learn new skills
                        in Data Science, Web Development, Design, and Business from anywhere.
                    </p>
                    <div class="footer-social">
                        <a href="https://twitter.com/insightlearn" target="_blank" rel="noopener" class="social-link" aria-label="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://facebook.com/insightlearn" target="_blank" rel="noopener" class="social-link" aria-label="Facebook">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="https://instagram.com/insightlearn" target="_blank" rel="noopener" class="social-link" aria-label="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://youtube.com/insightlearn" target="_blank" rel="noopener" class="social-link" aria-label="YouTube">
                            <i class="fab fa-youtube"></i>
                        </a>
                        <a href="https://linkedin.com/company/insightlearn" target="_blank" rel="noopener" class="social-link" aria-label="LinkedIn">
                            <i class="fab fa-linkedin"></i>
                        </a>
                    </div>
                </div>

                <!-- Course Categories - B2C -->
                <div class="footer-section">
                    <h4 class="footer-heading">Popular Categories</h4>
                    <ul class="footer-links">
                        <li><a href="/courses?category=data-science" class="footer-link">Data Science</a></li>
                        <li><a href="/courses?category=web-development" class="footer-link">Web Development</a></li>
                        <li><a href="/courses?category=design" class="footer-link">Design</a></li>
                        <li><a href="/courses?category=business" class="footer-link">Business</a></li>
                        <li><a href="/courses?category=cloud" class="footer-link">Cloud & DevOps</a></li>
                        <li><a href="/categories" class="footer-link">View All Categories</a></li>
                    </ul>
                </div>

                <!-- Quick Links - B2C -->
                <div class="footer-section">
                    <h4 class="footer-heading">Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="/courses" class="footer-link">Browse Courses</a></li>
                        <li><a href="/instructors" class="footer-link">Become an Instructor</a></li>
                        <li><a href="/pricing" class="footer-link">Pricing Plans</a></li>
                        <li><a href="/about" class="footer-link">About Us</a></li>
                        <li><a href="/blog" class="footer-link">Blog</a></li>
                        <li><a href="/careers" class="footer-link">Careers</a></li>
                    </ul>
                </div>

                <!-- Support Links - B2C -->
                <div class="footer-section">
                    <h4 class="footer-heading">Support</h4>
                    <ul class="footer-links">
                        <li><a href="/faq" class="footer-link">FAQ</a></li>
                        <li><a href="/help" class="footer-link">Help Center</a></li>
                        <li><a href="/contact" class="footer-link">Contact Us</a></li>
                        <li><a href="mailto:support@insightlearn.cloud" class="footer-link">support@insightlearn.cloud</a></li>
                    </ul>
                </div>

                <!-- Legal Links -->
                <div class="footer-section">
                    <h4 class="footer-heading">Legal</h4>
                    <ul class="footer-links">
                        <li><a href="/privacy" class="footer-link">Privacy Policy</a></li>
                        <li><a href="/terms" class="footer-link">Terms of Service</a></li>
                        <li><a href="/cookie-policy" class="footer-link">Cookie Policy</a></li>
                        <li><a href="/refund-policy" class="footer-link">Refund Policy</a></li>
                    </ul>
                </div>
            </div>

            <!-- Footer Bottom - B2C Trust Indicators -->
            <div class="footer-bottom">
                <div class="footer-bottom-content">
                    <p class="footer-copyright">
                        &copy; @DateTime.Now.Year InsightLearn. All rights reserved.
                    </p>
                    <div class="footer-badges">
                        <span class="footer-badge">
                            <i class="fas fa-check-circle"></i> Verified Courses
                        </span>
                        <span class="footer-badge">
                            <i class="fas fa-certificate"></i> Certificates
                        </span>
                        <span class="footer-badge">
                            <i class="fas fa-lock"></i> Secure Payments
                        </span>
                        <span class="footer-badge">
                            <i class="fas fa-undo"></i> 30-Day Guarantee
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>

<!-- Chatbot Widget - Client-side polling instead of SignalR -->
@if (!IsAdminPage())
{
    <ChatbotWidget />
}

<!-- Cookie Consent Wall - GDPR Compliance (Blocking Full-Screen) -->
@if (!IsAuthPage())
{
    <CookieConsentWall />
}

<!-- Session Timeout Warning - Auto logout after inactivity (v2.1.0-dev) -->
<SessionTimeoutWarning />

@code {
    [Inject] private IAuthService AuthService { get; set; } = default!;

    private bool isUserMenuOpen = false;
    private bool isCategoriesOpen = false;
    private bool isMobileMenuOpen = false;  // Mobile menu state (v2.2.5)
    private int cartItemCount = 0;
    private string searchQuery = string.Empty;

    // Device Detection State (v2.2.2-dev - Responsive Design)
    private DeviceInfo? _deviceInfo;
    private DeviceType _deviceType = DeviceType.Desktop;
    private bool _deviceDetectionInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_deviceDetectionInitialized)
        {
            try
            {
                _deviceInfo = await DeviceDetection.GetDeviceInfoAsync();
                _deviceType = _deviceInfo.DeviceType;

                // Subscribe to viewport changes for real-time responsiveness
                DeviceDetection.ViewportChanged += OnViewportChanged;
                DeviceDetection.OrientationChanged += OnOrientationChanged;

                _deviceDetectionInitialized = true;
                StateHasChanged();

                Console.WriteLine($"[MainLayout] Device detected: {_deviceType}, Viewport: {_deviceInfo.ViewportWidth}x{_deviceInfo.ViewportHeight}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[MainLayout] DeviceDetection error: {ex.Message}");
                // Fallback to desktop
                _deviceType = DeviceType.Desktop;
            }
        }
    }

    private void OnViewportChanged(object? sender, ViewportChangedEventArgs e)
    {
        // Update device type based on new viewport width
        // Using if/else instead of switch pattern to avoid Razor parser issues with '<' operator
        DeviceType newDeviceType;
        if (e.NewWidth < 768)
        {
            newDeviceType = DeviceType.Mobile;
        }
        else if (e.NewWidth < 1024)
        {
            newDeviceType = DeviceType.Tablet;
        }
        else
        {
            newDeviceType = DeviceType.Desktop;
        }

        if (newDeviceType != _deviceType)
        {
            _deviceType = newDeviceType;
            if (_deviceInfo != null)
            {
                _deviceInfo.ViewportWidth = e.NewWidth;
                _deviceInfo.ViewportHeight = e.NewHeight;
                _deviceInfo.DeviceType = newDeviceType;
            }
            InvokeAsync(StateHasChanged);
            Console.WriteLine($"[MainLayout] Viewport changed: {e.NewWidth}x{e.NewHeight}, DeviceType: {_deviceType}");
        }
    }

    private void OnOrientationChanged(object? sender, OrientationChangedEventArgs e)
    {
        if (_deviceInfo != null)
        {
            _deviceInfo.Orientation = e.NewOrientation;
        }
        InvokeAsync(StateHasChanged);
        Console.WriteLine($"[MainLayout] Orientation changed: {e.NewOrientation}");
    }

    public async ValueTask DisposeAsync()
    {
        if (_deviceDetectionInitialized)
        {
            DeviceDetection.ViewportChanged -= OnViewportChanged;
            DeviceDetection.OrientationChanged -= OnOrientationChanged;
        }
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/", true);
    }

    private void ToggleUserMenu()
    {
        isUserMenuOpen = !isUserMenuOpen;
    }

    // Close user menu on mouse leave (v2.1.0-dev UX improvement)
    private void CloseUserMenu()
    {
        isUserMenuOpen = false;
    }

    private void ToggleCategories()
    {
        isCategoriesOpen = !isCategoriesOpen;
    }

    // Close categories menu (v2.1.0-dev UX improvement)
    private void CloseCategories()
    {
        isCategoriesOpen = false;
    }

    // Mobile menu toggle (v2.2.5 - Mobile UX Fixes)
    private void ToggleMobileMenu()
    {
        isMobileMenuOpen = !isMobileMenuOpen;
        // Close other menus when mobile menu opens
        if (isMobileMenuOpen)
        {
            isCategoriesOpen = false;
            isUserMenuOpen = false;
        }
    }

    // Close mobile menu (v2.2.5)
    private void CloseMobileMenu()
    {
        isMobileMenuOpen = false;
    }

    // Mobile search handler (v2.2.5)
    private void HandleMobileSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            CloseMobileMenu();
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        }
    }

    private void HandleSearch()
    {
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(searchQuery)}");
        }
    }

    private string GetUserInitials(string? userName)
    {
        if (string.IsNullOrWhiteSpace(userName))
            return "U";

        var parts = userName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return userName[0].ToString().ToUpper();
    }

    private string GetCurrentPage()
    {
        var uri = Navigation.Uri;
        var path = Navigation.ToBaseRelativePath(uri);
        return "/" + path;
    }

    private bool IsAdminPage()
    {
        var currentPage = GetCurrentPage();
        return currentPage.StartsWith("/admin", StringComparison.OrdinalIgnoreCase) ||
               currentPage.StartsWith("/instructor", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsAuthPage()
    {
        var currentPage = GetCurrentPage().ToLower();
        return currentPage == "/login" ||
               currentPage.StartsWith("/login?") ||
               currentPage == "/register" ||
               currentPage.StartsWith("/register?") ||
               currentPage == "/forgot-password" ||
               currentPage.StartsWith("/reset-password");
    }
}
