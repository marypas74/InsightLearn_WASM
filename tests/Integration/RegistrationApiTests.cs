using FluentAssertions;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.EntityFrameworkCore;
using System.Net;
using System.Net.Http.Json;
using System.Text;
using System.Text.Json;
using InsightLearn.Application.DTOs;
using InsightLearn.Infrastructure.Data;
using InsightLearn.Api;
using Microsoft.AspNetCore.Identity;
using InsightLearn.Core.Entities;

namespace InsightLearn.Tests.Integration;

public class RegistrationApiTests : IClassFixture<WebApplicationFactory<Program>>, IDisposable
{
    private readonly WebApplicationFactory<Program> _factory;
    private readonly HttpClient _client;
    private readonly IServiceScope _scope;
    private readonly ApplicationDbContext _context;

    public RegistrationApiTests(WebApplicationFactory<Program> factory)
    {
        _factory = factory.WithWebHostBuilder(builder =>
        {
            builder.UseEnvironment("Test");
            builder.ConfigureServices(services =>
            {
                // Remove the existing DbContext registration
                var descriptor = services.SingleOrDefault(
                    d => d.ServiceType == typeof(DbContextOptions<ApplicationDbContext>));
                if (descriptor != null)
                    services.Remove(descriptor);

                // Add InMemory database for testing
                services.AddDbContext<ApplicationDbContext>(options =>
                {
                    options.UseInMemoryDatabase($"TestDb_{Guid.NewGuid()}");\n                    options.EnableSensitiveDataLogging();\n                });\n\n                // Ensure the database is created\n                var serviceProvider = services.BuildServiceProvider();\n                using var scope = serviceProvider.CreateScope();\n                var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();\n                context.Database.EnsureCreated();\n            });\n        });\n\n        _client = _factory.CreateClient();\n        _scope = _factory.Services.CreateScope();\n        _context = _scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();\n    }\n\n    [Fact]\n    public async Task Register_ValidUser_ReturnsSuccess()\n    {\n        // Arrange\n        var registerDto = new RegisterDto\n        {\n            Email = \"testuser@example.com\",\n            Password = \"TestPassword123!\",\n            FirstName = \"Test\",\n            LastName = \"User\",\n            IsInstructor = false\n        };\n\n        // Act\n        var response = await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.OK);\n        \n        var content = await response.Content.ReadAsStringAsync();\n        var result = JsonSerializer.Deserialize<AuthResultDto>(content, new JsonSerializerOptions\n        {\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\n        });\n\n        result.Should().NotBeNull();\n        result.IsSuccess.Should().BeTrue();\n        result.Token.Should().NotBeNullOrEmpty();\n        result.User.Should().NotBeNull();\n        result.User.Email.Should().Be(registerDto.Email);\n        result.User.FirstName.Should().Be(registerDto.FirstName);\n        result.User.LastName.Should().Be(registerDto.LastName);\n    }\n\n    [Fact]\n    public async Task Register_DuplicateEmail_ReturnsConflict()\n    {\n        // Arrange\n        var registerDto = new RegisterDto\n        {\n            Email = \"duplicate@example.com\",\n            Password = \"TestPassword123!\",\n            FirstName = \"Test\",\n            LastName = \"User\"\n        };\n\n        // First registration\n        await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n\n        // Act - Second registration with same email\n        var response = await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.Conflict);\n        \n        var content = await response.Content.ReadAsStringAsync();\n        content.Should().Contain(\"already exists\");\n    }\n\n    [Theory]\n    [InlineData(\"\", \"Password123!\", \"First\", \"Last\")]  // Empty email\n    [InlineData(\"invalid-email\", \"Password123!\", \"First\", \"Last\")]  // Invalid email format\n    [InlineData(\"test@example.com\", \"\", \"First\", \"Last\")]  // Empty password\n    [InlineData(\"test@example.com\", \"weak\", \"First\", \"Last\")]  // Weak password\n    [InlineData(\"test@example.com\", \"Password123!\", \"\", \"Last\")]  // Empty first name\n    [InlineData(\"test@example.com\", \"Password123!\", \"First\", \"\")]  // Empty last name\n    public async Task Register_InvalidData_ReturnsBadRequest(string email, string password, string firstName, string lastName)\n    {\n        // Arrange\n        var registerDto = new RegisterDto\n        {\n            Email = email,\n            Password = password,\n            FirstName = firstName,\n            LastName = lastName\n        };\n\n        // Act\n        var response = await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);\n    }\n\n    [Fact]\n    public async Task Register_InstructorUser_AssignsCorrectRole()\n    {\n        // Arrange\n        var registerDto = new RegisterDto\n        {\n            Email = \"instructor@example.com\",\n            Password = \"TestPassword123!\",\n            FirstName = \"Instructor\",\n            LastName = \"User\",\n            IsInstructor = true\n        };\n\n        // Act\n        var response = await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.OK);\n        \n        var content = await response.Content.ReadAsStringAsync();\n        var result = JsonSerializer.Deserialize<AuthResultDto>(content, new JsonSerializerOptions\n        {\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\n        });\n\n        result.Should().NotBeNull();\n        result.IsSuccess.Should().BeTrue();\n        result.User.Roles.Should().Contain(\"Instructor\");\n    }\n\n    [Fact]\n    public async Task Login_ValidCredentials_ReturnsToken()\n    {\n        // Arrange - First register a user\n        var registerDto = new RegisterDto\n        {\n            Email = \"logintest@example.com\",\n            Password = \"TestPassword123!\",\n            FirstName = \"Login\",\n            LastName = \"Test\"\n        };\n        await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n\n        var loginDto = new LoginDto\n        {\n            Email = registerDto.Email,\n            Password = registerDto.Password\n        };\n\n        // Act\n        var response = await _client.PostAsJsonAsync(\"/api/auth/login\", loginDto);\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.OK);\n        \n        var content = await response.Content.ReadAsStringAsync();\n        var result = JsonSerializer.Deserialize<AuthResultDto>(content, new JsonSerializerOptions\n        {\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\n        });\n\n        result.Should().NotBeNull();\n        result.IsSuccess.Should().BeTrue();\n        result.Token.Should().NotBeNullOrEmpty();\n        result.User.Should().NotBeNull();\n        result.User.Email.Should().Be(loginDto.Email);\n    }\n\n    [Fact]\n    public async Task Login_InvalidCredentials_ReturnsUnauthorized()\n    {\n        // Arrange\n        var loginDto = new LoginDto\n        {\n            Email = \"nonexistent@example.com\",\n            Password = \"WrongPassword123!\"\n        };\n\n        // Act\n        var response = await _client.PostAsJsonAsync(\"/api/auth/login\", loginDto);\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.Unauthorized);\n    }\n\n    [Fact]\n    public async Task GetCurrentUser_WithValidToken_ReturnsUserInfo()\n    {\n        // Arrange - Register and login to get token\n        var registerDto = new RegisterDto\n        {\n            Email = \"tokentest@example.com\",\n            Password = \"TestPassword123!\",\n            FirstName = \"Token\",\n            LastName = \"Test\"\n        };\n        var registerResponse = await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n        var registerContent = await registerResponse.Content.ReadAsStringAsync();\n        var registerResult = JsonSerializer.Deserialize<AuthResultDto>(registerContent, new JsonSerializerOptions\n        {\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\n        });\n\n        // Set authorization header\n        _client.DefaultRequestHeaders.Authorization = \n            new System.Net.Http.Headers.AuthenticationHeaderValue(\"Bearer\", registerResult.Token);\n\n        // Act\n        var response = await _client.GetAsync(\"/api/auth/me\");\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.OK);\n        \n        var content = await response.Content.ReadAsStringAsync();\n        var user = JsonSerializer.Deserialize<UserDto>(content, new JsonSerializerOptions\n        {\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\n        });\n\n        user.Should().NotBeNull();\n        user.Email.Should().Be(registerDto.Email);\n        user.FirstName.Should().Be(registerDto.FirstName);\n        user.LastName.Should().Be(registerDto.LastName);\n    }\n\n    [Fact]\n    public async Task GetCurrentUser_WithoutToken_ReturnsUnauthorized()\n    {\n        // Act\n        var response = await _client.GetAsync(\"/api/auth/me\");\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.Unauthorized);\n    }\n\n    [Fact]\n    public async Task ValidateToken_WithValidToken_ReturnsOk()\n    {\n        // Arrange - Register to get a valid token\n        var registerDto = new RegisterDto\n        {\n            Email = \"validatetest@example.com\",\n            Password = \"TestPassword123!\",\n            FirstName = \"Validate\",\n            LastName = \"Test\"\n        };\n        var registerResponse = await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n        var registerContent = await registerResponse.Content.ReadAsStringAsync();\n        var registerResult = JsonSerializer.Deserialize<AuthResultDto>(registerContent, new JsonSerializerOptions\n        {\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\n        });\n\n        _client.DefaultRequestHeaders.Authorization = \n            new System.Net.Http.Headers.AuthenticationHeaderValue(\"Bearer\", registerResult.Token);\n\n        // Act\n        var response = await _client.GetAsync(\"/api/auth/validate\");\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.OK);\n    }\n\n    [Fact]\n    public async Task RefreshToken_WithValidToken_ReturnsNewToken()\n    {\n        // Arrange - Register to get a valid token\n        var registerDto = new RegisterDto\n        {\n            Email = \"refreshtest@example.com\",\n            Password = \"TestPassword123!\",\n            FirstName = \"Refresh\",\n            LastName = \"Test\"\n        };\n        var registerResponse = await _client.PostAsJsonAsync(\"/api/auth/register\", registerDto);\n        var registerContent = await registerResponse.Content.ReadAsStringAsync();\n        var registerResult = JsonSerializer.Deserialize<AuthResultDto>(registerContent, new JsonSerializerOptions\n        {\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\n        });\n\n        _client.DefaultRequestHeaders.Authorization = \n            new System.Net.Http.Headers.AuthenticationHeaderValue(\"Bearer\", registerResult.Token);\n\n        var refreshRequest = new { Token = registerResult.Token };\n\n        // Act\n        var response = await _client.PostAsJsonAsync(\"/api/auth/refresh\", refreshRequest);\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.OK);\n        \n        var content = await response.Content.ReadAsStringAsync();\n        var result = JsonSerializer.Deserialize<AuthResultDto>(content, new JsonSerializerOptions\n        {\n            PropertyNamingPolicy = JsonNamingPolicy.CamelCase\n        });\n\n        result.Should().NotBeNull();\n        result.IsSuccess.Should().BeTrue();\n        result.Token.Should().NotBeNullOrEmpty();\n        result.Token.Should().NotBe(registerResult.Token); // Should be a new token\n    }\n\n    [Fact]\n    public async Task GoogleOAuthHealth_ReturnsConfigurationStatus()\n    {\n        // Act\n        var response = await _client.GetAsync(\"/api/auth/google/health\");\n\n        // Assert\n        response.StatusCode.Should().Be(HttpStatusCode.OK);\n        \n        var content = await response.Content.ReadAsStringAsync();\n        content.Should().Contain(\"isConfigured\");\n        content.Should().Contain(\"hasClientId\");\n        content.Should().Contain(\"hasClientSecret\");\n    }\n\n    public void Dispose()\n    {\n        _scope?.Dispose();\n        _client?.Dispose();\n    }\n}"