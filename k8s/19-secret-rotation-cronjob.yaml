---
apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-rotation-script
  namespace: insightlearn
  labels:
    app: secret-rotation
data:
  rotate-secrets.sh: |
    #!/bin/bash
    set -euo pipefail

    RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; NC='\033[0m'
    NAMESPACE="insightlearn"; SECRET_NAME="insightlearn-secrets"; BACKUP_FILE="/tmp/rollback-secrets.yaml"

    log() { echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $*"; }
    error() { echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERRORE:${NC} $*" >&2; }
    warn() { echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] ATTENZIONE:${NC} $*"; }

    rollback() {
        error "=========================================="
        error "ROTAZIONE FALLITA - ROLLBACK AUTOMATICO"
        error "=========================================="
        if [[ -f "$BACKUP_FILE" ]]; then
            warn "Ripristino password precedenti..."
            kubectl apply -f "$BACKUP_FILE" -n "$NAMESPACE"
            warn "Riavvio pods..."
            kubectl delete pod sqlserver-0 mongodb-0 -n "$NAMESPACE" --grace-period=30 2>/dev/null || true
            kubectl rollout restart deployment/redis deployment/insightlearn-api -n "$NAMESPACE" 2>/dev/null || true
            sleep 30
            kubectl wait --for=condition=Ready pod/sqlserver-0 pod/mongodb-0 -n "$NAMESPACE" --timeout=120s || true
            error "ROLLBACK COMPLETATO - Password tornate a quelle precedenti"
            error "NESSUN DATO PERSO - Sistema stabile"
            error "NON È STATO POSSIBILE EFFETTUARE IL CAMBIO PASSWORD"

            # Esporta metriche fallimento a Prometheus
            /scripts/export-rotation-metrics.sh failure 2>/dev/null || echo "Metrics export skipped"
        fi
        exit 1
    }

    trap rollback ERR

    log "=========================================="; log "Task Automatico Rotazione Password"; log "=========================================="

    log "Step 1/9: Backup secrets..."; kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" -o yaml > "$BACKUP_FILE"; log "✓ Backup completato"

    log "Step 2/9: Generazione password..."; NEW_MSSQL_PASSWORD=$(openssl rand -base64 32 | tr -d '/+=' | cut -c1-32); NEW_JWT_SECRET=$(openssl rand -base64 64 | tr -d '\n'); NEW_MONGODB_PASSWORD=$(openssl rand -base64 32 | tr -d '/+=' | cut -c1-32); NEW_REDIS_PASSWORD=$(openssl rand -base64 32 | tr -d '/+=' | cut -c1-32); NEW_ADMIN_PASSWORD=$(openssl rand -base64 16 | tr -d '\n'); log "✓ Password generate"

    log "Step 3/9: SQL Server..."; CURRENT_MSSQL=$(kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.mssql-sa-password}' | base64 -d); kubectl exec -n "$NAMESPACE" sqlserver-0 -- /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$CURRENT_MSSQL" -C -Q "ALTER LOGIN sa WITH PASSWORD = '$NEW_MSSQL_PASSWORD'"; sleep 2; kubectl exec -n "$NAMESPACE" sqlserver-0 -- /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$NEW_MSSQL_PASSWORD" -C -Q "SELECT 1" >/dev/null; log "✓ SQL Server OK"

    log "Step 4/9: MongoDB..."; CURRENT_MONGO=$(kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.mongodb-password}' | base64 -d); kubectl exec -n "$NAMESPACE" mongodb-0 -- mongosh -u insightlearn -p "$CURRENT_MONGO" --authenticationDatabase admin --eval "db.getSiblingDB('admin').changeUserPassword('insightlearn', '$NEW_MONGODB_PASSWORD')"; sleep 2; kubectl exec -n "$NAMESPACE" mongodb-0 -- mongosh -u insightlearn -p "$NEW_MONGODB_PASSWORD" --authenticationDatabase admin --eval "db.version()" >/dev/null; log "✓ MongoDB OK"

    log "Step 5/9: Redis..."; REDIS_POD=$(kubectl get pod -n "$NAMESPACE" -l app=redis -o jsonpath='{.items[0].metadata.name}'); CURRENT_REDIS=$(kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.redis-password}' | base64 -d); kubectl exec -n "$NAMESPACE" "$REDIS_POD" -- redis-cli -a "$CURRENT_REDIS" CONFIG SET requirepass "$NEW_REDIS_PASSWORD"; sleep 2; kubectl exec -n "$NAMESPACE" "$REDIS_POD" -- redis-cli -a "$NEW_REDIS_PASSWORD" PING >/dev/null; log "✓ Redis OK"

    log "Step 6/9: Kubernetes secrets..."; MSSQL_B64=$(echo -n "$NEW_MSSQL_PASSWORD" | base64 -w 0); JWT_B64=$(echo -n "$NEW_JWT_SECRET" | base64 -w 0); MONGO_B64=$(echo -n "$NEW_MONGODB_PASSWORD" | base64 -w 0); REDIS_B64=$(echo -n "$NEW_REDIS_PASSWORD" | base64 -w 0); ADMIN_B64=$(echo -n "$NEW_ADMIN_PASSWORD" | base64 -w 0); CONN_STRING="Server=sqlserver-service,1433;Database=InsightLearnDb;User Id=sa;Password=${NEW_MSSQL_PASSWORD};TrustServerCertificate=True;MultipleActiveResultSets=true"; CONN_B64=$(echo -n "$CONN_STRING" | base64 -w 0); kubectl patch secret "$SECRET_NAME" -n "$NAMESPACE" --type=json -p="[{\"op\":\"replace\",\"path\":\"/data/mssql-sa-password\",\"value\":\"$MSSQL_B64\"},{\"op\":\"replace\",\"path\":\"/data/jwt-secret-key\",\"value\":\"$JWT_B64\"},{\"op\":\"replace\",\"path\":\"/data/mongodb-password\",\"value\":\"$MONGO_B64\"},{\"op\":\"replace\",\"path\":\"/data/redis-password\",\"value\":\"$REDIS_B64\"},{\"op\":\"replace\",\"path\":\"/data/admin-password\",\"value\":\"$ADMIN_B64\"},{\"op\":\"replace\",\"path\":\"/data/connection-string\",\"value\":\"$CONN_B64\"}]"; log "✓ Secrets aggiornati"

    log "Step 7/9: Riavvio pods..."; kubectl delete pod sqlserver-0 -n "$NAMESPACE" --grace-period=30; sleep 10; kubectl wait --for=condition=Ready pod/sqlserver-0 -n "$NAMESPACE" --timeout=120s; kubectl delete pod mongodb-0 -n "$NAMESPACE" --grace-period=30; sleep 10; kubectl wait --for=condition=Ready pod/mongodb-0 -n "$NAMESPACE" --timeout=120s; kubectl rollout restart deployment/redis -n "$NAMESPACE"; kubectl rollout status deployment/redis -n "$NAMESPACE" --timeout=120s; kubectl rollout restart deployment/insightlearn-api -n "$NAMESPACE"; kubectl rollout status deployment/insightlearn-api -n "$NAMESPACE" --timeout=120s; log "✓ Pods riavviati"

    log "Step 8/9: Verifica ZERO perdita dati..."; sleep 10; kubectl exec -n "$NAMESPACE" sqlserver-0 -- /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$NEW_MSSQL_PASSWORD" -C -Q "SELECT @@VERSION" >/dev/null; kubectl exec -n "$NAMESPACE" mongodb-0 -- mongosh -u insightlearn -p "$NEW_MONGODB_PASSWORD" --authenticationDatabase admin --eval "db.version()" >/dev/null; REDIS_POD=$(kubectl get pod -n "$NAMESPACE" -l app=redis -o jsonpath='{.items[0].metadata.name}'); kubectl exec -n "$NAMESPACE" "$REDIS_POD" -- redis-cli -a "$NEW_REDIS_PASSWORD" PING >/dev/null; API_POD=$(kubectl get pod -n "$NAMESPACE" -l app=insightlearn-api -o jsonpath='{.items[0].metadata.name}'); sleep 5; kubectl exec -n "$NAMESPACE" "$API_POD" -- wget -q -O- http://localhost:7001/health 2>/dev/null | grep -q "Healthy"; log "✓ ZERO PERDITA DATI - Tutti i servizi operativi"

    log "Step 9/9: Report..."; echo "ROTAZIONE COMPLETATA CON SUCCESSO - $(date)" > /tmp/rotation-report.txt; echo "SQL Server, MongoDB, Redis, API: VERIFICATI - ZERO PERDITA DATI" >> /tmp/rotation-report.txt; cat /tmp/rotation-report.txt

    log "=========================================="
    log "ROTAZIONE COMPLETATA CON SUCCESSO"
    log "ZERO PERDITA DATI - Sistema stabile"
    log "=========================================="

    # Esporta metriche successo a Prometheus
    /scripts/export-rotation-metrics.sh success 2>/dev/null || echo "Metrics export skipped"

    trap - ERR

  export-rotation-metrics.sh: |
    #!/bin/bash
    set -euo pipefail
    NAMESPACE="${NAMESPACE:-insightlearn}"
    METRICS_FILE="${METRICS_FILE:-/tmp/rotation_metrics.prom}"
    STATE_FILE="/tmp/rotation-state.json"
    current_timestamp() { date +%s; }
    get_next_rotation() { echo $(($1 + 172800)); }
    get_password_hash() { kubectl get secret insightlearn-secrets -n "$NAMESPACE" -o jsonpath="{.data.$1}" 2>/dev/null | base64 -d | sha256sum | cut -d' ' -f1 || echo "unknown"; }

    # Leggi o inizializza stato
    if [[ -f "$STATE_FILE" ]]; then
        LAST_SUCCESS=$(grep -oP '"last_success":\s*\K\d+' "$STATE_FILE" || echo 0)
        LAST_ATTEMPT=$(grep -oP '"last_attempt":\s*\K\d+' "$STATE_FILE" || echo 0)
        STATUS=$(grep -oP '"status":\s*\K-?\d+' "$STATE_FILE" || echo -1)
        TOTAL=$(grep -oP '"total_count":\s*\K\d+' "$STATE_FILE" || echo 0)
        FAILURES=$(grep -oP '"failure_count":\s*\K\d+' "$STATE_FILE" || echo 0)
    else
        LAST_SUCCESS=0; LAST_ATTEMPT=0; STATUS=-1; TOTAL=0; FAILURES=0
    fi

    # Aggiorna stato
    if [[ "$1" == "success" ]]; then
        LAST_SUCCESS=$(current_timestamp); LAST_ATTEMPT=$LAST_SUCCESS; STATUS=1; TOTAL=$((TOTAL+1))
    elif [[ "$1" == "failure" ]]; then
        LAST_ATTEMPT=$(current_timestamp); STATUS=0; TOTAL=$((TOTAL+1)); FAILURES=$((FAILURES+1))
    fi

    echo "{\"last_success\":$LAST_SUCCESS,\"last_attempt\":$LAST_ATTEMPT,\"status\":$STATUS,\"total_count\":$TOTAL,\"failure_count\":$FAILURES}" > "$STATE_FILE"

    # Calcola metriche
    NOW=$(current_timestamp); NEXT=$(get_next_rotation $LAST_SUCCESS); COUNTDOWN=$((NEXT-NOW)); [[ $COUNTDOWN -lt 0 ]] && COUNTDOWN=0
    MSSQL_HASH=$(get_password_hash "mssql-sa-password"); JWT_HASH=$(get_password_hash "jwt-secret-key"); MONGO_HASH=$(get_password_hash "mongodb-password"); REDIS_HASH=$(get_password_hash "redis-password"); ADMIN_HASH=$(get_password_hash "admin-password")

    # Esporta metriche Prometheus
    cat > "$METRICS_FILE" <<EOF
    insightlearn_password_rotation_last_success_timestamp $LAST_SUCCESS
    insightlearn_password_rotation_last_attempt_timestamp $LAST_ATTEMPT
    insightlearn_password_rotation_status $STATUS
    insightlearn_password_rotation_next_scheduled_timestamp $NEXT
    insightlearn_password_rotation_countdown_seconds $COUNTDOWN
    insightlearn_password_rotation_total_count $TOTAL
    insightlearn_password_rotation_failure_count $FAILURES
    insightlearn_password_hash_info{secret="mssql",hash="$MSSQL_HASH"} 1
    insightlearn_password_hash_info{secret="jwt",hash="$JWT_HASH"} 1
    insightlearn_password_hash_info{secret="mongodb",hash="$MONGO_HASH"} 1
    insightlearn_password_hash_info{secret="redis",hash="$REDIS_HASH"} 1
    insightlearn_password_hash_info{secret="admin",hash="$ADMIN_HASH"} 1
    EOF
    echo "✓ Metriche esportate: $(date -d @$NEXT 2>/dev/null), countdown: ${COUNTDOWN}s"

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation
  namespace: insightlearn
  labels:
    app: secret-rotation
spec:
  schedule: "0 2 */2 * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 3600
  jobTemplate:
    spec:
      activeDeadlineSeconds: 1800
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          serviceAccountName: secret-rotator
          restartPolicy: Never
          containers:
          - name: rotate-secrets
            image: bitnami/kubectl:latest
            command: ["/bin/bash", "/scripts/rotate-secrets.sh"]
            volumeMounts:
            - name: script
              mountPath: /scripts
            resources:
              requests: {memory: "128Mi", cpu: "100m"}
              limits: {memory: "256Mi", cpu: "500m"}
          volumes:
          - name: script
            configMap:
              name: secret-rotation-script
              defaultMode: 493
              items:
              - key: rotate-secrets.sh
                path: rotate-secrets.sh
              - key: export-rotation-metrics.sh
                path: export-rotation-metrics.sh
