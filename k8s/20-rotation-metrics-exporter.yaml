---
# PersistentVolumeClaim per storage metriche rotation
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: rotation-metrics-storage
  namespace: insightlearn
  labels:
    app: rotation-metrics
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Mi
  storageClassName: local-path

---
# Deployment node-exporter per esporre metriche textfile
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rotation-metrics-exporter
  namespace: insightlearn
  labels:
    app: rotation-metrics
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rotation-metrics
  template:
    metadata:
      labels:
        app: rotation-metrics
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: node-exporter
        image: prom/node-exporter:latest
        args:
          - '--path.rootfs=/host'
          - '--collector.textfile.directory=/var/lib/node_exporter/textfile_collector'
          - '--collector.filesystem.mount-points-exclude=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)'
          - '--collector.netclass.ignored-devices=^(veth.*|docker.*|br-.*|cali.*|tunl.*|vxlan.*|lo)$'
        ports:
        - name: metrics
          containerPort: 9100
          protocol: TCP
        volumeMounts:
        - name: metrics-storage
          mountPath: /var/lib/node_exporter/textfile_collector
        - name: rootfs
          mountPath: /host
          readOnly: true
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /metrics
            port: 9100
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /metrics
            port: 9100
          initialDelaySeconds: 5
          periodSeconds: 10

      - name: metrics-updater
        image: bitnami/kubectl:latest
        command:
          - /bin/bash
          - -c
          - |
            while true; do
              # Aggiorna metriche ogni 60 secondi
              /scripts/export-rotation-metrics.sh || echo "Failed to update metrics"
              sleep 60
            done
        volumeMounts:
        - name: metrics-storage
          mountPath: /var/lib/node_exporter/textfile_collector
        - name: metrics-script
          mountPath: /scripts
        env:
        - name: NAMESPACE
          value: "insightlearn"
        - name: METRICS_FILE
          value: "/var/lib/node_exporter/textfile_collector/rotation_metrics.prom"
        resources:
          requests:
            memory: "32Mi"
            cpu: "10m"
          limits:
            memory: "64Mi"
            cpu: "100m"

      volumes:
      - name: metrics-storage
        persistentVolumeClaim:
          claimName: rotation-metrics-storage
      - name: rootfs
        hostPath:
          path: /
      - name: metrics-script
        configMap:
          name: rotation-metrics-script
          defaultMode: 0755

      serviceAccountName: secret-rotator

---
# Service per esporre metriche a Prometheus
apiVersion: v1
kind: Service
metadata:
  name: rotation-metrics-exporter
  namespace: insightlearn
  labels:
    app: rotation-metrics
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9100"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
  - name: metrics
    port: 9100
    targetPort: 9100
    protocol: TCP
  selector:
    app: rotation-metrics

---
# ConfigMap con script export metriche
apiVersion: v1
kind: ConfigMap
metadata:
  name: rotation-metrics-script
  namespace: insightlearn
  labels:
    app: rotation-metrics
data:
  export-rotation-metrics.sh: |
    #!/bin/bash
    set -euo pipefail

    NAMESPACE="${NAMESPACE:-insightlearn}"
    METRICS_FILE="${METRICS_FILE:-/var/lib/node_exporter/textfile_collector/rotation_metrics.prom}"
    STATE_FILE="/tmp/rotation-state.json"

    current_timestamp() { date +%s; }

    get_next_rotation_timestamp() {
        local last_rotation=${1:-$(current_timestamp)}
        echo $((last_rotation + 172800))  # +2 days
    }

    get_password_age() {
        local secret_name=$1
        local last_rotation_time=${2:-$(current_timestamp)}
        local secret_modified=$(kubectl get secret insightlearn-secrets -n "$NAMESPACE" \
            -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null || echo "")
        if [[ -n "$secret_modified" ]]; then
            local secret_timestamp=$(date -d "$secret_modified" +%s 2>/dev/null || echo "$last_rotation_time")
            echo $(($(current_timestamp) - secret_timestamp))
        else
            echo 0
        fi
    }

    get_password_hash() {
        local secret_key=$1
        kubectl get secret insightlearn-secrets -n "$NAMESPACE" \
            -o jsonpath="{.data.$secret_key}" 2>/dev/null | base64 -d | sha256sum | cut -d' ' -f1 || echo "unknown"
    }

    # Leggi stato
    if [[ -f "$STATE_FILE" ]]; then
        LAST_SUCCESS=$(cat "$STATE_FILE" | grep -oP '"last_success":\s*\K\d+' || echo 0)
        LAST_ATTEMPT=$(cat "$STATE_FILE" | grep -oP '"last_attempt":\s*\K\d+' || echo 0)
        ROTATION_STATUS=$(cat "$STATE_FILE" | grep -oP '"status":\s*\K-?\d+' || echo -1)
        TOTAL_COUNT=$(cat "$STATE_FILE" | grep -oP '"total_count":\s*\K\d+' || echo 0)
        FAILURE_COUNT=$(cat "$STATE_FILE" | grep -oP '"failure_count":\s*\K\d+' || echo 0)
    else
        LAST_SUCCESS=0
        LAST_ATTEMPT=0
        ROTATION_STATUS=-1
        TOTAL_COUNT=0
        FAILURE_COUNT=0
    fi

    # Aggiorna stato se argomento fornito
    if [[ $# -gt 0 ]]; then
        case "$1" in
            success)
                LAST_SUCCESS=$(current_timestamp)
                LAST_ATTEMPT=$(current_timestamp)
                ROTATION_STATUS=1
                TOTAL_COUNT=$((TOTAL_COUNT + 1))
                ;;
            failure)
                LAST_ATTEMPT=$(current_timestamp)
                ROTATION_STATUS=0
                TOTAL_COUNT=$((TOTAL_COUNT + 1))
                FAILURE_COUNT=$((FAILURE_COUNT + 1))
                ;;
            running)
                LAST_ATTEMPT=$(current_timestamp)
                ROTATION_STATUS=-1
                ;;
        esac
        cat > "$STATE_FILE" <<EOF
    {"last_success":$LAST_SUCCESS,"last_attempt":$LAST_ATTEMPT,"status":$ROTATION_STATUS,"total_count":$TOTAL_COUNT,"failure_count":$FAILURE_COUNT}
    EOF
    fi

    # Calcola metriche
    CURRENT_TIME=$(current_timestamp)
    NEXT_ROTATION=$(get_next_rotation_timestamp "$LAST_SUCCESS")
    COUNTDOWN=$((NEXT_ROTATION - CURRENT_TIME))
    [[ $COUNTDOWN -lt 0 ]] && COUNTDOWN=0

    MSSQL_AGE=$(get_password_age "mssql-sa-password" "$LAST_SUCCESS")
    JWT_AGE=$(get_password_age "jwt-secret-key" "$LAST_SUCCESS")
    MONGODB_AGE=$(get_password_age "mongodb-password" "$LAST_SUCCESS")
    REDIS_AGE=$(get_password_age "redis-password" "$LAST_SUCCESS")
    ADMIN_AGE=$(get_password_age "admin-password" "$LAST_SUCCESS")

    MSSQL_HASH=$(get_password_hash "mssql-sa-password")
    JWT_HASH=$(get_password_hash "jwt-secret-key")
    MONGODB_HASH=$(get_password_hash "mongodb-password")
    REDIS_HASH=$(get_password_hash "redis-password")
    ADMIN_HASH=$(get_password_hash "admin-password")

    # Genera metriche
    cat > "$METRICS_FILE" <<EOF
    # HELP insightlearn_password_rotation_last_success_timestamp Unix timestamp of last successful rotation
    # TYPE insightlearn_password_rotation_last_success_timestamp gauge
    insightlearn_password_rotation_last_success_timestamp $LAST_SUCCESS
    # HELP insightlearn_password_rotation_last_attempt_timestamp Unix timestamp of last rotation attempt
    # TYPE insightlearn_password_rotation_last_attempt_timestamp gauge
    insightlearn_password_rotation_last_attempt_timestamp $LAST_ATTEMPT
    # HELP insightlearn_password_rotation_status Current rotation status (1=success, 0=failed, -1=never_run)
    # TYPE insightlearn_password_rotation_status gauge
    insightlearn_password_rotation_status $ROTATION_STATUS
    # HELP insightlearn_password_rotation_next_scheduled_timestamp Unix timestamp of next scheduled rotation
    # TYPE insightlearn_password_rotation_next_scheduled_timestamp gauge
    insightlearn_password_rotation_next_scheduled_timestamp $NEXT_ROTATION
    # HELP insightlearn_password_rotation_countdown_seconds Seconds until next scheduled rotation
    # TYPE insightlearn_password_rotation_countdown_seconds gauge
    insightlearn_password_rotation_countdown_seconds $COUNTDOWN
    # HELP insightlearn_password_age_seconds Age of password in seconds since last rotation
    # TYPE insightlearn_password_age_seconds gauge
    insightlearn_password_age_seconds{secret="mssql"} $MSSQL_AGE
    insightlearn_password_age_seconds{secret="jwt"} $JWT_AGE
    insightlearn_password_age_seconds{secret="mongodb"} $MONGODB_AGE
    insightlearn_password_age_seconds{secret="redis"} $REDIS_AGE
    insightlearn_password_age_seconds{secret="admin"} $ADMIN_AGE
    # HELP insightlearn_password_rotation_total_count Total number of rotation attempts
    # TYPE insightlearn_password_rotation_total_count counter
    insightlearn_password_rotation_total_count $TOTAL_COUNT
    # HELP insightlearn_password_rotation_failure_count Total number of failed rotations
    # TYPE insightlearn_password_rotation_failure_count counter
    insightlearn_password_rotation_failure_count $FAILURE_COUNT
    # HELP insightlearn_password_hash_info Hash SHA256 of current passwords (for tracking only)
    # TYPE insightlearn_password_hash_info gauge
    insightlearn_password_hash_info{secret="mssql",hash="$MSSQL_HASH"} 1
    insightlearn_password_hash_info{secret="jwt",hash="$JWT_HASH"} 1
    insightlearn_password_hash_info{secret="mongodb",hash="$MONGODB_HASH"} 1
    insightlearn_password_hash_info{secret="redis",hash="$REDIS_HASH"} 1
    insightlearn_password_hash_info{secret="admin",hash="$ADMIN_HASH"} 1
    EOF
